(* :Title: CZMExportUserSelections *)

(* :Context: CZMPostProcessing` *)

(* :Author: Rudolf  T. Hoogenveen, Roel G.M. Breuls *)

(* :Summary:
   CZM package with functions to import the user selections of input*)

(* :Copyright: © 2004 by Rudolf Hoogenveen/Roel Breuls *)

(* :Package Version: 3.1 *)

(* :Mathematica Version: 5.1 *)

(* :History: 	1.0 first update new implementation CZM July 2004
		2.0 first release CZM 2005, version March, update menus
		3.0 version November 2005 
		3.1 version March 2007 *)

(* :Keywords: user selections, import *)

BeginPackage["CZMPostProcessing`CZMExportUserSelections`",
	{"CZMInitialization`CZMLogFile`",
	"CZMInitialization`CZMDefaultFileNames`",
	"CZMInitialization`CZMConstants`",
	"CZMInitialization`CZMFunctions`",
	"CZMImportData`CZMImportUserSelections`"}]


outputnames::usage		= "names of output variables"
outputsel::usage		= "output variables selected"
noutput::usage			= "number of output variables available"

rates::usage			= "absolute numbers (0) or rates (1)"
standardized::usage		= "standardized no (0) or yes (1)"
agespecres::usage		= "presentation of model results specified by age class (>1) or not (<=1)"
withindisease::usage		= "presentation of model results within disease groups"

cumulative::usage		= "yearly (0) or cumulative (1) figures"
discountc::usage		= "cost discounting factor applied to cumulative figures"
discounte::usage		= "effect discounting factor applied to cumulative figures"
disweighting::usage		= "weighting of disease states applied to cumulative figures"
otherdis::usage			= "inclusion of other diseases applied to cumulative figures"
heterogeneity::usage		= "assumption  of homogeneous (0) or heterogeneous (1) population in DALY calculations"

outputscreen::usage		= "presentation of model output on screen (1) or not (0)"
outputnotebook::usage		= "presentation of model output in notebook (1) or not (0)"
outputfile::usage		= "presentation of tabular output in ASCII file (1) or not (0)"
tabeloutput::usage		= "presentation of tabular output (1) or not (0)"
graphicoutput::usage		= "presentation of graphical output (1) or not (0)"


Begin["`Private`"]	


Print["CZMExportUserSelections package is evaluated"]


(* -----------------------------------------------
           OUTPUT VARIABLES
   -----------------------------------------------*)

input = ReadList[Global`inputpath <> useroutput, Word, WordSeparators -> {"/t", "="}];

(* s0 to s3 denote the position of the KEYWORDS in the userinput file *)

s0	= Flatten[Position[input, "OUTPUT VARIABLES SELECTED"]][[1]];
s1	= Flatten[Position[input, "OUTPUT SPECIFICATION"]][[1]];
s2	= Flatten[Position[input, "COMBINING LIFE YEARS"]][[1]];
s3	= Flatten[Position[input, "OUTPUT DEVICE SPECIFICATION"]][[1]];
s4 	= Flatten[Position[input, "END"]][[1]];

outputnames 	= Take[input, {s0 + 1, s1 - 1, 2}]; 
outputsel	= ToExpression[Take[input, {s0 + 2, s1 - 1, 2}]];

constants 	= ToExpression[Take[input, {s1 + 2, s2 - 1, 2}]];

rates		= constants[[1]];
standardized 	= constants[[2]];
agespecres	= constants[[3]];
withindisease	= constants[[4]];
If[(patientsel > 0) && (Mod[patientsel, 10] == 0),
	Print["results presented within disease in case of population restricted to disease (thus: withindisease = 1)"];
	withindisease = 1];								(* DEFAULT SELECTION *)

outputnames	= Join[outputnames, {"\t"<> "joint class prevalence numbers"}];
outputsel	= Join[outputsel, {1}];
noutput		= Length[outputnames];

If[(Length[agesel] > 1),
	Print["only standardization in case of selecting one cohort (thus: standardized = 0)"];
	standardized = 0];								(* DEFAULT SELECTION *)
If[(standardized == 1),
	Print["presentation of absolute total numbers in case of standardization (thus: agespecres = rates = 0)"];
	agespecres = 0; rates = 0];							(* DEFAULT SELECTION *)

constants 	= ToExpression[Take[input, {s2 + 2, s3 - 1, 2}]];

cumulative 	= 0;
discountc 	= 0;
discounte 	= 0;
disweighting 	= constants[[1]];
otherdis	= 0;
heterogeneity	= 0;

If[(discountc > eps) || (discounte > eps), rates = 0;
	Print["no presentation of rates in case of discounting (thus: rates = 0)"];
	cumulative = 1];								(* DEFAULT SELECTION *)

constants 	= ToExpression[Take[input, {s3 + 2, s4 - 1, 2}]];

outputnotebook	= constants[[1]];
outputfile	= constants[[2]];
tabeloutput	= constants[[3]];
graphicoutput	= constants[[4]];
outputscreen	= 0;

If[(graphicoutput == 1),
	Print["presentation in notebook in case of graphical output (thus: outputnotebook = 1)"];
	outputnotebook 	= 1];								(* DEFAULT SELECTION *)
If[(outputfile == 1),
	Print["presentation in table format in case of ASCII file output (thus: tabeloutput = 1)"];
	tabeloutput 	= 1];								(* DEFAULT SELECTION *)
If[(nstap < 2),
	Print["no presentation for separate runs if nstap < 2 (thus: outputfile = 0, outputnotebook = 0)"];
	outputfile	= 0;
	outputnotebook	= 0];								(* DEFAULT SELECTION *)
	

(* --------------------------------------------------
		Write info to Logfile
----------------------------------------------------*)

(* PACKAGE VERSION *)

version = 3.1;

WriteString[logfile, 
		"\t" <> "Package: " <> StringReplace[Evaluate[Context[]], "`Private`"-> ", " ] 
		<> "version " <> ToString[version] <> "\n\n"];

WriteString[logfile,

		"Output Variables Selected\n\n",
		
		Table[outputnames[[Select[Range[noutput] outputsel, Positive]]][[t]] <> "\n", {t, Plus@@outputsel}],
		"\n",

	"Output Specification\n\n",
		"\t" <> "rates no (0) or yes (1): " <> ToString[rates] <> "\n",
		"\t" <> "standardized no (0) or yes (1): " <> ToString[standardized] <> "\n",
		"\t" <> "specification by age: " <> ToString[agespecres] <> "\n\n",
		
	"Life Expectancy Weighting\n\n",
		"\t" <> "cumulative no (0) or yes (1): " <> ToString[cumulative] <> "\n",
		"\t" <> "effect discounting factor: " <> ToString[discounte] <> "\n",
		"\t" <> "cost discounting factor: " <> ToString[discountc] <> "\n",
		"\t" <> "disease status weighting: " <> ToString[disweighting] <> "\n",
		"\t" <> "other diseases included: " <> ToString[otherdis] <> "\n",
		"\t" <> "heterogeneous population: " <> ToString[heterogeneity] <> "\n\n",

	"Output Device Specification\n\n",
		"\t" <> "output to screen: "	<> ToString[outputscreen] <> "\n",
		"\t" <> "output to notebook: " 	<> ToString[outputnotebook] <> "\n",
		"\t" <> "output to file: " 	<> ToString[outputfile] <> "\n",
		"\t" <> "output in table form: " <> ToString[tabeloutput] <> "\n",
		"\t" <> "output in graphical form: " <> ToString[graphicoutput] <> "\n\n"
		
]; 

End[]

Protect[Evaluate[Context[] <> "*"]]


EndPackage[]
(* :Title: CZMCalcResults *)

(* :Context: CZMPostProcessing` *)

(* :Author: Rudolf T. Hoogenveen, Roel G.M. Breuls, Maiwenn Al *)

(* :Summary:
   CZM postprocessing routine calculates model results *)

(* :Copyright: © 2004 by Rudolf Hoogenveen/Roel Breuls *)

(* :Package Version: 3.1 *)

(* :Mathematica Version: 5.1 *)

(* :History: 	1.0 first update new implementation CZM July 2004
		2.0 first release CZM 2005, version March
		3.0 version November 2005 
		3.1 version March 2007; storage of index values, new package CZMStoreResults *)

(* :Keywords: postprocessing, plots *)


BeginPackage["CZMPostProcessing`CZMCalcResults`",
	{"CZMInitialization`CZMLogFile`",
	"CZMInitialization`CZMConstants`",
	"CZMInitialization`CZMFunctions`", 
	"CZMImportData`CZMImportUserSelections`",
	"CZMImportData`CZMImportRiskFactors`",
	"CZMImportData`CZMImportDiseaseData`",
	"CZMImportData`CZMImportDALYs`",
	"CZMImportData`CZMImportCosts`",
	"CZMAdjustData`CZMMakeSelections`",
	"CZMAdjustData`CZMAdjustAfterSelection`",
	"CZMSimulation`CZMSimulationFunctions`",
	"CZMSimulation`CZMStoreResults`",
	"CZMPostProcessing`CZMExportUserSelections`",
	"Graphics`MultipleListPlot`"}]

mortnames::usage	= "list of disease names extended with other causes and all cause"
scenlist::usage		= "list of scenarios (from 1:nscen) for each user-defined scenario (1:nscen0)"

makeresdiff::usage	= "makeresdiff calculates result of scenarios (diff=0) or differences with baseline scenario (diff=1)"
makenpopagg::usage	= "makenpopagg aggregates model output population numbers unweighted (aggregating over list of scenarios)"
makenpopnonagg::usage	= "makenpopnonagg aggregates model output population numbers unweighted"
makenpop::usage		= "makenpop calculates model output population numbers weighted"
npopdiscount::usage	= "npopdiscount discounts calculated future population numbers"
makenrisk::usage	= "makenrisk aggregates model discrete risk factor class prevalence numbers"
makedist::usage		= "makedist aggregates model continuous risk factor distribution characteristics"
makendis::usage		= "makendis aggregates model disease prevalence numbers output"
makencosts::usage	= "makencosts calculates costs from calculated population and disease prevalence numbers"
ncostsdiscount::usage	= "ncostsdiscount discounts calculated future costs"

headingprint::usage	= "headingprint: prints text at level 0"
headingprint1::usage	= "headingprint1: prints text at level 1"
headingprint2::usage	= "headingprint2: prints text at level 2"
headingprint3::usage	= "headingprint3: prints text at level 3"
headingprintnb::usage	= "headingprintnb: prints text at level 0 in notebook"
headingprint1nb::usage	= "headingprint1nb: prints text at level 1 in notebook"
headingprint2nb::usage	= "headingprint2nb: prints text at level 2 in notebook"
headingprint3nb::usage	= "headingprint3nb: prints text at level 3 in notebook"

scenlist::usage		= "scenlist[scen]: list of random samples for each scenario"
scenname::usage		= "scenname: prints specification of scenario"
plotheading::usage	= "plotheading: prints 'simulation results'"
stdtextstyle::usage	= "standard text style"

nbout::usage		= "Notebook containing model results"

resjointmodelpopprev::usage = "resjointmodelpopprev[[scen,nstap,ng,nz1,na]]: results of joint deterministic population model"
resjointmodelageprev::usage = "resjointmodelageprev[[scen,nstap,ng,nz1,na]]: results of joint deterministic model stratified by age"
resjointmodelindprev::usage = "resjointmodelindprev[[scen,nstap,ng,nz1,na]]: results of joint deterministic model stratified by individuals"

makemultiplelistplot::usage = "makemultiplelistplot constructs multiplelistplots for variable number of lists"


Begin["`Private`"]


Print["CZMCalcResults package is evaluated"];
printtijd;

printbug[c_] := If[(bugind == 1), Print[{"CZMCalcResults", c}]];


(*-------------------------------------------------
	GENERAL PLOT ROUTINED
---------------------------------------------------*)

printbug["1."];

headingprint[text_] := Block[{},
				Print[];
				StylePrint[	text,
						FontFamily 	-> "Helvetica",
						FontSize 	-> 32,
						Background 	-> RGBColor[1, 1, 1],
						TextAlignment 	-> "Center",
			 			FontWeight 	-> "Bold"
					]
				];

headingprintnb[text_] := Cell[	text,
				"Title",
				FontFamily 	-> "Helvetica",
				FontSize 	-> 32,
				Background 	-> RGBColor[.6, .8, .8],
				TextAlignment 	-> "Center",
				FontWeight 	-> "Bold"
				];

headingprint1[text_] := Block[{},
				Print[];
				StylePrint[	text,
						FontFamily 	-> "Helvetica",
						FontSize 	-> 16, 
						Background 	-> RGBColor[0.6, 0.8, 0.8],
						FontWeight 	-> "Bold"
					]
				];

headingprint1nb[text_] := Cell[	text,
				"Subtitle",
				FontFamily 	-> "Helvetica",
				FontSize 	-> 16, 
				Background 	-> RGBColor[.6, .8, .8],
				FontWeight 	-> "Bold"
				];

headingprint2[text_] := Block[{},
				StylePrint[	"    "<> text,
						FontFamily 	-> "Helvetica", 
						FontSize 	-> 14,
						Background	-> None,
						FontWeight 	-> "Bold"
					]
				];

headingprint2nb[text_] := Cell[	text,
				"Section",
				FontFamily 	-> "Helvetica", 
				FontSize 	-> 14,
				Background	-> RGBColor[.6, .8, .8],
				FontWeight 	-> "Bold"
				];

headingprint3[text_] := Block[{},
				Print[];
				StylePrint[	"         "<> text,
						FontFamily 	-> "Helvetica", 
						FontSize 	-> 12,
						Background 	-> None,
						FontSlant 	-> "Italic"
					]
				];

headingprint3nb[text_] := Cell[	text,
				"Subsection",
				FontFamily 	-> "Helvetica", 
				FontSize 	-> 12,
				Background 	-> None,
				FontSlant 	-> "Italic"
				];

makemultiplelistplot[dat_, form_] :=

	Switch[Length[dat],

		1,	MultipleListPlot[dat[[1]], form],
		2,	MultipleListPlot[dat[[1]], dat[[2]], form],
		3,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], form],
		4,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], dat[[4]], form],
		5,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], dat[[4]], dat[[5]], form],
		6,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], dat[[4]], dat[[5]], dat[[6]], form],
		7,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], dat[[4]], dat[[5]], dat[[6]], dat[[7]], form],
		8,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], dat[[4]], dat[[5]], dat[[6]], dat[[7]], dat[[8]], form],
		9,	MultipleListPlot[dat[[1]], dat[[2]], dat[[3]], dat[[4]], dat[[5]], dat[[6]], dat[[7]], dat[[8]], dat[[9]], form]

		];
				

plotheading 	:= headingprint["simulation results"];

scenname[scen_, diffscen_] := "scenario " <> ToString[scen + diffscen] <> If[(diffscen == 1), " compared to baseline scenario"," "];
stdtextstyle 	= {FontFamily -> "Helvetica", FontSize -> 11};

mortnames	= Flatten[{disnames[[disind]], "other causes", "all cause"}];
scenlist	= Table[nscen0 (Range[ndrawinput] - 1) + scen, {scen, nscen0}];


(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS
----------------------------------------------------*)

printbug["2."];

makeresdiff[plusnres_, diffscen_] := (*Block[{},*)

	If[(diffscen == 0),

		(* FOR BASELINE SCENARIO *)

		plusnres,

		(* DIFFERENCES WITH BASELINE SCENARIO *)

		Drop[plusnres, 1] - Table[plusnres[[1]], {nscen0 - 1}]]

	(*];*)


(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: TOTAL POPULATION NUMBERS (FORMAT)
----------------------------------------------------*)

(* POPULATION NUMBERS & RATES: AGGREGATED OVER AGE OR SPECIFIED BY AGE CLASS DIRECTLY ON MODEL RESULTS *)

printbug["2.1"];
			
makenpopnonagg[npop_, diffscen_] := Block[{},

	plusnpop = If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			Table[Plus@@Flatten[npop[[scen, n, g]]], {scen, nscen0}, {g, ng}, {n, nstap}],

			(* SPECIFIED BY AGE CLASS *)

			Table[aggregc[npop[[scen, n, g]], 1, 7], {scen, nscen0}, {g, ng}, {n, nstap}]];

	makeresdiff[plusnpop, diffscen]
	
	]; (* END MAKENPOPNONAGG *)

(* POPULATION NUMBERS & RATES: AGGREGATED OVER AGE OR SPECIFIED BY AGE CLASS INCLUDING AGGREGATING OVER LIST OF SCENARIOS *)

printbug["2.2"];

makenpopagg[npop_, diffscen_] := Block[{},

	plusnpop = If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			Table[Plus@@Flatten[npop[[scenlist[[scen]], n, g]]], {scen, nscen0}, {g, ng}, {n, nstap}],

			(* SPECIFIED BY AGE CLASS *)

			Table[aggregc[Plus@@npop[[scenlist[[scen]], n, g]], 1, 7], {scen, nscen0}, {g, ng}, {n, nstap}]

			] / ndrawinput;

	makeresdiff[plusnpop, diffscen]
		
	]; (* END MAKENPOPAGG *)

(* # DELETE 120406 JACK
(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: WEIGHTED TOTAL POPULATION NUMBERS
----------------------------------------------------*)

printbug["3."];

makenpop[result_, diffscen_] := Block[{},

	(* TOTAL POPULATION NUMBERS *)

printbug["3.1"];

	npop1 	= Table[Plus@@result[[1, scenlist[[scen]]]], {scen, nscen0}] / ndrawinput;

printbug["3.2"];

	(* DISCRETE RISK FACTOR CLASS PREVALENCE RATES *)

printbug["3.3"];

	prisk	= Table[Plus@@result[[2, scenlist[[scen]], n, r, g, ri]] / (Plus@@Flatten[result[[2, scenlist[[scen]], n, r, g]]] + eps),
			{scen, nscen0}, {n, nstap}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}] / ndrawinput;

	(* CONTINUOUS RISK FACTOR DISTRIBUTION CHARACTERISTICS *)

printbug["3.4"];

	pcont	= Table[Plus@@result[[3, scenlist[[scen]], n, r, g, ri]] / (npop1[[scen, n, g]] + eps),
			{scen, nscen0}, {n, nstap}, {r, nrc}, {g, ng}, {ri, 2}] / ndrawinput;

	pcont	= Table[{vect1, pcont[[scen, n, r, g, 1]], pcont[[scen, n, r, g, 1]]^2 + pcont[[scen, n, r, g, 2]]},
			{scen, nscen0}, {n, nstap}, {r, nrc}, {g, ng}];

	(* DISEASE PREVALENCE RATES *)

printbug["3.5"];

	pdis	= Table[Plus@@result[[4, scenlist[[scen]], n, d, g]] / (Plus@@Flatten[result[[1, scenlist[[scen]], n, g]]] + eps),
			{scen, nscen0}, {n, nstap}, {d, nd}, {g, ng}];

printbug["3.6"];

	If[(disweighting > 0) && (heterogeneity == 1), 

		(* DISEASE PREVALENCE RATES IN JOINT RISK FACTOR CLASSES *)

		priskjoint = Table[Times@@Table[prisk[[scen, n, r, g, riskclass[[ri, r]]]], {r, nrd}],
					{scen, nscen0}, {n, nstap}, {g, ng}, {ri, Length[riskclass]}];

		RMrisk	= Table[meanaggreg[RRrisksel[[r, d, g, ri]]],
					{r, nrd}, {d, Length[RRrisksel[[r]]]}, {g, ng}, {ri, ncrsel[[r]]}];

		RMrisk	= Table[RMrisk[[r, d, g, ri]] / (Plus@@(RMrisk[[r, d, g]] prisk[[scen, n, r, g]]) + eps),
					{scen, nscen0}, {n, nstap}, {r, nrd}, {d, Length[RMrisk[[r]]]}, {g, ng}, {ri, ncrsel[[r]]}];

		RMcont	= Table[meanaggreg[RRcontsel[[r, d, g, ri]]],
					{r, nrc}, {d, Length[RRcontsel[[r]]]}, {g, ng}, {ri, 3}];

		RMcont	= Table[RMcont[[r, d, g, ri]] / (Plus@@(RMcont[[r, d, g]] pcont[[scen, n, r, g]]) + eps),
					{scen, nscen0}, {n, nstap}, {r, nrc}, {d, Length[RMcont[[r]]]}, {g, ng}, {ri, 3}];
		
		pdisjoint = Table[Times@@Table[RMrisk[[scen, n, r, RRriskindsel[[r, d + 1]], g, riskclass[[ri, r]]]], {r, nrd}] *
						pdis[[scen, n, d, g]],
					 {scen, nscen0}, {n, nstap}, {ri, Length[riskclass]}, {d, nd}, {g, ng}];

		];

printbug["3.7"];

	Switch[disweighting,

		(* DISEASE-FREE YEARS *)

		1,

		If[(heterogeneity == 0),

			Do[npop1[[scen, n]] *=
					Times@@(1 - pdis[[scen, n, Range[nd]]]), {scen, nscen0}, {n, nstap}],

			Do[npop1[[scen, n, g]] *=
					Plus@@Table[priskjoint[[scen, n, g, ri]] Times@@(1 - pdisjoint[[scen, n, ri, Range[nd], g]]),
						{ri, Length[riskclass]}],
					{scen, nscen0}, {n, nstap}, {g, ng}]

			];

		(* OTHER DISEASES INCLUDED *)

		Do[npop1[[scen, n]] *=
				(1 + otherdis (Times@@Table[1 - pdis0[[nondisind[[d]]]], {d, nd0 - nd}] Times@@(1 - nonmodelpdis0) - 1)),
				{scen, nscen0}, {n, nstap}],
		
		(* PROPORTIONAL DALY WEIGHTING *)

		2,

		If[(heterogeneity == 0),

			Do[npop1[[scen, n]] *=
					Times@@Table[1 - DALYwgt0[[disind[[d]]]] pdis[[scen, n, d]], {d, nd}],
					{scen, nscen0}, {n, nstap}],

			Do[npop1[[scen, n, g]] *=
					Plus@@Table[
						priskjoint[[scen, n, g, ri]] *
						Times@@Table[1 - DALYwgt0[[disind[[d]], g]] pdisjoint[[scen, n, ri, d, g]], {d, nd}],
						{ri, Length[riskclass]}],
					{scen, nscen0}, {n, nstap}, {g, ng}]

			];

		(* OTHER DISEASES INCLUDED *)

		Do[npop1[[scen, n]] *=
				(1 + otherdis *
					(Times@@Table[1 - DALYwgt0[[nondisind[[d]]]] pdis0[[nondisind[[d]]]], {d, nd0 - nd}] *
					Times@@(1 - nonmodelDALYwgt0 nonmodelpdis0) - 1)),
				{scen, nscen0}, {n, nstap}],
					
		(* ADDITIVE DALY WEIGHTING *)

		3,

		Do[npop1[[scen, n]] *=
				(1 - 	Plus@@Table[DALYwgt0[[disind[[d]]]] pdis[[scen, n, d]], {d, nd}] -
					otherdis Plus@@Table[DALYwgt0[[nondisind[[d]]]] pdis0[[nondisind[[d]]]], {d, nd0 - nd}] -
					otherdis Plus@@(nonmodelDALYwgt0 nonmodelpdis0)),
				{scen, nscen0}, {n, nstap}],

		(* WORST DISEASE DALY WEIGHTING *)

		4,

		If[(otherdis == 0),

			(* ONLY MODELED DISEASES INCLUDED *)

			seq	= Ordering[Table[Plus@@Flatten[DALYwgtsel[[d]]], {d, nd}]];

			If[(heterogeneity == 0),

				Do[npop1[[scen, n]] *=
						(1 - 
						Plus@@Table[DALYwgt0[[disind[[seq[[d]]]]]] pdis[[scen, n, seq[[d]]]] *
									Times@@(1 - pdis[[scen, n, Range[seq[[d]] - 1]]]),
								{d, nd}]),
						{scen, nscen0}, {n, nstap}],

				
				Do[npop1[[scen, n, g]] *=
						Plus@@Table[
							priskjoint[[scen, n, g, ri]] *
							(1 -
							Plus@@Table[DALYwgt0[[disind[[seq[[d]]]], g]] *
										pdisjoint[[scen, n, ri, seq[[d]], g]] *
										Times@@(1 - pdisjoint[[scen, n, ri, Range[seq[[d]] - 1], g]]),
									{d, nd}]),
							{ri, Length[riskclass]}],
						{scen, nscen0}, {n, nstap}, {g, ng}]

				],

			(* ALSO NON-MODELED DISEASES INCLUDED *)

			seq = Ordering[Join[Table[Plus@@Flatten[DALYwgt0[[d]]], {d, nd0}],
						Table[Plus@@Flatten[nonmodelDALYwgt0[[d]]], {d, ndoth}]]];

			If[(heterogeneity == 0),

				(* HOMOGENEOUS POPULATION *)

				hpdis = Table[If[(seq[[d]] <= nd0),
							If[(disindinv[[seq[[d]]]] > 0),
								pdis[[Range[nscen], Range[nstap], disindinv[[seq[[d]]]]]],
								Table[pdis0[[seq[[d]]]], {nscen0}, {nstap}]
								],
							Table[nonmodelpdis0[[seq[[d]] - nd0]], {nscen0}, {nstap}]
							],
						{d, nd0 + ndoth}];

				Do[npop1[[scen, n]] *=
						(1 -
						Plus@@Table[DALYwgtall[[seq[[d]]]] hpdis[[d, scen, n]] *
									Times@@(1 - hpdis[[Range[d - 1], scen, n]]),
								{d, nd0 + ndoth}]),
						{scen, nscen0}, {n, nstap}],

				(* HETEROGENEOUS POPULATION *)

				hpdis = Table[If[(seq[[d]] <= nd0),
						If[(disindinv[[seq[[d]]]] > 0),
							Table[pdisjoint[[scen, n, ri, disindinv[[seq[[d]]]]]],
								{scen, nscen0}, {n, nstap}, {ri, Length[riskclass]}],
							Table[pdis0[[seq[[d]]]], {nscen0}, {nstap}, {Length[riskclass]}]
							],
						Table[nonmodelpdis0[[seq[[d]] - nd0]], {nscen0}, {nstap}, {Length[riskclass]}]
						],
						{d, nd0 + ndoth}];

				Do[npop1[[scen, n, g]] *=
						Plus@@Table[
							priskjoint[[scen, n, g, ri]] *
							(1 -
							Plus@@Table[DALYwgtall[[seq[[d]], g]] hpdis[[d, scen, n, ri, g]] *
										Times@@(1 - hpdis[[Range[d - 1], scen, n, ri, g]]),
									{d, nd0 + ndoth}]),
							{ri, Length[riskclass]}],
						{scen, nscen0}, {n, nstap}, {g, ng}]

				]

			]

		];

printbug["3.8"];

	makenpopnonagg[npop1, diffscen]
			
	]; (* END MAKENPOP *)
# *)

(* # NEW #*)

(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: TOTAL POPULATION NUMBERS
----------------------------------------------------*)

printbug["3."];

makenpop[result_, diffscen_] := Block[{},

	(* TOTAL POPULATION NUMBERS *)

	npop1 	= Table[Plus@@result[[1, scenlist[[scen]]]], {scen, nscen0}] / ndrawinput;

	makenpopnonagg[npop1, diffscen]
			
	]; (* END MAKENPOP *)

(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: DISCOUNTING WEIGHTED FUTURE TOTAL POPULATION NUMBERS
----------------------------------------------------*)

printbug["4."];

npopdiscount[npop_, diffscen_, discount_, standardnpop_] := Block[{},

	npop1 = npop;

	(* ONLY REFERENCE SCENARIO *)

printbug["4.1"];

	If[(diffscen == 0), npop1 = npop1[[{1}]]];

	(* STANDARDIZED TO INITIAL POPULATION SIZE 1 *)

printbug["4.2"];

	If[(standardized == 1),
		npop1 = Table[npop1[[scen, g, n]] / standardnpop[[scen, g]], {scen, Length[npop1]}, {g, ng}, {n, nstap}]];

	(* FUTURE NUMBERS DISCOUNTED *)

printbug["4.3"];

	If[(discount > eps),
		npop1 = Table[npop1[[scen, g, n]] / (1 + discount)^(n - 1), {scen, Length[npop1]}, {g, ng}, {n, nstap}]];

	(* CUMULATIVE *)

printbug["4.4"];

	If[(cumulative == 1),
		npop1 = Table[Plus@@npop1[[scen, g, Range[n]]], {scen, Length[npop1]}, {g, ng}, {n, nstap}]];

	npop1

	]; (* END NPOPDISCOUNT *)


(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: RISK FACTOR CLASS PREVALENCE NUMBERS
----------------------------------------------------*)

printbug["5."];

(* (DISCRETE) RISK FACTOR CLASS RATES AND NUMBERS: AGGREGATED OVER AGE OR SPECIFIED BY AGE CLASS,
FOR BASELINE SCENARIO OR DIFFERENCES WITH BASELINE SCENARIO *)

makenrisk[nrisk_, diffscen_] := Block[{},

	plusnrisk = If[(agespecres <= 1),
	
			(* AGGREGATED OVER AGE *)

			Table[Plus@@Flatten[nrisk[[scenlist[[scen]], n, r, g, ri]]],
				{scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],

			(* SPECIFIED BY AGE CLASS *)
			
			Table[aggregc[Plus@@nrisk[[scenlist[[scen]], n, r, g, ri]], 1, 7],
				{scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]

			] / ndrawinput;

	makeresdiff[plusnrisk, diffscen]

	]; (* END MAKENRISK *)

(* (CONTINUOUS) RISK FACTOR CLASS RATES AND NUMBERS: AGGREGATED OVER AGE OR SPECIFIED BY AGE CLASS,
FOR BASELINE SCENARIO OR DIFFERENCES WITH BASELINE SCENARIO *)

makedist[dist_, diffscen_] := Block[{},

	plusdist = If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			Table[Plus@@Flatten[dist[[scenlist[[scen]], n, r, g, ri]]],
				{scen, nscen0}, {r, nrc}, {g, ng}, {ri, 2}, {n, nstap}],

			(* SPECIFIED BY AGE CLASS *)

			Table[aggregc[Plus@@dist[[scenlist[[scen]], n, r, g, ri]], 1, 7],
				{scen, nscen0}, {r, nrc}, {g, ng}, {ri, 2}, {n, nstap}]

			] / ndrawinput;

	makeresdiff[plusdist, diffscen]

	]; (* END MAKEDIST *)

(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: DISEASE (PREVALENCE, INCIDENCE AND MORTALITY) NUMBERS AND RATES
----------------------------------------------------*)

printbug["6."];

(* DISEASE RATES & NUMBERS: AGGREGATED OVER AGE OR SPECIFIED BY AGE CLASS, FOR BASELINE SCENARIO OR DIFFERENCES WITH BASELINE SCENARIO *)

makendis[ndis_, diffscen_] := Block[{},

	plusndis = If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			Table[Plus@@Flatten[ndis[[scenlist[[scen]], n, d, g]]],
					{scen, nscen0}, {d, Length[ndis[[1, 1]]]}, {g, ng}, {n, nstap}],

			(* SPECIFIED BY AGE CLASS *)

			Table[aggregc[Plus@@ndis[[scenlist[[scen]], n, d, g]], 1, 7],
					{scen, nscen0}, {d, Length[ndis[[1, 1]]]}, {g, ng}, {n, nstap}]

			] / ndrawinput;

	makeresdiff[plusndis, diffscen]

	]; (* END MAKENDIS *)


(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: COSTS
----------------------------------------------------*)

printbug["7."];

makencosts[resmodel_] := Block[{},

	ncosts 	= Table[Join[	Table[costspatient0[[disind[[d]], g]] Plus@@resmodel[[4, scenlist[[scen]], n, d, g]], {d, nd}],
				{otherdis meanaggreg[costspersonothsel[[g]]] Plus@@resmodel[[1, scenlist[[scen]], n, g]]}],
			{scen, nscen0}, {g, ng}, {n, nstap}] / ndrawinput;

	Transpose[Table[Join[ncosts[[scen, g, n]], {Plus@@ncosts[[scen, g, n]]}], {scen, nscen0}, {g, ng}, {n, nstap}], {1, 3, 4, 2, 5}]

	]; (* END MAKENCOSTS *)


(* --------------------------------------------------
	GENERAL ROUTINES OF CALCULATING OUTPUT NUMBERS: DISCOUNTING FUTURE COSTS
----------------------------------------------------*)

printbug["7.1"];

ncostsdiscount[ncosts_, discount_, standardnpop_] := Block[{},

	ncosts1 = ncosts;

	(* STANDARDIZED TO INITIAL POPULATION SIZE 1 *)

	If[(standardized == 1),
		ncosts1 = Table[ncosts1[[scen, d, g, n]] / standardnpop[[scen, g]],
				{scen, nscen0}, {d, nd + 2}, {g, ng}, {n, nstap}]];

	(* FUTURE NUMBERS DISCOUNTED *)

	If[(discount > eps),
		ncosts1 = Table[ncosts1[[scen, d, g, n]] / (1 + discount)^(n - 1),
				{scen, nscen0}, {d, nd + 2}, {g, ng}, {n, nstap}]];

	(* CUMULATIVE *)

	If[(cumulative == 1),
		ncosts1 = Table[Plus@@ncosts1[[scen, d, g, Range[n]]], {scen, nscen0}, {d, nd + 2}, {g, ng}, {n, nstap}]];

	ncosts1

	];
	

(* --------------------------------------------------
		Notebook containing model results
----------------------------------------------------*)

If[(outputnotebook == 1), nbout = NotebookCreate[]];


(* --------------------------------------------------
		Write info to Logfile
----------------------------------------------------*)

(* PACKAGE VERSION *)

version = 3.1;

WriteString[logfile, 
		"\t" <> "Package: " <> StringReplace[Evaluate[Context[]], "`Private`"-> ", " ] 
		<> "version " <> ToString[version] <> "\n\n"];

End[]


Protect[Evaluate[Context[] <> "*"]]


EndPackage[]
(* :Title: CZMPresentResults *)

(* :Context: CZMPostProcessing` *)

(* :Author: Rudolf T. Hoogenveen, Roel G.M. Breuls *)

(* :Summary:
   CZM postprocessing routine presents results *)

(* :Copyright: © 2004 by Rudolf Hoogenveen/Roel Breuls *)

(* :Package Version: 3.1 *)

(* :Mathematica Version: 5.1 *)

(* :History: 	1.0 first update new implementation CZM July 2004
		2.0 first release CZM 2005, version March
		3.1 version March 2007, storage of indexvalues, new packages CZMStoreResults *)

(* :Keywords: postprocessing, plots *)


BeginPackage["CZMPostProcessing`CZMPresentResults`",
	{"CZMMain`CZMMain`",
	"CZMInitialization`CZMLogFile`",
	"CZMInitialization`CZMDefaultFileNames`",
	"CZMInitialization`CZMConstants`",
	"CZMInitialization`CZMFunctions`", 
	"CZMImportData`CZMImportUserSelections`",
	"CZMImportData`CZMImportDiseaseData`",
	"CZMImportData`CZMImportDALYs`",
	"CZMImportData`CZMImportCosts`",
	"CZMAdjustData`CZMMakeSelections`",
	"CZMAdjustData`CZMAdjustAfterSelection`",
	"CZMSimulation`CZMSimulationFunctions`",
	"CZMSimulation`CZMSimulationMarginalModelDetermPop`",
	"CZMSimulation`CZMSimulationJointModelDetermPop`",
	"CZMSimulation`CZMSimulationJointModelDetermAge`",
	"CZMSimulation`CZMSimulationJointModelStochInd`",
	"CZMSimulation`CZMStoreResults`",
	"CZMPostProcessing`CZMExportUserSelections`",
	"CZMPostProcessing`CZMCalcResults`",
	"Graphics`Legend`",
	"Graphics`MultipleListPlot`",
	"Graphics`FilledPlot`"}]

Begin["`Private`"]

Print["CZMPresentResults package is evaluated"];
printtijd;

printbug[c_] := If[(bugind == 1), Print[{"CZMPresentResults", c}]];

printbug["1."];

imagesize	= 240;
stdaxislabel 	= {"time", ""};
stdagecolor1	= Table[{RGBColor[(ai - 1) / (nac[[7]] - 1), 0, 1 - (ai - 1) / (nac[[7]] - 1)]}, {ai, nac[[7]]}];
stdagecolor2	= Join[	{{{Axis, 1}, RGBColor[0, 0, 1]}},
			Table[{{ai, ai + 1}, RGBColor[ai / (nac[[7]] - 1), 0, 1 - ai / (nac[[7]] - 1)]}, {ai, nac[[7]] - 1}]
			];
stdmodelcolor	= Table[{RGBColor[m / Plus@@modelsel, 0, 1 - m / Plus@@modelsel]}, {m, 0, Plus@@modelsel - 1}];

stdriskcolor[r_] := Join[{{{Axis, 1}, RGBColor[0, 1, 0]}},
			Table[{{ri, ri + 1}, RGBColor[ri / (ncrsel[[r]] - 1), 1 - ri / (ncrsel[[r]] - 1), 0]},
				{ri, ncrsel[[r]] - 1}]
			];
stdagelegend	= Table["age" <> ToString[initageclass[[7, ai]]] <> "+", {ai, nac[[7]]}];
stdmodellegend	= Table["model" <> ToString[m], {m, Plus@@modelsel}];

stdlabel[r_, ri_] := risknames[[riskindd]][[r]] <> "class " <> ToString[ri];
stdlabelc[r_, ri_] := risknames[[riskindc]][[r]] <> "parameter " <> ToString[ri];
basescenstr 	= " for baseline scenario";
compscenstr 	= " differences with baseline scenario";
ratesstr	= {" absolute numbers "," rates "}[[rates + 1]];

plotset1	= {	DisplayFunction -> Identity, 
			PlotJoined 	-> True,  
			TextStyle 	-> stdtextstyle,
			AxesLabel 	-> stdaxislabel,
			PlotRange	-> All};

plotset2	= {	DisplayFunction -> Identity,
			SymbolShape 	-> None,
			LegendPosition 	-> {-.8, .0},
			LegendSize 	-> {.65, .5},
			PlotJoined 	-> True,
			TextStyle 	-> stdtextstyle,
			AxesLabel 	-> stdaxislabel,
			PlotRange	-> All};

plotset3	= {	PlotRange	-> All,
			DisplayFunction -> Identity,
			TextStyle 	-> stdtextstyle,
			AxesLabel 	-> stdaxislabel,
			PlotRange 	-> All};
										

(*-------------------------------------------------
	PLOTS TOTAL POPULATION NUMBERS & TIME SINCE SMOKING CESSATION
---------------------------------------------------*)

printbug["2."];

(* WRITE TO SCREEN *)

plotpop[respop_, naam_, diffscen_] := Block[{},
	headingprint1[naam];
	Table[Show[
		headingprint3["gender: " <> gennames[[g]]];
	    	GraphicsArray[Table[
			If[(agespecres <= 1),

				(* NUMBERS AGGREGATED OVER AGE *)

				ListPlot[respop[[scen, g]],
					plotset1,
					PlotLabel 	-> scenname[scen, diffscen]],

			If[(agespecres == 2),

				(* NUMBERS SPECIFIED BY AGE CLASS, NOT STACKED *)

				makemultiplelistplot[Table[respop[[scen, g, Range[nstap], ai]], {ai, nac[[7]]}],
					{plotset2,
					PlotStyle 	-> stdagecolor1,
					PlotLegend 	-> stdagelegend,
					PlotLabel 	-> scenname[scen, diffscen]}],

			If[(agespecres == 3),

				(* NUMBERS SPECIFIED BY AGE CLASS, STACKED *)

				respop1 = Table[Plus@@respop[[scen, g, n, Range[ai]]], {ai, nac[[7]]}, {n, nstap}];
				frespop[x_] := Table[respop1[[ai, Round[x]]], {ai, nac[[7]]}];
				FilledPlot[frespop[x], {x, nstap},
					plotset3,
					PlotLabel 	-> scenname[scen, diffscen],
					Fills 		-> stdagecolor2]
				]]],
		     	{scen, Length[respop]}]],
		ImageSize 	-> Min[{nscen imagesize, 900}],
		DisplayFunction :> $DisplayFunction,
		Background 	-> RGBColor[1, 1, 1]
		],
	{g, ng}]
	];

(* WRITE TO NOTEBOOK *)

plotpopnb[respop_, naam_, diffscen_] := 
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb["gender: " <> gennames[[g]]],
	    	Cell[	GraphicsData[
				"PostScript",
				DisplayString[
					GraphicsArray[
						Table[	If[(agespecres <= 1),

								(* NUMBERS AGGREGATED OVER AGE *)

								ListPlot[respop[[scen, g]],
									plotset1,
									PlotLabel 	-> scenname[scen, diffscen], 
									PlotStyle 	-> {Thickness[.02]}],

							If[(agespecres == 2),

								(* NUMBERS SPECIFIED BY AGE CLASS, NOT STACKED *)

								makemultiplelistplot[Table[respop[[scen, g, Range[nstap], ai]],
														{ai, nac[[7]]}],
									{plotset2,
									PlotStyle 	-> stdagecolor1,
									PlotLegend 	-> stdagelegend,
									PlotLabel 	-> scenname[scen, diffscen]}],

							If[(agespecres == 3),

								(* NUMBERS SPECIFIED BY AGE CLASS, STACKED *)

								respop1 = Table[Plus@@respop[[scen, g, n, Range[ai]]],
										{ai, nac[[7]]}, {n , nstap}];
								frespop[x_] := Table[respop1[[ai, Round[x]]], {ai, nac[[7]]}];
								FilledPlot[frespop[x], {x, nstap},
									plotset3,
									PlotLabel 	-> scenname[scen, diffscen],
									Fills 		-> stdagecolor2]
								]]],
						     	{scen, Length[respop]}]
						]
					]
				],
			"Subsection",
			ImageSize -> Min[{nscen imagesize, 900}]
			
			]
		},
	{g, ng}]
	};

(* WRITE TO NOTEBOOK, RESULTS FOR SEVERAL CZM MODEL VERSIONS SIMULTANEOUSLY *)

plotpopnb1[respop_, naam_, diffscen_] := 
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb["gender: " <> gennames[[g]]],
	    	Cell[	GraphicsData[
				"PostScript",
				DisplayString[
					GraphicsArray[
						Table[	If[(agespecres <= 1),

								(* NUMBERS AGGREGATED OVER AGE *)

								makemultiplelistplot[Table[respop[[m, scen, g]], {m, Length[respop]}],
									{plotset2,
									PlotLegend 	-> stdmodellegend,
									PlotLabel 	-> scenname[scen, diffscen], 
									PlotJoined 	-> True, 
									PlotStyle 	-> stdmodelcolor}]

							],
						     	{scen, Length[respop[[1]]]}]
						]
					]
				],
			"Subsection",
			ImageSize -> Min[{nscen imagesize, 900}]
			
			]
		},
	{g, ng}]
	};


(*-------------------------------------------------
	PLOTS (DISCRETE) RISK FACTOR CLASS PREVALENCE NUMBERS AND RATES
---------------------------------------------------*)

printbug["2.1"];

(* WRITE TO SCREEN *)

plotrisk[resrisk_, naam_, diffscen_]:= Block[{},
	headingprint1[naam];
	Table[	headingprint2[scenname[scen, diffscen]],
		Table[	
			headingprint3["gender " <> gennames[[g]]];
			If[(agespecres == 1),

				(*TOTAL NUMBERS, SPECIFICATION BY RISK FACTOR CLASSES STACKED *)

				Show[GraphicsArray[Table[
					resrisk1 = Table[Plus@@resrisk[[scen, r, g, Range[ri]]], {ri, ncrsel[[r]]}];
					fresrisk[x_] := Table[resrisk1[[ri, Round[x]]], {ri, ncrsel[[r]]}];
					FilledPlot[fresrisk[x], {x, nstap},
						plotset3,
						PlotLabel 	-> risknames[[riskindd]][[r]],
						Fills 		-> stdriskcolor[r]],						
						{r, nrd}]],
					ImageSize 	-> Min[{nrd imagesize, 900}],
					DisplayFunction :> $DisplayFunction, 
					Background 	-> RGBColor[1, 1, 1]
					],

				Table[Show[GraphicsArray[Table[
					Switch[agespecres,
						0,

						(* TOTAL NUMBERS FOR EACH RISK FACTOR CLASS *)

						ListPlot[resrisk[[scen, r, g, ri]],
							plotset1,
							PlotLabel 	-> stdlabel[r, ri]],
						2,

						(* NUMBERS BY AGE CLASS FOR EACH RISK FACTOR CLASS, NOT STACKED *)

			     			makemultiplelistplot[Table[resrisk[[scen, r, g, ri, Range[nstap], ai]], {ai, nac[[7]]}],
							{plotset2,
              						PlotStyle 	-> stdagecolor1,
							PlotLegend 	-> stdagelegend,
							PlotLabel 	-> stdlabel[r, ri]}],
						3,

						(* NUMBERS BY AGE CLASS FOR EACH RISK FACTOR CLASS, STACKED *)

						resrisk1 = Table[Plus@@resrisk[[scen, r, g, ri, n, Range[ai]]],
								{ai, nac[[7]]}, {n, nstap}];
						fresrisk[x_] := Table[resrisk1[[ai, Round[x]]], {ai, nac[[7]]}];
						FilledPlot[fresrisk[x], {x, nstap},
							plotset3,
							PlotLabel 	-> stdlabel[r, ri],
							Fills 		-> stdagecolor2]
						],
						{ri, ncrsel[[r]]}]],
					ImageSize 	-> Min[{ncrsel[[r]] imagesize, 900}],
					DisplayFunction :> $DisplayFunction, 
					Background 	-> RGBColor[1, 1, 1]
					],
					{r, nrd}]
				],
		{g, ng}], 
	{scen, Length[resrisk]}]
	];

(* WRITE TO NOTEBOOK *)

plotrisknb[resrisk_, naam_, diffscen_]:= 
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb[scenname[scen, diffscen] <> " gender " <> gennames[[g]]],
		Switch[agespecres,
			0,

			(* TOTAL NUMBERS FOR EACH RISK FACTOR CLASS *)

			Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	ListPlot[resrisk[[scen, r, g, rj]],
										plotset1,
										PlotLabel 	-> stdlabel[r, rj], 
										AxesLabel 	-> stdaxislabel],
									{rj, 4 ri + 1, Min[{4 ri + 4, ncrsel[[r]]}]}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{(Min[{4 ri + 4, ncrsel[[r]]}] - 4 ri) imagesize, 900}]
					],
				{r, nrd}, {ri, 0, Floor[(ncrsel[[r]] - 1) / 4]}],

			1,

			(*TOTAL NUMBERS, SPECIFICATION BY RISK FACTOR CLASSES STACKED *)

			Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	resrisk1 = Table[Plus@@resrisk[[scen, r, g, Range[ri], n]],
											{ri, ncrsel[[r]]}, {n, nstap}];
									fresrisk[x_] := Table[resrisk1[[ri, Round[x]]],
											{ri, ncrsel[[r]]}];
									FilledPlot[fresrisk[x], {x, nstap},
										plotset3,
										PlotLabel 	-> risknames[[riskindd]][[r]],
										Fills 		-> stdriskcolor[r]],
									{r, nrd}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{nrd imagesize, 900}]
				],

			2,

			(* NUMBERS BY AGE CLASS FOR EACH RISK FACTOR CLASS, NOT STACKED *)

			Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	makemultiplelistplot[Table[resrisk[[scen, r, g, ri, Range[nstap], ai]],
												{ai, nac[[7]]}], 
										{plotset2,
			              						PlotStyle 	-> stdagecolor1,
										PlotLegend 	-> stdagelegend,
										PlotLabel 	-> stdlabel[r, ri]}],
									{ri, ncrsel[[r]]}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{ncrsel[[r]] imagesize, 900}]
					],
				{r, nrd}],

			3,

			(* NUMBERS BY AGE CLASS FOR EACH RISK FACTOR CLASS, STACKED *)

			Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	resrisk1 = Table[Plus@@resrisk[[scen, r, g, rj, n, Range[ai]]],
												{ai, nac[[7]]}, {n, nstap}];
									fresrisk[x_] := Table[resrisk1[[ai, Round[x]]],
												{ai, nac[[7]]}];
									FilledPlot[fresrisk[x], {x, nstap},
											plotset3,
											PlotLabel 	-> stdlabel[r, rj],
											Fills 		-> stdagecolor2],												{rj, 4 ri + 1, Min[{4 ri + 4, ncrsel[[r]]}]}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{(Min[{4 ri + 4, ncrsel[[r]]}] - 4 ri) imagesize, 900}]
					],
				{r, nrd}, {ri, 0, Floor[(ncrsel[[r]] - 1) / 4]}]
			]
		},
	{scen, Length[resrisk]}, {g, ng}]
	};

(* WRITE TO NOTEBOOK, RESULTS FOR SEVERAL CZM MODEL VERSIONS SIMULTANEOUSLY *)

plotrisknb1[resrisk_, naam_, diffscen_]:= 
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb[scenname[scen, diffscen] <> " gender " <> gennames[[g]]],
		Switch[agespecres,
			0,

			(* TOTAL NUMBERS FOR EACH RISK FACTOR CLASS *)

			Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	makemultiplelistplot[Table[resrisk[[m, scen, r, g, rj]],
												{m, Length[resrisk]}],
										{plotset2,
										PlotLegend 	-> stdmodellegend,
										PlotLabel 	-> stdlabel[r, rj], 
										PlotStyle 	-> stdmodelcolor}],
									{rj, 4 ri + 1, Min[{4 ri + 4, ncrsel[[r]]}]}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{(Min[{4 ri + 4, ncrsel[[r]]}] - 4 ri) imagesize, 900}]
					],
				{r, nrd}, {ri, 0, Floor[(ncrsel[[r]] - 1) / 4]}],

			1,

			_,

			2,

			_,

			3,

			_]
		},
	{scen, Length[resrisk[[1]]]}, {g, ng}]
	};


(*-------------------------------------------------
	PLOTS (CONTINUOUS) RISK FACTOR DISTRIBUTION CHARACTERISTICS
---------------------------------------------------*)

printbug["2.2"];

(* WRITE TO NOTEBOOK *)

plotdistnb[resdist_, naam_, diffscen_]:= 
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb[scenname[scen, diffscen] <> " gender " <> gennames[[g]]],
		If[(agespecres <= 1),
			
			(* TOTAL NUMBERS FOR EACH CHARACTERISTIC *)

			Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	ListPlot[resdist[[scen, r, g, ri]],
										plotset1,
										PlotLabel 	-> stdlabelc[r, ri]],
									{ri, 2}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{2 imagesize, 900}]
					],
				{r, nrc}],

			(* NUMBERS BY AGE CLASS FOR EACH RISK FACTOR CLASS, NOT STACKED *)

			Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[makemultiplelistplot[Table[resdist[[scen, r, g, ri, Range[nstap], ai]],
												{ai, nac[[7]]}], 
										{plotset2,
			              						PlotStyle 	-> stdagecolor1,
										PlotLegend 	-> stdagelegend,
										PlotLabel 	-> stdlabelc[r, ri]}],
									{ri, 2}]
								]
							]
						],
					"Subsection",
					ImageSize -> Min[{2 imagesize, 900}]
					],
				{r, nrc}]

			]
		},
	{scen, Length[resdist]}, {g, ng}]
	};

(*-------------------------------------------------
	PLOTS DISEASE PREVALENCE NUMBERS AND RATES
---------------------------------------------------*)

printbug["2.3"];

(* WRITE TO SCREEN *)

plotdis[resdis_, naam_, diffscen_]:= Block[{},
	nd1 = Length[resdis[[1]]];
	headingprint1[naam];
	Table[
		headingprint2[scenname[scen, diffscen]];
		Table[
			headingprint3["gender " <> gennames[[g]]];
			Table[Show[
    				GraphicsArray[Table[
					If[(agespecres <= 1),

						(* NUMBERS AGGREGATED OVER AGE *)

						ListPlot[resdis[[scen, dj, g]],
							plotset1,
							PlotLabel 	-> mortnames[[dj]]],

					If[(agespecres == 2),

						(* NUMBERS BY AGE CLASS, NOT STACKED *)

						makemultiplelistplot[Table[resdis[[scen, dj, g, Range[nstap], ai]], {ai, nac[[7]]}],
							{plotset2,
							PlotStyle 	-> stdagecolor1,
				 			PlotLegend 	-> stdagelegend,
							PlotLabel 	-> mortnames[[dj]]}],

					If[(agespecres == 3),

						(* NUMBERS BY AGE CLASS, STACKED *)

						resdis1 = Table[Plus@@resdis[[scen, dj, g, n, Range[ai]]], {ai, nac[[7]]}, {n, nstap}];
						fresdis[x_] := Table[resdis1[[ai, Round[x]]], {ai, nac[[7]]}];
						FilledPlot[fresdis[x], {x, nstap},
							plotset3,
							PlotLabel 	-> mortnames[[dj]],
							Fills 		-> stdagecolor2]
					]]],
		     			{dj, 4 di + 1, Min[{4 di + 4, nd1}]}]],
				ImageSize 	-> (Min[{4 di + 4, nd1}] - 4 di) imagesize, 
				DisplayFunction :> $DisplayFunction,
				Background 	-> RGBColor[1, 1, 1]
				], 	
			{di, 0, Floor[(nd1 - 1) / 4]}],
		{g, ng}], 
	{scen, Length[resdis]}]
	];

(* WRITE TO NOTEBOOK *)

plotdisnb[resdis_, naam_, diffscen_]:= Block[{},
	nd1 = Length[resdis[[1]]];
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb[scenname[scen, diffscen] <> " gender " <> gennames[[g]]],
		Table[	Cell[	GraphicsData[
					"PostScript",
					DisplayString[
   						GraphicsArray[
							Table[
								If[(agespecres <= 1),

									(* NUMBERS AGGREGATED OVER AGE *)

									ListPlot[resdis[[scen, dj, g]],
										plotset1,
										PlotLabel 	-> mortnames[[dj]]],

								If[(agespecres == 2),

									(* NUMBERS BY AGE CLASS, NOT STACKED *)

									makemultiplelistplot[Table[resdis[[scen, dj, g, Range[nstap], ai]],
												{ai, nac[[7]]}],
										{plotset2,
										PlotStyle 	-> stdagecolor1,
		 								PlotLegend 	-> stdagelegend,
										PlotLabel 	-> mortnames[[dj]]}],

								If[(agespecres == 3),

									(* NUMBERS BY AGE CLASS, STACKED *)

									resdis1 = Table[Plus@@resdis[[scen, dj, g, n, Range[ai]]], 
												{ai, nac[[7]]}, {n, nstap}];
									fresdis[x_] := Table[resdis1[[ai, Round[x]]], {ai, nac[[7]]}];
									FilledPlot[fresdis[x], {x, nstap},
										plotset3,
										PlotLabel 	-> mortnames[[dj]],
										Fills 		-> stdagecolor2]
								]]],
     								{dj, 4 di + 1, Min[{4 di + 4, nd1}]}]
								]
							]
						],
				"Subsection",
				ImageSize -> Min[{(Min[{4 di + 4, nd1}] - 4 di) imagesize, 900}]
				],
			{di, 0, Floor[(nd1 - 1) / 4]}]
			},
		{scen, Length[resdis]}, {g, ng}] 
	}
	];

(* WRITE TO NOTEBOOK, RESULTS FOR SEVERAL CZM MODEL VERSIONS SIMULTANEOUSLY *)

plotdisnb1[resdis_, naam_, diffscen_]:= Block[{},
	nd1 = Length[resdis[[1, 1]]];
	{
	headingprint2nb[naam <> If[(diffscen == 0), basescenstr, compscenstr]],
	Table[	{
		headingprint3nb[scenname[scen, diffscen] <> " gender " <> gennames[[g]]],
		Table[	Cell[	GraphicsData[
					"PostScript",
					DisplayString[
   						GraphicsArray[
							Table[
								If[(agespecres <= 1),

									(* NUMBERS AGGREGATED OVER AGE *)

									makemultiplelistplot[Table[resdis[[m, scen, dj, g]],
												{m, Length[resdis]}],
										{plotset2,
										PlotStyle 	-> stdmodelcolor,
		 								PlotLegend 	-> stdmodellegend,
										PlotLabel 	-> mortnames[[dj]]}]

								],
     								{dj, 4 di + 1, Min[{4 di + 4, nd1}]}]
								]
							]
						],
				"Subsection",
				ImageSize -> Min[{(Min[{4 di + 4, nd1}] - 4 di) imagesize, 900}]
				],
			{di, 0, Floor[(nd1 - 1) / 4]}]
			},
		{scen, Length[resdis[[1]]]}, {g, ng}] 
	}
	];


(* --------------------------------------------------
	PRINTING ROUTINES FOR EVENT NUMBERS FOR EACH MODEL TYPE: SUB-ROUTINES
----------------------------------------------------*)

printbug["3."];

(* PRINTS NAME OF OUTPUT VARIABLE AND SCENARIO SPECIFICATIONS *)

resname[t_, diffscen_] 	:= Block[{},

printbug["3.1"];

	str = outputnames[[t]] <> If[(diffscen == 0), basescenstr, compscenstr];

	If[(outputscreen == 1),		headingprint2[str]];
	If[(outputnotebook == 1),	addcellnb[headingprint2nb[str]]];
	If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]]

	];


(* PRINTS TOTAL POPULATION NUMBERS *)

printrespop[respop_, diffscen_] := Block[{},

printbug["3.2"];
	
	Do[	str = scenname[scen, diffscen];

		If[(outputscreen == 1),		headingprint3[str]];				
		If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];	
		If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];		

printbug["3.2.1"];

		If[(agespecres <= 1),

printbug["3.2.2"];

			(* AGGREGATED OVER AGE *)

			If[(outputscreen == 1),		Print[TableForm[respop[[scen]]]]];
			If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[respop[[scen]] // MatrixForm]],
								"Subsection"]]];
			If[(outputfile == 1),		Export[resmodelfile, respop[[scen]], "Table"];			
							WriteString[resmodelfile, "\n\n"]],

printbug["3.2.3"];

			(* SPECIFIED BY AGE *)

			If[(outputscreen == 1),		Do[	Print[gennames[[g]]];
								Print[TableForm[Transpose[respop[[scen, g]]]]],
								{g, ng}]];

			If[(outputnotebook == 1),	addcellnb[Table[
								{headingprint3nb[gennames[[g]]],			
								Cell[BoxData[ToBoxes[Transpose[respop[[scen, g]]] // MatrixForm]],
									"Subsection"]},
								{g, ng}]]];
				
			If[(outputfile == 1),		Do[	WriteString[resmodelfile, gennames[[g]] <> "\n\n"];	
								Export[resmodelfile, Transpose[respop[[scen, g]]], "Table"];
								WriteString[resmodelfile, "\n\n"],
								{g, ng}]];
			],

		{scen, Length[respop]}]

	];


(* PRINTS (DISCRETE) RISK FACTOR CLASS PREVALENCE NUMBERS *)

printresrisk[resrisk_, diffscen_] := Block[{},

printbug["3.3"];

	Do[	str = scenname[scen, diffscen] <> risknames[[riskindd[[r]]]] <> " "<> gennames[[g]];

		If[(outputscreen == 1),		headingprint3[str]];
		If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];					
		If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];				

		If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			If[(outputscreen == 1),		Print[TableForm[resrisk[[scen, r, g]]]]];
			If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[resrisk[[scen, r, g]] // MatrixForm]],
								"Subsection"]]];
			If[(outputfile == 1),		Export[resmodelfile, resrisk[[scen, r, g]], "Table"];		
							WriteString[resmodelfile, "\n\n"]],
			
			(* SPECIFIED BY AGE *)

			If[(outputscreen == 1),		Do[	Print[ToString[ri]];				
								Print[TableForm[Transpose[resrisk[[scen, r, g, ri]]]]],
								{ri, ncrsel[[r]]}]];
	
			If[(outputnotebook == 1),	addcellnb[Table[
								{headingprint3nb[ToString[ri]],				
								Cell[BoxData[ToBoxes[Transpose[resrisk[[scen, r, g, ri]]] // MatrixForm]],
									"Subsection"]},
								{ri, ncrsel[[r]]}]]];

			If[(outputfile == 1),		Do[	WriteString[resmodelfile, ToString[ri] <> "\n\n"];	
								Export[resmodelfile, Transpose[resrisk[[scen, r, g, ri]]], "Table"];
								WriteString[resmodelfile, "\n\n"],
								{ri, ncrsel[[r]]}]];

			],

		{scen, Length[resrisk]}, {r, nrd}, {g, ng}]

	];

(* PRINTS (CONTINUOUS) RISK FACTOR CLASS DISTRIBUTION CHARACTERISTICS *)

printresdist[resdist_, diffscen_] := Block[{},

printbug["3.4"];

	Do[	str = scenname[scen, diffscen] <> risknames[[riskindc[[r]]]] <> " "<> gennames[[g]];

		If[(outputscreen == 1),		headingprint3[str]];
		If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];					
		If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];				

		If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			If[(outputscreen == 1),		Print[TableForm[resdist[[scen, r, g]]]]];
			If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[resdist[[scen, r, g]] // MatrixForm]],
								"Subsection"]]];
			If[(outputfile == 1),		Export[resmodelfile, resdist[[scen, r, g]], "Table"];		
							WriteString[resmodelfile, "\n\n"]],
			
			(* SPECIFIED BY AGE *)

			If[(outputscreen == 1),		Do[	Print[ToString[ri]];				
								Print[TableForm[Transpose[resdist[[scen, r, g, ri]]]]],
								{ri, 2}]];
	
			If[(outputnotebook == 1),	addcellnb[Table[
								{headingprint3nb[ToString[ri]],				
								Cell[BoxData[ToBoxes[Transpose[resdist[[scen, r, g, ri]]] // MatrixForm]],
									"Subsection"]},
								{ri, 2}]]];

			If[(outputfile == 1),		Do[	WriteString[resmodelfile, ToString[ri] <> "\n\n"];	
								Export[resmodelfile, Transpose[resdist[[scen, r, g, ri]]], "Table"];
								WriteString[resmodelfile, "\n\n"],
								{ri, 2}]];

			],

		{scen, Length[resdist]}, {r, nrc}, {g, ng}]

	];


(* PRINTS DISEASE (PREVALENCE, INCIDENCE, MORTALITY) NUMBERS *)

printresdis[resdis_, diffscen_] := Block[{},

printbug["3.5"];

	Do[	str = scenname[scen, diffscen] <> mortnames[[d]];

		If[(outputscreen == 1),		headingprint3[str]];
		If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];					
		If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];								
		If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			If[(outputscreen == 1),		Print[TableForm[resdis[[scen, d]]]]];
			If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[resdis[[scen, d]] // MatrixForm]],
								"Subsection"]]];
			If[(outputfile == 1),		Export[resmodelfile, resdis[[scen, d]], "Table"];		
							WriteString[resmodelfile, "\n\n"]],

			(* SPECIFIED BY AGE *)

			If[(outputscreen == 1),		Do[	Print[gennames[[g]]];				
								Print[TableForm[Transpose[resdis[[scen, d, g]]]]],
								{g, ng}]];

			If[(outputnotebook == 1),	addcellnb[Table[
								{headingprint3nb[gennames[[g]]],			
								Cell[BoxData[ToBoxes[Transpose[resdis[[scen, d, g]]] // MatrixForm]],
									"Subsection"]},
								{g, ng}]]];
			
			If[(outputfile == 1),		Do[	WriteString[resmodelfile, gennames[[g]] <> "\n\n"];	
								Export[resmodelfile, Transpose[resdis[[scen, d, g]]], "Table"];
								WriteString[resmodelfile, "\n\n"],
								{g, ng}]];

			],

		{scen, Length[resdis]}, {d, Length[resdis[[1]]]}]

	];
		
(* --------------------------------------------------
	PRINTING ROUTINES FOR EVENT NUMBERS FOR COMPARING MODEL TYPES: SUB-ROUTINES
----------------------------------------------------*)

(* PRINTS NAME OF OUTPUT VARIABLE AND SCENARIO SPECIFICATIONS *)

resnameabs[t_, diffscen_] := Block[{},

printbug["3.6"];

	str = outputnames[[t]] <> If[(diffscen == 0), basescenstr, compscenstr] <> " (absolute)";

	If[(outputscreen == 1),		headingprint2[str]];
	If[(outputnotebook == 1),	addcellnb[headingprint2nb[str]]];						
	If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]]					

	];


resnamerel[t_, diffscen_] := Block[{},

printbug["3.7"];

	str = outputnames[[t]] <> If[(diffscen == 0), basescenstr, compscenstr] <> " (relative)";

	If[(outputscreen == 1),		headingprint2[str]];								
	If[(outputnotebook == 1),	addcellnb[headingprint2nb[str]]];						
	If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]]					

	];

(* PRINTS RESULTS: DIFFERENCES BETWEEN TOTAL POPULATION NUMBERS *)

printdrespop[drespop_, respop_, diffscen_, respopind_] := Block[{},

printbug["3.8"];

	hprint[hres_, hdiffscen_] := Block[{},

		Do[	If[(outputscreen == 1),		headingprint3[scenname[scen, hdiffscen]]];				
			If[(outputnotebook == 1),	addcellnb[headingprint3nb[scenname[scen, hdiffscen]]]];			
			If[(outputfile == 1),		WriteString[resmodelfile, scenname[scen, hdiffscen] <> "\n\n"]];		

			If[(agespecres <= 1), 

				(* NO AGE SPECIFICATION *)

				If[(outputscreen == 1),		Print[TableForm[hres[[scen]]]]];				
				If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[hres[[scen]] // MatrixForm]],
									"Subsection"]]];

				If[(outputfile == 1),		Export[resmodelfile, hres[[scen]], "Table"];			
								WriteString[resmodelfile, "\n\n"]],

				(* SPECIFIED BY AGE CLASS *)
			
				If[(outputscreen == 1),		Do[	Print[gennames[[g]]];				
									Print[TableForm[Transpose[hres[[scen, g]]]]],
									{g, ng}]];

				If[(outputnotebook == 1),	addcellnb[Table[
									{headingprint3nb[gennames[[g]]],				
									Cell[BoxData[ToBoxes[Transpose[hres[[scen, g]]] // MatrixForm]],
										"Subsection"]},
									{g, ng}]]];

				If[(outputfile == 1),		Do[	WriteString[resmodelfile, gennames[[g]] <> "\n\n"];	
									Export[resmodelfile, Transpose[hres[[scen, g]]], "Table"];
									WriteString[resmodelfile, "\n\n"],
									{g, ng}]]

				],

			{scen, Length[hres]}]

		];

	(* ABSOLUTE DIFFERENCES *)

	resnameabs[respopind, diffscen];		

	hprint[drespop, diffscen];

	(* RELATIVE DIFFERENCES *)

	resnamerel[respopind, diffscen];

	hprint[drespop respop /	(respop^2 + eps), diffscen]

	];

(* PRINTS RESULTS: DIFFERENCES BETWEEN (DISCRETE) RISK FACTOR CLASS PREVALENCE NUMBERS *)

printdresrisk[dresrisk_, resrisk_, diffscen_, resriskind_, absind_] := Block[{},

printbug["3.9"];

	hprint[hres_, hdiffscen_] := Block[{},

		Do[	str = scenname[scen, hdiffscen] <> risknames[[riskindd[[r]]]] <> " " <> gennames[[g]];

			If[(outputscreen == 1),		headingprint3[str]];							
			If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];					
			If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];				

			If[(agespecres <= 1),

				(* NO AGE SPECIFICATION *)

				If[(outputscreen == 1),		Print[TableForm[hres[[scen, r, g]]]]];			
				If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[hres[[scen, r, g]] // MatrixForm]],
									"Subsection"]]];	
				If[(outputfile == 1),		Export[resmodelfile, hres[[scen, r, g]], "Table"];			
								WriteString[resmodelfile, "\n\n"]],

				(* SPECIFIED BY AGE CLASS *)

				If[(outputscreen == 1),		Do[	Print[ToString[ri]];				
									Print[TableForm[Transpose[hres[[scen, r, g, ri]]]]],
									{ri, ncrsel[[r]]}]];

				If[(outputnotebook == 1),	addcellnb[Table[
									{headingprint3nb[ToString[ri]],				
									Cell[BoxData[ToBoxes[Transpose[hres[[scen, r, g, ri]]] //
										MatrixForm]], "Subsection"]},
									{ri, ncrsel[[r]]}]]];

				If[(outputfile == 1),		Do[	WriteString[resmodelfile, ToString[ri] <> "\n\n"];	
									Export[resmodelfile, Transpose[hres[[scen, r, g, ri]]], "Table"];
									WriteString[resmodelfile, "\n\n"],
									{ri, ncrsel[[r]]}]]

				],

			{scen, Length[hres]}, {r, nrd}, {g, ng}]

		];


	(* ABSOLUTE DIFFERENCES *)

	resnameabs[resriskind];

	hprint[dresrisk, diffscen];
		
	(* RELATIVE DIFFERENCES IF ALLOWED (absind == 1) *)

	hprint[dresrisk resrisk / (resrisk^2 + eps)]
	
	];

(* PRINTS RESULTS: DIFFERENCES BETWEEN (CONTINUOUS) RISK FACTOR CLASS DISTRIBUTION CHARACTERISTICS *)

printdresdist[dresdist_, resdist_, diffscen_, resdistind_, absind_] := Block[{},

printbug["3.11"];

	hprint[hres_, hdiffscen_] := Block[{},

		Do[	str = scenname[scen, hdiffscen] <> risknames[[riskindc[[r]]]] <> " " <> gennames[[g]];

			If[(outputscreen == 1),		headingprint3[str]];							
			If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];					
			If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];				

			If[(agespecres <= 1),

				(* NO AGE SPECIFICATION *)

				If[(outputscreen == 1),		Print[TableForm[hres[[scen, r, g]]]]];			
				If[(outputnotebook == 1),	addcellnb[Cell[BoxData[ToBoxes[hres[[scen, r, g]] // MatrixForm]],
									"Subsection"]]];	
				If[(outputfile == 1),		Export[resmodelfile, hres[[scen, r, g]], "Table"];			
								WriteString[resmodelfile, "\n\n"]],

				(* SPECIFIED BY AGE CLASS *)

				If[(outputscreen == 1),		Do[	Print[ToString[ri]];				
									Print[TableForm[Transpose[hres[[scen, r, g, ri]]]]],
									{ri, 2}]];

				If[(outputnotebook == 1),	addcellnb[Table[
									{headingprint3nb[ToString[ri]],				
									Cell[BoxData[ToBoxes[Transpose[hres[[scen, r, g, ri]]] //
										MatrixForm]], "Subsection"]},
									{ri, 2}]]];

				If[(outputfile == 1),		Do[	WriteString[resmodelfile, ToString[ri] <> "\n\n"];	
									Export[resmodelfile, Transpose[hres[[scen, r, g, ri]]], "Table"];
									WriteString[resmodelfile, "\n\n"],
									{ri, 2}]]

				],

			{scen, Length[hres]}, {r, nrc}, {g, ng}]

		];

	(* ABSOLUTE DIFFERENCES *)

	resnameabs[resdistind];

	hprint[dresdist, diffscen];

	(* RELATIVE DIFFERENCES IF ALLOWED (absind == 1) *)

	hprint[dresdist resdist / (resdist^2 + eps), diffscen];

	];

(* PRINTS RESULTS: DIFFERENCES BETWEEN DISEASE (PREVALENCE, INCIDENCE, MORTALITY) NUMBERS *)

printdresdis[dresdis_, resdis_, diffscen_, resdisind_, absind_]:= Block[{},

printbug["3.12"];

	hprint[hres_, hdiffscen_] := Block[{},

		Do[	str = scenname[scen, hdiffscen] <> mortnames[[d]];

			If[(outputscreen == 1),		headingprint3[str]];							
			If[(outputnotebook == 1),	addcellnb[headingprint3nb[str]]];					
			If[(outputfile == 1),		WriteString[resmodelfile, str <> "\n\n"]];				

			If[(agespecres <= 1),

				(* NO AGE SPECIFICATION *)

				If[(outputscreen == 1),		Print[TableForm[hres[[scen, d]]]]];			
				If[(outputnotebook == 1),	addcellnb[Cell[BoxesData[ToBoxes[hres[[scen, d]] // MatrixForm]],
									"Subsection"]]];

				If[(outputfile == 1),		Export[resmodelfile, hres[[scen, d]], "Table"];		
								WriteString[resmodelfile, "\n\n"]],

				(* SPECIFIED BY AGE CLASS *)

				If[(outputscreen == 1),		Do[	Print[gennames[[g]]];				
									Print[TableForm[Transpose[hres[[scen, d, g]]]]],
									{g, ng}]];

				If[(outputnotebook == 1),	addcellnb[Table[
									{headingprint3nb[gennames[[g]]],														Cell[BoxesData[ToBoxes[Transpose[hres[[scen, d, g]]] //
										MatrixForm]], "Subsection"]},
									{g, ng}]]];

				If[(outputfile == 1),		Do[	WriteString[resmodelfile, gennames[[g]] <> "\n\n"];	
									Export[resmodelfile, Transpose[hres[[scen, d, g]]], "Table"];
									WriteString[resmodelfile, "\n\n"],
									{g, ng}]];

				],

			{scen, Length[hres]}, {d, Length[hres[[1]]]}]

		];

	(* ABSOLUTE DIFFERENCES *)

	resnameabs[resdisind];

	hprint[dresdis, diffscen];

	(* RELATIVE DIFFERENCES IF ALLOWED (absind == 1) *)

	hprint[dresdis resdis / (resdis^2 + eps), diffscen]
	
	];


(*-------------------------------------------------
	PRESENTING ROUTINE FOR EVENT NUMBERS FOR EACH MODEL TYPE 
---------------------------------------------------*)

printbug["4."];

presentnumbers[resmodel_, diffscen_] := Block[{},

	(* TOTAL POPULATION NUMBERS *)

printbug["4.1"];

	hnpop0		= makenpopagg[resmodel[[1]], 0];
	standardnpop	= Table[Plus@@hnpop0[[scen, g, 1]], {scen, nscen0}, {g, ng}];

	(* DISCRETELY DISTRIBUTED RISK FACTOR CLASS PREVALENCE NUMBERS *)

printbug["4.2"];

	hnrisk0		= makenrisk[resmodel[[2]], 0];
	hprisk0		= Table[hnrisk0[[scen, r, g, ri]] / (Plus@@hnrisk0[[scen, r, g]] + eps),
				{scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}];
	standardnrisk	= Table[Plus@@hnrisk0[[scen, r, g, ri, 1]], {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}];

	(* DISEASE PREVALENCE NUMBERS *)

printbug["4.3"];

	hndis0		= makendis[resmodel[[4]], 0];
	
	(* TOTAL POPULATION NUMBERS *)

	If[(outputsel[[1]] == 1),

printbug["4.4"];

		npop	= makenpop[resmodel, diffscen];
		npop	= npopdiscount[npop, diffscen, discounte, standardnpop];

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

printbug["4.4.1"];

			If[(outputscreen == 1), plotpop[npop, outputnames[[1]], diffscen]];

			If[(outputnotebook == 1),
				addcellnb[plotpopnb[npop, outputnames[[1]], diffscen]];
				If[(cumulative == 1),
					hnpop = If[(agespecres <= 1),
							Table[npop[[scen, g, nstap]], {scen, Length[npop]}, {g, ng}],
							Table[Plus@@npop[[scen, g, nstap]], {scen, Length[npop]}, {g, ng}]
							];
					addcellnb[Cell[BoxData[ToBoxes[hnpop]], "Subsection"]]
					]
				]
			];

		(* TABEL OUTPUT *)

		If[(tabeloutput == 1), 

printbug["4.4.2"];

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[1]] <> "\n\n"]];
			printrespop[npop, diffscen]]

		];

	(* DISCRETELY DISTRIBUTED RISK FACTOR CLASS PREVALENCE NUMBERS *)

	If[(nrd > 0) && (outputsel[[2]] == 1),

printbug["4.5"];

		nrisk 	= If[(diffscen == 0),
				hnrisk0,
				makenrisk[resmodel[[2]], diffscen]
				];

		If[(rates == 0) && (diffscen == 0), nrisk = nrisk[[{1}]]];
		If[(rates == 1) && (diffscen == 0), nrisk = hprisk0[[{1}]]];
		If[(rates == 1) && (diffscen == 1), nrisk = Drop[hprisk0, 1] - Table[hprisk0[[1]], {nscen0 - 1}]];

		If[(standardized == 1),
			nrisk = Table[nrisk[[scen, r, g, ri, n]] / standardnrisk[[scen, r, g, ri]],
					{scen, Length[nrisk]}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]];

		If[(discounte > eps),
			nrisk = Table[nrisk[[scen, r, g, ri, n]] / (1 + discounte)^(n - 1),
					{scen, Length[nrisk]}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]];

		If[(cumulative == 1),
			nrisk = Table[Plus@@nrisk[[scen, r, g, ri, Range[n]]],
					{scen, Length[nrisk]}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]];

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),
	
			If[(outputscreen == 1), plotrisk[nrisk, outputnames[[2]], diffscen]];
			If[(outputnotebook == 1), addcellnb[plotrisknb[nrisk, outputnames[[2]], diffscen]]]];

		(* TABEL OUTPUT *)

		If[(tabeloutput == 1),

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[2]] <> ratesstr <> "\n\n"]];
			printresrisk[nrisk, diffscen]]		

		];

	(* CONTINUOUSLY DISTRIBUTED RISK FACTOR DISTRIBUTION CHARACTERISTICS *)

	If[(riskcontind == 1) && (nrc > 0) && (outputsel[[3]] == 1),

printbug["4.6"];

		dist	= makedist[resmodel[[3]], 0];

		dist	= Table[dist[[scen, r, g, ri]] / (hnpop0[[scen, g]] + eps), {scen, nscen0}, {r, nrc}, {g, ng}, {ri, 2}];

		If[(diffscen == 0), dist = dist[[{1}]]];

		If[(diffscen == 1), dist = Drop[dist, 1] - Table[dist[[1]], {nscen0 - 1}]];

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1), If[(outputnotebook == 1), addcellnb[plotdistnb[dist, outputnames[[3]], diffscen]]]];

		(* TABEL OUTPUT *)

		If[(tabeloutput == 1),

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[3]] <> "\n\n"]];
			printresdist[dist, diffscen]]

		];

	(* DISEASE DATA *)

	hmakendis[outputnr_, ndis0_, pdis0_] := Block[{},

printbug["4.7"];

		ndis = If[(diffscen == 0),
				ndis0,
				makendis[resmodel[[outputnr]], diffscen]
				];

		If[(rates == 0) && (diffscen == 0), ndis = ndis[[{1}]]];
		If[(rates == 1) && (diffscen == 0), ndis = pdis0[[{1}]]];
		If[(rates == 1) && (diffscen == 1), ndis = Drop[pdis0, 1] - Table[pdis0[[1]], {nscen0 - 1}]];

		If[(standardized == 1),
			ndis = Table[ndis[[scen, d, g, n]] / standardnpop[[scen, g]],
					{scen, Length[ndis]}, {d, Length[ndis[[1]]]}, {g, ng}, {n, nstap}]];

		If[(discounte > eps),
			ndis = Table[ndis[[scen, d, g, n]] / (1 + discounte)^(n - 1),
					{scen, Length[ndis]}, {d, Length[ndis[[1]]]}, {g, ng}, {n, nstap}]];

		If[(cumulative == 1),
			ndis = Table[Plus@@ndis[[scen, d, g, Range[n]]],
					{scen, Length[ndis]}, {d, Length[ndis[[1]]]}, {g, ng}, {n, nstap}]];

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputscreen == 1), plotdis[ndis, outputnames[[outputnr]], diffscen]];
			If[(outputnotebook == 1), addcellnb[plotdisnb[ndis, outputnames[[outputnr]], diffscen]]]];

		(* TABEL OUTPUT *)

		If[(tabeloutput == 1),

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[outputnr]] <> ratesstr <> "\n\n"]];
			printresdis[ndis, diffscen]]		

		];

	(* DISEASE PREVALENCE NUMBERS *)

	If[(nd > 0) && (outputsel[[4]] == 1),

printbug["4.8"];

		hpdis0 = Table[hndis0[[scen, d]] / (hnpop0[[scen]] + eps), {scen, nscen0}, {d, nd}];

		hmakendis[4, hndis0, hpdis0]];
		
	(* DISEASE INCIDENCE NUMBERS *)

	If[(nd > 0) && (outputsel[[5]] == 1),

printbug["4.9"];

		hninc0 = makendis[resmodel[[5]], 0];

		hpinc0 = Table[hninc0[[scen, d]] / (hnpop0[[scen]] + eps), {scen, nscen0}, {d, nd}];

		hmakendis[5, hninc0, hpinc0]];

	(* DISEASE MORTALITY NUMBERS *)

	If[(outputsel[[6]] == 1),

printbug["4.10"];

		hnmort0 = makendis[resmodel[[6]], 0];

		hpmort0 = Table[hnmort0[[scen, d]] / (hnpop0[[scen]] + eps), {scen, nscen0}, {d, nd + 2}];

		hmakendis[6, hnmort0, hpmort0]];
	
	(* MEAN AGE AT DISEASE ONSET *)

	If[(nd > 0) && (outputsel[[7]] == 1),

printbug["4.11"];

		onsetage = makendis[resmodel[[7]], 0] / hndis0;

		onsetage = makeresdiff[onsetage];

		If[(diffscen == 0), onsetage = onsetage[[{1}]]];

		If[(graphicoutput == 1),

			If[(outputscreen == 1), plotdis[onsetage, outputnames[[7]], diffscen]];
			If[(outputnotebook == 1), addcellnb[plotdisnb[onsetage, outputnames[[7]], diffscen]]]];

		If[(tabeloutput == 1),

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[7]] <> "\n\n"]];
			printresdis[onsetage, diffscen]]	

		];
	
	(* MEAN TIME SINCE SMOKING CESSATION *)

	If[(RRsmokduurind == 1) && (outputsel[[8]] == 1),

printbug["4.12"];

		duurstop = makenpopagg[resmodel[[8]], 0] / (hnrisk0[[Range[nscen0], 1, Range[ng], 3]] + eps);

		duurstop = makeresdiff[duurstop, diffscen];

		If[(diffscen == 0), duurstop = duurstop[[{1}]]];

		(* GRAPHICAL OUTPUT *)
		
		If[(graphicoutput == 1),

			If[(outputscreen == 1), plotpop[duurstop, outputnames[[8]], diffscen]];
			If[(outputnotebook == 1), addcellnb[plotpopnb[duurstop, outputnames[[8]], diffscen]]]];

		(* TABEL OUTPUT *)

		If[(tabeloutput == 1),

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[8]] <> "\n\n"]];
			printrespop[duurstop, diffscen]];

		];

	(* CURRENT COSTS *)

	If[(outputsel[[9]] == 1),

printbug["4.13"];
		
		ncosts 	= makencosts[resmodel];

		ncosts	= ncostsdiscount[ncosts, discounte, standardnpop];		

		plusncosts = If[(agespecres <= 1),

			(* AGGREGATED OVER AGE *)

			Table[Plus@@ncosts[[scen, d, g, n]], {scen, nscen0}, {d, nd + 2}, {g, ng}, {n, nstap}],

			(* SPECIFIED BY AGE CLASS *)

			Table[aggregc[ncosts[[scen, d, g, n]], 1, 7], {scen, nscen0}, {d, nd + 2}, {g, ng}, {n, nstap}]];
	
		plusncosts = makeresdiff[plusncosts, diffscen];

		If[(diffscen == 0), plusncosts = plusncosts[[{1}]]];

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputscreen == 1), plotdis[plusncosts, outputnames[[9]], diffscen]];
			If[(outputnotebook == 1), addcellnb[plotdisnb[plusncosts, outputnames[[9]], diffscen]]]];

		(* TABEL OUTPUT *)

		If[(tabeloutput == 1),

			If[(outputfile == 1), WriteString[resmodelfile, outputnames[[9]] <> "\n\n"]];
			printresdis[plusncosts, diffscen]];

		];
	
]; (* END PRESENTNUMBERS *)


(*-------------------------------------------------
	PLOTTING ROUTINE FOR EVENT NUMBERS (EXCL LE) FOR COMPARING MODEL TYPES 
---------------------------------------------------*)

printbug["5."];


absname[t_] := "absolute differences for " <> outputnames[[t]];
relname[t_] := "relative differences for " <> outputnames[[t]];


presentdiffnumbers[resmodel_, diffscen_] := Block[{},

	(* TOTAL POPULATION NUMBERS *)

printbug["5.1"];

	npop10	= Table[makenpopagg[resmodel[[m, 1]], 0], {m, Plus@@modelsel}];
	standardnpop1 = Table[Plus@@npop10[[m, scen, g, 1]], {m, Plus@@modelsel}, {scen, nscen0}, {g, ng}];

	(* DISCRETELY DISTRIBUTED RISK FACTOR CLASS PREVALENCE NUMBERS *)

printbug["5.2"];

	nrisk10	= Table[makenrisk[resmodel[[m, 2]], 0], {m, Plus@@modelsel}];
	prisk10	= Table[nrisk10[[m, scen, r, g, ri]] / (Plus@@nrisk10[[m, scen, r, g]] + eps),
				{m, Plus@@modelsel}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}];
	standardnrisk1 = Table[Plus@@nrisk10[[m, scen, r, g, ri, 1]],
				{m, Plus@@modelsel}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}];

	(* DISEASE PREVALENCE NUMBERS *)

printbug["5.3"];

	ndis10	= Table[makendis[resmodel[[m, 4]], 0], {m, Plus@@modelsel}];
	
	(* TOTAL POPULATION NUMBERS *)

	If[(outputsel[[1]] == 1),

printbug["5.4"];

		npop1	= Table[makenpop[resmodel[[m]], diffscen], {m, Plus@@modelsel}];

printbug["5.4.1"];
		
		npop1	= Table[npopdiscount[npop1[[m]], diffscen, discounte, standardnpop1[[m]]], {m, Plus@@modelsel}];

printbug["5.4.2"];
		
		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputnotebook == 1), addcellnb[plotpopnb1[npop1, outputnames[[1]], diffscen]]]]

		];

	(* DISCRETELY DISTRIBUTED RISK FACTOR CLASS PREVALENCE NUMBERS *)

	If[(nrd > 0) && (outputsel[[2]] == 1),

printbug["5.5"];

		nrisk1 	= If[(diffscen == 0), nrisk10, Table[makenrisk[resmodel[[m, 2]], diffscen], {m, Plus@@modelsel}]];

printbug["5.5.1"];
		
		If[(rates == 0) && (diffscen == 0), nrisk1 = Table[nrisk1[[m, {1}]], {m, Plus@@modelsel}]];
printbug["5.5.1.1"];
		If[(rates == 1) && (diffscen == 0), nrisk1 = Table[prisk10[[m, {1}]], {m, Plus@@modelsel}]];
printbug["5.5.1.2"];
		If[(rates == 1) && (diffscen == 1),
			nrisk1 = Table[prisk10[[m, scen]] - prisk10[[m, 1]], {m, Plus@@modelsel}, {scen, 2, nscen0}]];

printbug["5.5.2"];
			
		If[(standardized == 1),
			nrisk1 = Table[nrisk1[[m, scen, r, g, ri, n]] / standardnrisk1[[m, scen, r, g, ri]],
					{m, Plus@@modelsel}, {scen, Length[nrisk1[[m]]]}, {r, nrd}, {g, ng},
					{ri, ncrsel[[r]]}, {n, nstap}]];

printbug["5.5.3"];			

		If[(discounte > eps),
			nrisk1 = Table[nrisk1[[m, scen, r, g, ri, n]] / (1 + discounte)^(n - 1),
					{m, Plus@@modelsel}, {scen, Length[nrisk1[[m]]]}, {r, nrd}, {g, ng},
					{ri, ncrsel[[r]]}, {n, nstap}]];

printbug["5.5.4"];			

		If[(cumulative == 1),
			nrisk1 = Table[Plus@@nrisk1[[m, scen, r, g, ri, Range[n]]],
					{m, Plus@@modelsel}, {scen, Length[nrisk1[[m]]]}, {r, nrd}, {g, ng},
					{ri, ncrsel[[r]]}, {n, nstap}]];

printbug["5.5.5"];			

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputnotebook == 1), addcellnb[plotrisknb1[nrisk1, outputnames[[2]], diffscen]]]]

		];

	(* CONTINUOUSLY DISTRIBUTED RISK FACTOR DISTRIBUTION CHARACTERISTICS *)

printbug["5.6"];

	If[(riskcontind == 1) && (nrc > 0) && (outputsel[[3]] == 1), _];

	(* DISEASE DATA *)

	hmakendis[outputnr_, ndis10_, pdis10_] := Block[{},

printbug["5.7"];

		ndis1 = If[(diffscen == 0), ndis10, Table[makendis[resmodel[[m, outputnr]], diffscen], {m, Plus@@modelsel}]];

printbug["5.7.1"];	

		If[(rates == 0) && (diffscen == 0), ndis1 = Table[ndis1[[m, {1}]], {m, Plus@@modelsel}]];
		If[(rates == 1) && (diffscen == 0), ndis1 = Table[pdis10[[m, {1}]], {m, Plus@@modelsel}]];
		If[(rates == 1) && (diffscen == 1),
			ndis1 = Table[pdis10[[m, scen]] - pdis10[[m, 1]], {m, Plus@@modelsel}, {scen, 2, nscen0}]];

printbug["5.7.2"];
			
		If[(standardized == 1),
			ndis1 = Table[ndis1[[m, scen, d, g, n]] / standardnpop1[[m, scen, g]],
					{m, Plus@@modelsel}, {scen, Length[ndis1[[1]]]}, {d, Length[ndis1[[1, 1]]]}, {g, ng}, {n, nstap}]];

printbug["5.7.3"];
			
		If[(discounte > eps),
			ndis1 = Table[ndis1[[m, scen, d, g, n]] / (1 + discounte)^(n - 1),
					{m, Plus@@modelsel}, {scen, Length[ndis1[[1]]]}, {d, Length[ndis1[[1, 1]]]}, {g, ng}, {n, nstap}]];

printbug["5.7.4"];

		If[(cumulative == 1),
			ndis1 = Table[Plus@@ndis1[[m, scen, d, g, Range[n]]],
					{m, Plus@@modelsel}, {scen, Length[ndis1[[1]]]}, {d, Length[ndis1[[1, 1]]]}, {g, ng}, {n, nstap}]];

printbug["5.7.5"];			

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputnotebook == 1), addcellnb[plotdisnb1[ndis1, outputnames[[outputnr]], diffscen]]]]
				
		];

	(* DISEASE PREVALENCE NUMBERS *)

	If[(nd > 0) && (outputsel[[4]] == 1),

printbug["5.8"];
		pdis10 = Table[ndis10[[m, scen, d]] / (npop10[[m, scen]] + eps), {m, Plus@@modelsel}, {scen, nscen0}, {d, nd}];
			
		hmakendis[4, ndis10, pdis10]];
		
	(* DISEASE INCIDENCE NUMBERS *)

	If[(nd > 0) && (outputsel[[5]] == 1),

printbug["5.9"];

		ninc10 = Table[makendis[resmodel[[m, 5]], 0], {m, Plus@@modelsel}];
		pinc10 = Table[ninc10[[m, scen, d]] / (npop10[[m, scen]] + eps), {m, Plus@@modelsel}, {scen, nscen0}, {d, nd}];

		hmakendis[5, ninc10, pinc10]];

	(* DISEASE MORTALITY NUMBERS *)

	If[(outputsel[[6]] == 1),

printbug["5.10"];

		nmort10 = Table[makendis[resmodel[[m, 6]], 0], {m, Plus@@modelsel}];
		pmort10 = Table[nmort10[[m, scen, d]] / (npop10[[m, scen]] + eps), {m, Plus@@modelsel}, {scen, nscen0}, {d, nd + 2}];

		hmakendis[6, nmort10, pmort10]];
	
	(* MEAN AGE AT DISEASE ONSET *)

	If[(nd > 0) && (outputsel[[7]] == 1),

printbug["5.11"];

		onsetage1 = Table[makendis[resmodel[[m, 7]], 0], {m, Plus@@modelsel}] / ndis10;
		
		onsetage1 = Table[makeresdiff[onsetage1[[m]]], {m, Plus@@modelsel}];
		
		If[(diffscen == 0), onsetage1 = Table[onsetage1[[m, {1}]], {m, Plus@@modelsel}]];

		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputnotebook == 1), addcellnb[plotdisnb1[onsetage, outputnames[[7]], diffscen]]]]

		];
	
	(* MEAN TIME SINCE SMOKING CESSATION *)

	If[(RRsmokduurind == 1) && (outputsel[[8]] == 1),

printbug["5.12"];

		duurstop1 = Table[makenpop0[resmodel[[m, 8]], 0] / (nrisk10[[m, Range[nscen0], 1, Range[ng], 3]] + eps), {m, Plus@@modelsel}];
		
		duurstop1 = Table[makeresdiff[duurstop1[[m]], diffscen], {m, Plus@@modelsel}];
		
		If[(diffscen == 0), duurstop1 = Table[duurstop1[[m, {1}]], {m, Plus@@modelsel}]];
				
		(* GRAPHICAL OUTPUT *)

		If[(graphicoutput == 1),

			If[(outputnotebook == 1), addcellnb[plotpopnb1[duurstop, outputnames[[8]], diffscen]]]];

		];

]; (* END PRESENTDIFFNUMBERS *)


(* --------------------------------------------------
	PLOTTING RESULTS FOR EACH CZM MODEL VERSION SELECTED
----------------------------------------------------*)

printbug["6."];

eachname1[m_] 	:= Block[{},

			str = modelnames[[m]] <> basescenstr;
			If[(outputscreen == 1), 			headingprint1[str]];
			If[(outputnotebook == 1), 			addcellnb[headingprint1nb[str]]];
			If[(outputfile ==1) && (tabeloutput == 1),	WriteString[resmodelfile, str <> "\n\n"]]];

diffname1[m_] 	:= Block[{},

			str = modelnames[[m]] <> compscenstr;
			If[(outputscreen == 1), 			headingprint1[str]];
			If[(outputnotebook == 1), 			addcellnb[headingprint1nb[str]]];
			If[(outputfile ==1) && (tabeloutput == 1),	WriteString[resmodelfile, str <> "\n\n"]]];


(* --------------------------------------------------
	PLOTTING RESULTS FOR EACH PAIR OF CZM MODEL VERSIONS SELECTED
----------------------------------------------------*)

eachname2[m1_, m2_] := Block[{},

			str = "differences between " <> modelnames[[m1]] <> " and " <> modelnames[[m2]] <>
				" for baseline scenario";
			If[(outputscreen == 1),				headingprint1[str]];
			If[(outputnotebook == 1),			addcellnb[headingprint1nb[str]]];
			If[(outputfile ==1) && (tabeloutput == 1),	WriteString[resmodelfile, str <> "\n\n"]]];
	
diffname2[m1_, m2_] := Block[{},

			str = "differences between " <> modelnames[[m1]] <> " and " <> modelnames[[m2]] <>
				"differences with baseline scenario";
			If[(outputscreen == 1),				headingprint1[str]];
			If[(outputnotebook == 1),			addcellnb[headingprint1nb[str]]];
			If[(outputfile ==1) && (tabeloutput == 1),	WriteString[resmodelfile, str <> "\n\n"]]];


(* --------------------------------------------------
	CONCATENATION OF NOTEBOOK CELLS
----------------------------------------------------*)

addcellnb[cell_] := Block[{}, cellnb = Flatten[{cellnb, cell}]];


(* --------------------------------------------------
	RISK FACTOR CLASS AND DISEASE PREVALENCE NUMBERS CONDITIONAL ON DISEASE
----------------------------------------------------*)

printbug["7."];
(* GENERATES RISK FACTOR CLASS PREVALENCE RATES WITHIN DISEASED PATIENTS FROM MARGINAL MODEL ON TOTAL POPULATION *)

makeresriskdis0[dat_] := Block[{},

printbug["7.1"];

	(* POPULATION NUMBERS TOTAL AND SPECIFIED BY AGE CLASS *)

printbug["7.1.1"];

	hnpop		= Table[Plus@@dat[[1, scenlist[[scen]], n, g]], {scen, nscen0}, {g, ng}, {n, nstap}];

	meanhnpop	= Table[aggregc[hnpop[[scen, g, n]], 1, 7], {scen, nscen0}, {g, ng}, {n, nstap}];


	(* CALCULATED RISK FACTOR CLASS PREVALENCE NUMBERS AND DATA FOR HBA1C *)

printbug["7.1.2"];

	hprisk 		= Table[Plus@@dat[[2, scenlist[[scen]], n, r, g, ri]] /
					(Plus@@(Plus@@dat[[2, scenlist[[scen]], n, r, g]]) + eps),
				{scen, nscen0}, {n, nstap}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}];

	hprisksel 	= Table[meanaggreg[prisksel[[r, g, ri]]],
				{r, nrdpop + 1, nrdpop + nrddis}, {g, ng}, {ri, ncrsel[[r]]}];

	(* CALCULATED DISEASE PREVALENE RATES *)

printbug["7.1.3"];

	hpdis		= Table[Plus@@dat[[4, scenlist[[scen]], n, d, g]] / (Plus@@dat[[1, scenlist[[scen]], n, g]] + eps),
				{scen, nscen0}, {n, nstap}, {d, nd}, {g, ng}];

	(* RELATIVE RISK VALUES *)

printbug["7.1.4"];

	meanRRrisk	= Table[meanaggreg[RRriskseladj[[r, RRriskindsel[[r, d + 1]], g, ri]]],
				{r, nrd}, {d, nd}, {g, ng}, {ri, ncrsel[[r]]}];

	meanRRdis	= Table[meanaggreg[RRdisadj[[RRdisindsel[[d, d1]], g]]], {d, nd}, {d1, nd}, {g, ng}];

	meanERRrisk	= Table[Plus@@(meanRRrisk[[r, d, g]] hprisk[[scen, n, r, g]]),
				{scen, nscen0}, {n, nstap}, {r, nrd}, {d, nd}, {g, ng}];

	(* PAIRS OF RISK FACTORS AND DISEASES RELATED, SUCH AS HBA1C AND DIABETES *)

printbug["7.1.5"];

	hriskdispair	= Transpose[{riskindddis, disindinv[[disriskindddis]]}];

	resrisk		= Table[0, {nd}, {nscen0}, {r, nrd}, {ng}, {ncrsel[[r]]}, {nstap}];

	(* ADJUSTMENT OF RISK FACTOR VALUES *)

printbug["7.1.6"];
	
	Do[	(* RISK FACTORS WORKING IN TOTAL POPULATION *)
			
		If[Not[MemberQ[riskindddis, r]],

			(* ADJUSTMENT FOR CAUSAL RELATION BETWEEN RISK FACTOR AND DISEASE *)

			hpriskadj	= hprisk[[Range[nscen0], Range[nstap], r]];

			Do[	hadj	= meanRRrisk[[r, d, g, ri]];

				Do[hpriskadj[[scen, n, g, ri]] *= hadj, {scen, nscen0}, {n, nstap}],

				{g, ng}, {ri, 1,ncrsel[[r]]}];

			(* ADJUSTMENT FOR INTERMEDIATE DISEASES *)

			hadj = Times@@Table[1 + (meanRRdis[[d1, d, g]] - 1) (meanRRrisk[[r, d, g, ri]] - 1) hpdis[[scen, n, d1, g]] /
						(meanERRrisk[[scen, n, r, d1, g]] + (meanRRdis[[d1, d, g]] - 1) hpdis[[scen, n, d1, g]] +
							eps),
						{d1, nd}, {scen, nscen0}, {n, nstap}, {g, ng}, {ri, ncrsel[[r]]}];

			Do[hpriskadj[[scen, n, g, ri]] *= hadj[[scen, n, g, ri]], {scen, nscen0}, {n, nstap}, {g, ng}, {ri, ncrsel[[r]]}];
			(* SCALING *)

	        	hpriskadj = Table[hpriskadj[[scen, n, g, ri]] / (Plus@@hpriskadj[[scen, n, g]] + eps),
					{scen, nscen0}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}];

			(* VALUE AVERAGED OVER TOTAL POPULATION OR SPECIFIED BY AGE CLASS *)

			If[(agespecres <= 1),

				(* VALUES AVERAGED OVER TOTAL POPULATION *)

				Do[resrisk[[d, scen, r, g, ri, n]] = Plus@@(hpriskadj[[scen, g, ri, n]] hnpop[[scen, g, n]]) /
										Plus@@hnpop[[scen, g, n]],
					{scen, nscen0}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],

				(* VALUES SPECIFIED BY AGE CLASS *)

				Do[resrisk[[d, scen, r, g, ri, n]] = aggregc[hpriskadj[[scen, g, ri, n]] hnpop[[scen, g, n]], 1, 7] /
										(meanhnpop[[scen, g, n]] + eps),
					{scen, nscen0}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]

				]

			];

		(* RISK FACTOR DISTRIBUTION WITHIN RELATED DISEASE, E.G. HBA1C WITHIN DIABETICS *)			

		If[MemberQ[hriskdispair, {r, d}],

			If[(agespecres <= 1),

				(* VALUES AVERAGED OVER TOTAL POPULATION *)

				Do[resrisk[[d, scen, r, g, ri, n]] =
					Plus@@Flatten[dat[[2, scenlist[[scen]], n, r, g, ri]]] /
						(Plus@@Flatten[dat[[2, scenlist[[scen]], n, r, g]]] + eps),
					{scen, nscen0}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],

				(* VALUES SPECIFIED BY AGE CLASS *)

				Do[resrisk[[d, scen, r, g, ri, n]] =
					aggregc[Plus@@dat[[2, scenlist[[scen]], n, r, g, ri]], 1, 7] /
						(aggregc[Plus@@(Plus@@dat[[2, scenlist[[scen]], n, r, g]]), 1, 7] + eps),
					{scen, nscen0}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]

				]];

		(* NO RESULTS PRESENTED FOR DISEASE-SPECIFIC RISK FACTORS WITHIN DISEASES OTHER THAN RELATED ONE *)

		If[MemberQ[riskindddis, r] && Not[MemberQ[hriskdispair, {r, d}]] && (agespecres > 1),

			Do[resrisk[[d, scen, r, g, ri, n]] = Table[0, {nac[[7]]}],
				{scen, nscen0}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]],

		{r, nrd}, {d, nd}];

	(* RELATIVE RISK VALUES OF ONE DISEASE ON ANOTHER DISEASE INCIDENCE *)

printbug["7.1.7"];

	hRRdis 	= Table[meanRRdis, {nscen0}, {nstap}];

	(* ADJUSTMENT FOR JOINT RISK FACTORS WORKING ON TOTAL POPULATION *)

printbug["7.1.8"];

	meanRMrisk 	= Table[meanERRrisk[[scen, n, r, d, g]] meanRRrisk[[r, d, g, ri]] / (meanERRrisk[[scen, n, r, d, g]]^2 + eps),
				{scen, nscen0}, {n, nstap}, {r, nrdpop}, {d, nd}, {g, ng}, {ri, ncrsel[[r]]}];

	Do[hRRdis[[scen, n, d, d1, g]] *= Times@@Table[Plus@@(meanRMrisk[[scen, n, r, d, g]] meanRMrisk[[scen, n, r, d1, g]] *
								hprisk[[scen, n, r, g]]),
							{r, nrdpop}],
		{scen, nscen0}, {n, nstap}, {d, nd}, {d1, nd}, {g, ng}];

	(* ADJUSTMENT FOR JOINT RISK FACTORS WORKING WITHIN DISEASE, E.G. HBA1C WITHIN DIABETICS *)

printbug["7.1.8"];

	meanRMrisk = Table[Plus@@(meanRRrisk[[nrdpop + r, d, g]] hprisk[[scen, n, nrdpop + r, g]]) /
					Plus@@(meanRRrisk[[nrdpop + r, d, g]] hprisksel[[r, g]]),
				 {scen, nscen0}, {n, nstap}, {r, nrddis}, {d, nd}, {g, ng}];

printbug["7.1.9"];

	Do[If[(d1 != disindinv[[disriskindddis[[r]]]]),
 
       			Do[hRRdis[[scen, n, disindinv[[disriskindddis[[r]]]], d1, g]] *=
					(1 + hpdis[[scen, n, disindinv[[disriskindddis, r]], g]] (meanRMrisk[[scen, n, r, d1, g]] - 1)),
				{scen, nscen0}, {n, nstap}, {g, ng}]],

		{r, nrddis}];

	If[(agespecres <= 1),

		(* VALUES AVERAGED OVER TOTAL POPULATION *)

printbug["7.1.10"];

		resdis = Table[Plus@@(hpdis[[scen, n, d1, g]] hnpop[[scen, g, n]] *
				If[(d1 == d),
					1,
					hRRdis[[scen, n, d, d1, g]] / (1 + hpdis[[scen, n, d, g]] (hRRdis[[scen, n, d, d1, g]] - 1))
					]) /
					Plus@@hnpop[[scen, g, n]],
				{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}],

		(* VALUES SPECIFIED BY AGE CLASS *)

printbug["7.1.11"];

		resdis = Table[aggregc[hpdis[[scen, n, d1, g]] hnpop[[scen, g, n]] *
					If[(d1 == d),
						1,
						hRRdis[[scen, n, d, d1, g]] / (1 + hpdis[[scen, n, d, g]] (hRRdis[[scen, n, d, d1, g]] - 1))
						] , 1, 7] /
					aggregc[hnpop[[scen, g, n]], 1, 7],
				{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}]

		];

	(* DISEASE PREVALENCE RATES WITHIN SAME DISEASE EQUALS VALUE 1 *)

printbug["7.1.12"];

	Do[resdis[[d, Range[nscen0], d]] = 1 + 0 resdis[[d, Range[nscen0], d]], {d, nd}];

	{resrisk, resdis}

	]; (* END MAKERESRISKDIS0 *)

(* GENERATES RISK FACTOR CLASS PREVALENCE RATES WITHIN DISEASED PATIENTS FROM JOINT MODELS ON TOTAL POPULATION *)

makeresriskdis1[dat_] := Block[{},

printbug["7.2"];

	resrisk	= Table[0, {nd}, {nscen0}, {r, nrd}, {ng}, {ncrsel[[r]]}, {nstap}];

printbug["7.2.1"];

	Do[	(* STATES OF PERSONS WITH DISEASE d *)

		disset 	= zinddis[[d, 2]];

printbug["7.2.2"];

		Do[	(* STATES OF PERSONS WITH DISEASE d AND IN CLASS ri OF RISK FACTOR r *)

			currdis	= Intersection[zindrisk[[r, ri]], disset];

			Do[	resdis	= If[(agespecres <= 1),

					Plus@@Flatten[dat[[scenlist[[scen]], n, g, disset]]],

					aggregc[Plus@@(Plus@@dat[[scenlist[[scen]], n, g, disset]]), 1, 7]];

				(* PROPORTION OF DISEASED PERSONS IN RISK FACTOR CLASS *)

				resrisk[[d, scen, r, g, ri, n]] = If[(agespecres <= 1),

					Plus@@Flatten[dat[[scenlist[[scen]], n, g, currdis]]],

					aggregc[Plus@@(Plus@@dat[[scenlist[[scen]], n, g, currdis]]), 1, 7]] / (resdis + eps),

				{scen, nscen0}, {g, ng}, {n, nstap}],

			{r, nrd}, {ri, ncrsel[[r]]}],
				
		{d, nd}];

	resrisk

	];

(* GENERATES DISEASE PREVALENCE RATES WITHIN DISEASED PATIENTS FROM JOINT MODELS ON TOTAL POPULATION *)

makeresdisdis1[dat_] := Block[{},

printbug["7.3"];

	resdis	= Table[0, {nd}, {nscen0}, {nd}, {ng}, {nstap}];

printbug["7.3.1"];

	Do[	(* STATES OF PERSONS WITH DISEASE d *)

		disset 	= zinddis[[d, 2]];

printbug["7.3.2"];

		Do[	(* STATES OF PERSONS WITH DISEASE d AND IN DISEASE d1 *)

			currdis	= Intersection[zinddis[[d1, 2]], disset];

			Do[	resdis1	= If[(agespecres <= 1),

					Plus@@Flatten[dat[[scenlist[[scen]], n, g, disset]]],

					aggregc[Plus@@(Plus@@dat[[scenlist[[scen]], n, g, disset]]), 1, 7]];

				(* PROPORTION OF DISEASED PERSONS IN RISK FACTOR CLASS *)

				resdis[[d, scen, d1, g, n]] = If[(agespecres <= 1),

					Plus@@Flatten[dat[[scenlist[[scen]], n, g, currdis]]],

					aggregc[Plus@@(Plus@@dat[[scenlist[[scen]], n, g, currdis]]), 1, 7]] / (resdis1 + eps),

				{scen, nscen0}, {g, ng}, {n, nstap}],

			{d1, nd}],
				
		{d, nd}];

	resdis

	];

(* GENERATES RISK FACTOR CLASS PREVALENCE RATES WITHIN DISEASED PATIENTS FROM JOINT MODELS STRATIFIED BY AGE *)

makeresriskdis2[dat_] := Block[{},

printbug["7.4"];

	(* MARGINAL DISEASE PREVALENCE NUMBERS *)

	resdis	= Table[0, {nd}, {nscen}, {ng}, {nstap}, {na2}];

printbug["7.4.1"];

	Do[	disset	= zinddis[[d, 2]];

		Do[resdis[[d, scen, g, n, agesel[[a1]] + n - 1]] += Plus@@Flatten[dat[[scen, g, a1, n, disset]]],
			{scen, nscen}, {g, ng}, {n, nstap}, {a1, Length[agesel]}],

		{d, nd}];

	resdis	= Table[Plus@@resdis[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];

	resdis	= Table[Flatten[{resdis[[d, scen, g, n, Range[na]]], Plus@@Drop[resdis[[d, scen, g, n]], na]}],
			{d, nd}, {scen, nscen0}, {g, ng}, {n, nstap}];

	(* RISK FACTOR CLASS PREVALENCE NUMBERS WITHIN DISEASED POPULATION *)

printbug["7.4.2"];

	resrisk	= Table[0, {nd}, {nscen}, {r, nrd}, {ng}, {ncrsel[[r]]}, {nstap}, {na2}];

	Do[	disset = Intersection[zinddis[[d, 2]], zindrisk[[r, ri]]];

		Do[resrisk[[d, scen, r, g, ri, n, agesel[[a1]] + n - 1]] += Plus@@Flatten[dat[[scen, g, a1, n, disset]]],
			{scen, nscen0}, {g, ng}, {n, nstap}, {a1, Length[agesel]}],

		{d, nd}, {r, nrd}, {ri, ncrsel[[r]]}];

	resrisk	= Table[Plus@@resrisk[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];

	resrisk	= Table[Flatten[{resrisk[[d, scen, r, g, ri, n, Range[na]]], Plus@@Drop[resrisk[[d, scen, r, g, ri, n]], na]}],
			{d, nd}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}];

	(* TRANSFORMED TO PROPORTIONS *)

printbug["7.4.3"];

	resrisk = If[(agespecres <= 1),

			Table[Plus@@resrisk[[d, scen, r, g, ri, n]] / (Plus@@resdis[[d, scen, g, n]] + eps),
				{d, nd}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],


			Table[aggregc[resrisk[[d, scen, r, g, ri, n]], 1, 7] / (aggregc[resdis[[d, scen, g, n]], 1, 7] + eps),
				{d, nd}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]]
		
	];

(* GENERATES DISEASE PREVALENCE RATES WITHIN DISEASED PATIENTS FROM JOINT MODELS STRATIFIED BY AGE *)

makeresdisdis2[dat_] := Block[{},

printbug["7.5"];

	(* MARGINAL DISEASE PREVALENCE NUMBERS *)

printbug["7.5.1"];

	resdis	= Table[0, {nd}, {nscen}, {ng}, {nstap}, {na2}];

	Do[	disset	= zinddis[[d, 2]];

		Do[resdis[[d, scen, g, n, agesel[[a1]] + n - 1]] += Plus@@Flatten[dat[[scen, g, a1, n, disset]]],
			{scen, nscen}, {g, ng}, {n, nstap}, {a1, Length[agesel]}],

		{d, nd}];

	resdis	= Table[Plus@@resdis[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];

	resdis	= Table[Flatten[{resdis[[d, scen, g, n, Range[na]]], Plus@@Drop[resdis[[d, scen, g, n]], na]}],
			{d, nd}, {scen, nscen0}, {g, ng}, {n, nstap}];

	(* DISEASE PREVALENCE NUMBERS WITHIN DISEASED POPULATION *)

printbug["7.5.2"];

	resdis1	= Table[0, {nd}, {nscen}, {nd}, {ng}, {nstap}, {na2}];

	Do[	disset = Intersection[zinddis[[d, 2]], zinddis[[d1, 2]]];

		Do[resdis1[[d, scen, d1, g, n, agesel[[a1]] + n - 1]] += Plus@@Flatten[dat[[scen, g, a1, n, disset]]],
			{scen, nscen0}, {g, ng}, {n, nstap}, {a1, Length[agesel]}],

		{d, nd}, {d1, nd}];

	resdis1	= Table[Plus@@resdis1[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];

	resdis1	= Table[Flatten[{resdis1[[d, scen, d1, g, n, Range[na]]], Plus@@Drop[resdis1[[d, scen, d1, g, n]], na]}],
			{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}];

	(* TRANSFORMED TO PROPORTIONS *)

printbug["7.5.3"];

	resdis1 = If[(agespecres <= 1),

			Table[Plus@@resdis1[[d, scen, d1, g, n]] / (Plus@@resdis[[d, scen, g, n]] + eps),
				{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}],


			Table[aggregc[resdis1[[d, scen, d1, g, n]], 1, 7] / (aggregc[resdis[[d, scen, g, n]], 1, 7] + eps),
				{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}]]
		
	];

(* GENERATES RISK FACTOR CLASS PREVALENCE RATES WITHIN DISEASED PATIENTS FROM JOINT MODELS STRATIFIED BY INDIVIDUALS *)

makeresriskdis3[dat_] := Block[{},

printbug["7.6"];

	(* MARGINAL DISEASE PREVALENCE NUMBERS *)

printbug["7.6.1"];

	nstap1 	= Table[Plus@@Flatten[Sign[dat[[scen, g, a1, b, 4]]]],
			{scen, nscen}, {g, ng}, {a1, Length[agesel]}, {b, ndraw}] / nz;

	resdis	= Table[0, {nd}, {nscen}, {ng}, {nstap}, {na2}];

	Do[If[(dat[[scen, g, a1, b, 4, n, nrd + d]] == 2), ++resdis[[d, scen, g, n, agesel[[a1]] + n - 1]]],
			{scen, nscen0}, {g, ng}, {a1, Length[agesel]}, {b, ndraw}, {n, nstap1[[scen, g, a1, b]]}, {d, nd}];

	resdis	= Table[Plus@@resdis[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];

	resdis	= Table[Flatten[{resdis[[d, scen, g, n, Range[na]]], Plus@@Drop[resdis[[d, scen, g, n]], na]}],
			{d, nd}, {scen, nscen0}, {g, ng}, {n, nstap}];

	(* RISK FACTOR CLASS PREVALENCE NUMBERS WITHIN DISEASED POPULATION *)

printbug["7.6.2"];

	resrisk	= Table[0, {nd}, {nscen}, {r, nrd}, {ng}, {ncrsel[[r]]}, {nstap}, {na2}];

	Do[If[(dat[[scen, g, a1, b, 4, n, r]] == ri) && (dat[[scen, g, a1, b, 4, n, nrd + d]] == 2),
				++resrisk[[d, scen, r, g, ri, n, agesel[[a1]] + n - 1]]],
			{scen, nscen}, {g, ng}, {a1, Length[agesel]}, {b, ndraw}, {n, nstap1[[scen, g, a1, b]]},
			{r, nrd}, {ri, ncrsel[[r]]}, {d, nd}];

	resrisk	= Table[Plus@@resrisk[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];
 
	resrisk	= Table[Flatten[{resrisk[[d, scen, r, g, ri, n, Range[na]]], Plus@@Drop[resrisk[[d, scen, r, g, ri, n]], na]}],
			{d, nd}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}];

	(* TRANSFORMED TO PROPORTIONS *)

printbug["7.6.3"];

	resrisk = If[(agespecres <= 1),

			Table[Plus@@resrisk[[d, scen, r, g, ri, n]] / (Plus@@resdis[[d, scen, g, n]] + eps),
				{d, nd}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],

			Table[aggregc[resrisk[[d, scen, r, g, ri, n]], 1, 7] / (aggregc[resdis[[d, scen, g, n]], 1, 7] + eps),
				{d, nd}, {scen, nscen0}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]]
		
	];

(* GENERATES DISEASE PREVALENCE RATES WITHIN DISEASED PATIENTS FROM JOINT MODELS STRATIFIED BY INDIVIDUALS *)

makeresdisdis3[dat_] := Block[{},

printbug["7.7"];

	(* MARGINAL DISEASE PREVALENCE NUMBERS *)

printbug["7.7.1"];

	nstap1 	= Table[Plus@@Flatten[Sign[dat[[scen, g, a1, b, 4]]]],
			{scen, nscen}, {g, ng}, {a1, Length[agesel]}, {b, ndraw}] / nz;

	resdis	= Table[0, {nd}, {nscen}, {ng}, {nstap}, {na2}];

	Do[If[(dat[[scen, g, a1, b, 4, n, nrd + d]] == 2), ++resdis[[d, scen, g, n, agesel[[a1]] + n - 1]]],
			{scen, nscen0}, {g, ng}, {a1, Length[agesel]}, {b, ndraw}, {n, nstap1[[scen, g, a1, b]]}, {d, nd}];

	resdis	= Table[Plus@@resdis[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];

	resdis	= Table[Flatten[{resdis[[d, scen, g, n, Range[na]]], Plus@@Drop[resdis[[d, scen, g, n]], na]}],
			{d, nd}, {scen, nscen0}, {g, ng}, {n, nstap}];

	(* RISK FACTOR CLASS PREVALENCE NUMBERS WITHIN DISEASED POPULATION *)

printbug["7.7.2"];

	resdis1	= Table[0, {nd}, {nscen}, {nd}, {ng}, {nstap}, {na2}];

	Do[If[(dat[[scen, g, a1, b, 4, n, nrd + d1]] == 2) && (dat[[scen, g, a1, b, 4, n, nrd + d]] == 2),
				++resdis1[[d, scen, d1, g, n, agesel[[a1]] + n - 1]]],
			{scen, nscen}, {g, ng}, {a1, Length[agesel]}, {b, ndraw}, {n, nstap1[[scen, g, a1, b]]}, {d1, nd}, {d, nd}];

	resdis1	= Table[Plus@@resdis1[[d, scenlist[[scen]]]], {d, nd}, {scen, nscen0}];
 
	resdis1	= Table[Flatten[{resdis1[[d, scen, d1, g, n, Range[na]]], Plus@@Drop[resdis1[[d, scen, d1, g, n]], na]}],
			{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}];
 
	(* TRANSFORMED TO PROPORTIONS *)

printbug["7.7.3"];

	resdis1 = If[(agespecres <= 1),

			Table[Plus@@resdis1[[d, scen, d1, g, n]] / (Plus@@resdis[[d, scen, g, n]] + eps),
				{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}],

			Table[aggregc[resdis1[[d, scen, d1, g, n]], 1, 7] / (aggregc[resdis[[d, scen, g, n]], 1, 7] + eps),
				{d, nd}, {scen, nscen0}, {d1, nd}, {g, ng}, {n, nstap}]]
		
	];

(* RISK FACTOR AND DISEASE RESULTS FOR ANY MODEL *)

makeresriskdis[m_] := Block[{},

printbug["7.8"];

	(* MODEL RESULTS *)

	dat = Switch[m,
			1, resmarginalmodeldetermpop,
			2, Drop[ReadList[Global`outputpath <> "jointmodeldetermpopprev.m"], 1],
			3, Drop[ReadList[Global`outputpath <> "jointmodeldetermageprev.m"], 1],
			4, Drop[ReadList[Global`outputpath <> "jointmodelstochindprev.m"], 1],
			_, {}
			];

	(* RESULTS FROM MODELS ON TOTAL POPULATION *)

	If[(MemberQ[{1}, m]),

printbug["7.8.1"];

		hres	= makeresriskdis0[dat];
		resrisk	= hres[[1]];
		resdis	= hres[[2]]];
		
	If[(MemberQ[{2, 6}, m]),

printbug["7.8.2"];

		dat 	= Partition[dat, nstap];
		resrisk = makeresriskdis1[dat];
		resdis	= makeresdisdis1[dat]];
		
	If[(MemberQ[{3, 7}, m]),

printbug["7.8.3"];

		dat 	= Partition[Partition[Partition[dat, nstap], Length[agesel]], ng];
		resrisk = makeresriskdis2[dat];
		resdis	= makeresdisdis2[dat]];

	If[(MemberQ[{4}, m]),

printbug["7.8.4"];

		dat[[All, 4]] = makezvalinv[dat[[All, 4]]];
		dat 	= Partition[Partition[Partition[dat, ndraw], Length[agesel]], ng];
		resrisk	= makeresriskdis3[dat];
		resdis	= makeresdisdis3[dat]];

	{resrisk, resdis}
			
	];


(* --------------------------------------------------
	CONSTRUCTION OF GRAPHICAL OUTPUT
----------------------------------------------------*)

If[((graphicoutput == 1) || (tabeloutput == 1)) && MemberQ[{0, 3, 4}, analyse],

printbug["9."];

	If[(outputfile == 1),

printbug["9.1"];

		date 		= ToString[Date[][[3]]] <> "-" <> ToString[Date[][[2]]] <> "-" <> ToString[Date[][[1]]];

		time 		= ToString[Date[][[4]]] <> "h" <> ToString[Date[][[5]]];

		resmodeltxt	= Global`outputpath <> "results" <> date <> "_" <> time <> ".txt";

		resmodelfile	= OpenWrite[resmodeltxt]];

	

	If[(outputnotebook == 1), cellnb = {headingprintnb["graphical & tabular results of one model run"]}];

	(* PRESENTING RESULTS FOR EACH CZM MODEL VERSION SELECTED *)

	Do[	If[(modelsel[[m]] == 1),

printbug["9.2"];

			(* RESULTS FOR BASELINE SCENARIO *)

			eachname1[m];
			presentnumbers[resmodel[[m]], 0];

			(* DIFFERENCES WITH BASELINE SCENARIO *)

			If[(nscen0 > 1),
				diffname1[m];
				presentnumbers[resmodel[[m]], 1]]
			],

		{m, nmodel}];
	
	(* PRESENTING RESULTS FOR ALL CZM MODEL VERSIONS SELECTED *)

	hmodelsel = Select[modelsel Range[Length[modelsel]], Positive];

	If[(Length[hmodelsel] > 1),

printbug["9.3"];

			(* RESULTS FOR BASELINE SCENARIO *)
	
			presentdiffnumbers[resmodel[[hmodelsel]], 0];

			(* DIFFERENCES WITH BASELINE SCENARIO *)

			If[(nscen0 > 1), presentdiffnumbers[resmodel[[hmodelsel]], 1]]

		];

	If[(withindisease == 1),

printbug["9.4"];

		Do[	If[(modelsel[[m]] == 1) && (MemberQ[{1, 2, 3, 4}, m]),

printbug["9.4.1"];

				str 	= modelnames[[m]];
				str1[d_] := " within " <> disnames[[disind[[d]]]];
				hres	= makeresriskdis[m];
				resrisk	= hres[[1]];
				resdis 	= hres[[2]];

				(* RESULTS FOR BASELINE SCENARIO *)

				(* GRAPHICAL OUTPUT IN NOTEBOOK *)
				
				If[(outputnotebook == 1),
printbug["9.4.2"];
					addcellnb[headingprint1nb[str]];			
					Do[addcellnb[plotrisknb[resrisk[[d, {1}]], outputnames[[2]] <> str1[d], 0]],	{d, nd}];
					Do[addcellnb[plotdisnb[resdis[[d, {1}]], outputnames[[4]] <> str1[d], 0]], {d, nd}]];

				(* TABEL OUTPUT IN OUTPUTFILE *)

				If[(outputfile == 1) && (tabeloutput == 1),
printbug["9.4.3"];
					WriteString[resmodelfile, str <> "\n\n"];
					Do[	WriteString[resmodelfile, outputnames[[2]] <> str1[d] <> basescenstr <> "\n\n"];
						Do[	WriteString[resmodelfile, risknames[[riskind[[r]]]] <> gennames[[g]] <> "\n\n"];
							Export[resmodelfile, resrisk[[d, 1, r, g]], "Table"];
							WriteString[resmodelfile, "\n\n"],
							{r, nrd}, {g, ng}],
						{d, nd}];

					WriteString[resmodelfile, "\n\n"];
printbug["9.4.4"];
					Do[	WriteString[resmodelfile, outputnames[[4]] <> str1[d] <> basescenstr <> "\n\n"];
						Do[	WriteString[resmodelfile, disnames[[disind[[d1]]]] <> "\n\n"];				
							Export[resmodelfile, resdis[[d, 1, d1]], "Table"];
							WriteString[resmodelfile, "\n\n"],
							{d1, nd}],
						{d, nd}];

					WriteString[resmodelfile, "\n\n"]];
					
				If[(nscen0 > 1),
printbug["9.4.5"];
					(* DIFFERENCES WITH BASELINE SCENARIO *)

					resrisk	= Table[resrisk[[d, scen]] - resrisk[[d, 1]], {d, nd}, {scen, 2, nscen0}];			
					resdis	= Table[resdis[[d, scen]] - resdis[[d, 1]], {d, nd}, {scen, 2, nscen0}];			

					(* GRAPHICAL OUTPUT IN NOTEBOOK *)

					If[(outputnotebook == 1),
printbug["9.4.6"];	
						Do[addcellnb[plotrisknb[resrisk[[d]], outputnames[[2]] <> str1[d], 1]], {d, nd}];
						Do[addcellnb[plotdisnb[resdis[[d]], outputnames[[4]] <> str1[d], 1]], {d, nd}]];

					(* TABEL OUTPUT IN OUTPUTFILE *)

					If[(outputfile == 1) && (tabeloutput == 1),
printbug["9.4.7"];
						Do[	WriteString[resmodelfile, outputnames[[2]] <> str1[d] <> compscenstr <> "\n\n"];
							Do[	WriteString[resmodelfile, risknames[[riskind[[r]]]] <> gennames[[g]] <>
										"\n\n"];
								Export[resmodelfile, resrisk[[d, scen, r, g]], "Table"];
								WriteString[resmodelfile, "\n\n"],
								{r, nrd}, {scen, nscen0 - 1}, {g, ng}],
							{d, nd}];

						WriteString[resmodelfile, "\n\n"];
printbug["9.4.8"];
						Do[	WriteString[resmodelfile, outputnames[[4]] <> str1[d] <> compscenstr <> "\n\n"];
							Do[	WriteString[resmodelfile, disnames[[disind[[d1]]]] <> "\n\n"];
								Export[resmodelfile, resdis[[d, scen, d1]], "Table"];
								WriteString[resmodelfile, "\n\n"],
								{d1, nd}, {scen, nscen0 - 1}],
							{d, nd}];

						WriteString[resmodelfile, "\n\n"]]
						
					] (* NSCEN0>1*)

				],

			{m, nmodel}];

		Do[	If[(modelsel[[m1]] == 1) && (modelsel[[m2]] == 1) && (MemberQ[{1, 2, 3, 4}, m1]) && (MemberQ[{2, 3, 4}, m2]),
printbug["9.4.9"];
				hres 	= makeresriskdis[m2] - makeresriskdis[m1];
				resrisk	= hres[[1]];
				resdis	= hres[[2]];

				(* RESULTS FOR BASELINE SCENARIO *)

				(* GRAPHICAL OUTPUT IN NOTEBOOK *)

				If[(outputnotebook == 1),
printbug["9.4.10"];
					str = modelnames[[m1]] <> " compared to " <> modelnames[[m2]];
					addcellnb[headingprint1nb[str]];			
	
					Do[addcellnb[plotrisknb[resrisk[[d, {1}]],
								outputnames[[2]] <> " within " <> disnames[[disind[[d]]]], 0]],
						{d, nd}]];

				If[(nscen0 > 1),
printbug["9.4.11"];
					(* DIFFERENCES WITH BASELINE SCENARIO *)

					resrisk = Table[resrisk[[d, scen]] - resrisk[[d, 1]], {d, nd}, {scen, 2, nscen0}];

					(* GRAPHICAL OUTPUT IN NOTEBOOK *)
					
					If[(outputnotebook == 1),
	
						Do[addcellnb[plotrisknb[resrisk[[d]],
									outputnames[[2]] <> " within " <> disnames[[disind[[d]]]], 1]],
							{d, nd}]]					

					] (* NSCEN0>1*)

				],

			{m1, nmodel - 1}, {m2, m1 + 1, nmodel}]
		];
	
	If[(outputnotebook == 1), NotebookWrite[nbout, Flatten[cellnb]]]

	];


(* --------------------------------------------------
		Write info to Logfile
----------------------------------------------------*)

(* PACKAGE VERSION *)

version = 3.1;

WriteString[logfile, 
		"\t" <> "Package: " <> StringReplace[Evaluate[Context[]], "`Private`"-> ", " ] 
		<> "version " <> ToString[version] <> "\n\n"];

End[]


Protect[Evaluate[Context[] <> "*"]]


EndPackage[]
(* :Title: CZMSensitivityAnalyses *)

(* :Context: CZMPostProcessing` *)

(* :Author: Rudolf T. Hoogenveen, Roel G.M. Breuls, Maiwenn Al *)

(* :Summary:
   CZM postprocessing routine presents results from sensitivity analyses *)

(* :Copyright: © 2004 by Rudolf Hoogenveen *)

(* :Package Version: 3.1 *)

(* :Mathematica Version: 5.1 *)

(* :History: 	2.0 first release CZM 2005, version March
		3.0 version november 2005 
		3.1 version March 2007 *)

(* :Keywords: postprocessing, plots *)


BeginPackage["CZMPostProcessing`CZMSensitivityAnalyses`",
	{"CZMInitialization`CZMLogFile`",
	"CZMInitialization`CZMConstants`",
	"CZMInitialization`CZMFunctions`", 
	"CZMImportData`CZMImportUserSelections`",
	"CZMImportData`CZMImportCosts`",
	"CZMImportData`CZMImportDALYs`",
	"CZMAdjustData`CZMMakeSelections`",
	"CZMSimulation`CZMSimulationFunctions`",
	"CZMDefineScenarios`CZMDefineScenarios`",
	"CZMSimulation`CZMSimulationMarginalModelDetermPop`",
	"CZMSimulation`CZMSimulationJointModelDetermPop`",
	"CZMSimulation`CZMSimulationJointModelDetermAge`",
	"CZMSimulation`CZMSimulationJointModelStochInd`",
	"CZMPostProcessing`CZMExportUserSelections`",
	"CZMPostProcessing`CZMCalcResults`"}]


Begin["`Private`"]


Print["CZMSensitivityAnalyses package is evaluated"];
printtijd;

printbug[c_] := If[(bugind == 1), Print[{"CZMSensitivityAnalyses", c}]];


(* --------------------------------------------------
	GENERAL ROUTINES
----------------------------------------------------*)

printbug["1."];

(* PLOTTING SETUP VALUES *)

printbug["1.1"];

imagesize	= 175;
stdaxislabel 	= {"time", ""};
stdlabel[r_, ri_] := risknames[[riskindd]][[r]] <> "class " <> ToString[ri];

(* NAMES OF SENSITIVITY INPUT PARAMETERS *)

printbug["1.2"];

riskclasstrans 	= Table[Plus@@Flatten[

				Table[If[(transriskindsel[[r, ri, rj]] == trs),
						{ri, rj},
						{0, 0}],
					{ri, ncrsel[[r]]}, {rj, ncrsel[[r]]}],
				1],
			{r, nrd}, {trs, 2, Max[transriskindsel[[r]]]}];

printbug["1.3"];

scennames = {};

If[(sensparameters[[1]] == 1),

	scennames = Flatten[{scennames,
			Table[risknames[[riskindd[[r]]]] <> " prev " <>	ToString[ri], {r, nrd}, {ri, ncrsel[[r]]}]}]];

If[(sensparameters[[2]] == 1),

	scennames = Flatten[{scennames, Table[risknames[[riskindd[[r]]]] <> ToString[riskclasstrans[[r, ri, 1]]] <> "->" <>
							ToString[riskclasstrans[[r, ri, 2]]],
			 			{r, nrd}, {ri, Length[riskclasstrans[[r]]]}]}]]; 

If[(sensparameters[[3]] == 1),

	scennames = Flatten[{scennames, Table[risknames[[riskindc[[r]]]] <> " mu", {r, nrc}],
						Table[risknames[[riskindc[[r]]]] <> " sigma", {r, nrc}]}]];

If[(sensparameters[[4]] == 1),

	scennames = Flatten[{scennames, Table[risknames[[riskindc[[r]]]] <> " deterministic change (intercept)", {r, nrc}],
						Table[risknames[[riskindc[[r]]]] <> " deterministic change (regression)", {r, nrc}]}]];

If[(sensparameters[[5]] == 1), 

	scennames = Flatten[{scennames, Table[disnames[[disind[[d]]]] <> " incidence", {d, nd}]}]];

If[(sensparameters[[6]] == 1), 

	scennames = Flatten[{scennames, Table[disnames[[disind[[d]]]] <> " excess mort", {d, nd}]}]];

If[(sensparameters[[7]] == 1), 

	scennames = Flatten[{scennames, Table[disnames[[disind[[d]]]] <> " case fatality", {d, nd}]}]];

If[(sensparameters[[8]] == 1),

	scennames = Flatten[{scennames, Table["(discrete) RR" <> risknames[[riskindd[[r]]]], {r, nrd}]}]];

If[(sensparameters[[9]] == 1), 

	scennames = Flatten[{scennames, Table["(continuous) RR" <> risknames[[riskindc[[r]]]], {r, nrc}]}]];

If[(sensparameters[[10]] == 1),	

	scennames = Flatten[{scennames, "tracking of risk factors"}]];

If[(sensparameters[[11]] == 1),	

	scennames = Flatten[{scennames, "RR's one dis on another dis incidence"}]];

If[(sensparameters[[12]] == 1), 

	scennames = Flatten[{scennames,	"RR's one dis on another dis case fatality"}]];	
		
If[(sensparameters[[13]] == 1), 

	scennames = Flatten[{scennames,	"relapsecoef 1", "relapsecoef 2"}]];

If[(sensparameters[[14]] == 1), 

	scennames = Flatten[{scennames,	"event regression coef 1", "event regression coef 2"}]];


(* --------------------------------------------------
	PRINTING ROUTINES FOR EVENT NUMBERS (EXCL LE) FOR EACH MODEL TYPE: SUB-ROUTINES
----------------------------------------------------*)

printbug["2."];

(* PRINTS NAME OF OUTPUT VARIABLE AND SCENARIO SPECIFICATIONS *)

resname[t_, diffscen_] := Block[{},

	str = outputnames[[t]] <> " differences with baseline input value " <>
		If[(diffscen == 0), "for baseline scenario", "difference with baseline scenario"];

	addcellnb[headingprint2nb[str]]];


(* PRINTS RESULTS: TOTAL POPULATION NUMBERS *)

printrespop[respop_, diffscen_] :=
	
	Do[	str = "input " <> scennames[[draw]] <>
			If[(diffscen == 0), " for baseline scenario", " difference with baseline scenario"];

		addcellnb[headingprint3nb[str]];			

		addcellnb[Cell[BoxData[ToBoxes[respop[[draw]] // TableForm]], "Subsection"]],

		{draw, Length[respop]}];


(* PRINTS RESULTS: RISK FACTOR CLASS PREVALENCE NUMBERS *)

printresrisk[resrisk_, diffscen_] :=

	Do[	str = "input "<> scennames[[draw]] <> " on " <> risknames[[riskindd[[r]]]] <> " "<> gennames[[g]] <>
			If[(diffscen == 0), "for baseline scenario", "difference with baseline scenario"];

		addcellnb[headingprint3nb[str]];					
			
		addcellnb[Cell[BoxData[ToBoxes[resrisk[[draw, r, g]] // TableForm]], "Subsection"]],

		{draw, Length[resrisk]}, {r, nrd}, {g, ng}];


(* PRINTS RESULTS: DISEASE (PREVALENCE, INCIDENCE, MORTALITY) NUMBERS *)

printresdis[resdis_, diffscen_] :=

	Do[	str = "input "<> scennames[[draw]] <> " on " <> mortnames[[d]] <>
			If[(diffscen == 0), "for baseline scenario", "difference with baseline scenario"];

		addcellnb[headingprint3nb[str]];					

		addcellnb[Cell[BoxData[ToBoxes[resdis[[draw, d]] // TableForm]], "Subsection"]],

		{draw, Length[resdis]}, {d, Length[resdis[[1]]]}];


(* --------------------------------------------------
	PLOTTING RESULTS IN POPULATION NUMBER FORMAT
----------------------------------------------------*)

printbug["3."];
		
plotpopnb[respop_, names_] := Block[{},

	hndraw 	= Length[respop];

	{
	Table[	{
		headingprint3nb[" gender " <> gennames[[g]]],
		Table[	Cell[	GraphicsData[
					"PostScript",
					DisplayString[
						GraphicsArray[
							Table[	ListPlot[respop[[draw2, g]],
									DisplayFunction -> Identity, 
									PlotLabel 	-> names[[draw2]], 
									PlotJoined 	-> True,  
									TextStyle 	-> stdtextstyle,
									AxesLabel 	-> stdaxislabel],
							     	{draw2, 4 draw1 + 1, Min[{4 draw1 + 4, hndraw}]}]
							]
						]
					],
				"Subsection",
				ImageSize -> ( Min[{4 draw1 + 4, hndraw}] - (4 draw1) ) imagesize
				],
			{draw1, 0, Floor[(hndraw - 1) / 4]}]
		},
	{g, ng}]
	}

	];


(* --------------------------------------------------
	PLOTTING RESULTS IN RISK FACTOR CLASS PREVALENCE NUMBER FORMAT
----------------------------------------------------*)

plotrisknb[resrisk_, names_]:= Block[{},

	hndraw 	= Length[resrisk];

	{
	Table[	{
		headingprint3nb[" gender " <> gennames[[g]] <> " risk factor " <> risknames[[riskindd[[r]]]] <>
			" class  " <> ToString[ri]],

		Table[	Cell[	GraphicsData[
						"PostScript",
						DisplayString[
							GraphicsArray[
								Table[	ListPlot[resrisk[[draw2, r, g, ri]],
										DisplayFunction -> Identity, 
										PlotLabel 	-> names[[draw2]],
										PlotJoined 	-> True,
										TextStyle 	-> stdtextstyle,
										AxesLabel 	-> stdaxislabel],
									{draw2, 4 draw1 + 1, Min[{4 draw1 + 4, hndraw}]}]
								]
							]
						],
				"Subsection",
				ImageSize -> ( Min[{4 draw1 + 4, hndraw}] - (4 draw1) ) imagesize
				],
			{draw1, 0, Floor[(hndraw - 1) / 4]}]
		},
	{g, ng}, {r, nrd}, {ri, ncrsel[[r]]}]
	}

	];


(* --------------------------------------------------
	PLOTTING RESULTS IN DISEASE PREVALENFCE NUMBER FORMAT
----------------------------------------------------*)

plotdisnb[resdis_, names_]:= Block[{},

	hndraw 	= Length[resdis];
	nd1 	= Length[resdis[[1]]];

	{
	Table[	{
		headingprint3nb[" gender " <> gennames[[g]] <> " disease " <> mortnames[[d]]],
		Table[	Cell[	GraphicsData[
					"PostScript",
					DisplayString[
   						GraphicsArray[
							Table[	ListPlot[resdis[[draw2, d, g]],
									DisplayFunction -> Identity, 
									PlotLabel 	-> names[[draw2]], 
									PlotJoined 	-> True, 
									TextStyle 	-> stdtextstyle,
									AxesLabel 	-> stdaxislabel],
								{draw2, 4 draw1 + 1, Min[{4 draw1 + 4, hndraw}]}]
								]
							]
						],
				"Subsection",
				ImageSize -> ( Min[{4 draw1 + 4, hndraw}] - (4 draw1) ) imagesize
				],
			{draw1, 0, Floor[(hndraw - 1) / 4]}]
		},

	{g, ng}, {d, Length[resdis[[1]]]}] 
	}

	];


(* --------------------------------------------------
	PRINTING ROUTINES FOR EVENT NUMBERS: GENERIC ROUTINES
----------------------------------------------------*)

printbug["4."];

makedis[resmodel_, outputind_, nd_] := Block[{},

printbug["4.1"];

	ndis	= If[(rates == 0),

				If[(cumulative == 0),

					Table[Plus@@Flatten[resmodel[[outputind, draw, n, d, g]]],
						{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}],

					Table[Plus@@Flatten[resmodel[[outputind, draw, Range[n], d, g]]],
						{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}]],

				Table[Plus@@Flatten[resmodel[[outputind, draw, n, d, g]]] / Plus@@Flatten[resmodel[[1, draw, n, g]]],
					{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}]

			];

printbug["4.1.1"];

	ndis	= Table[(ndis[[draw]] - ndis[[1]]) / (ndis[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;
	
printbug["4.1.2"];

	resname[outputind, 0];	

	If[(graphicoutput == 1),	

		addcellnb[plotdisnb[ndis, scennames]]];

	If[(tabeloutput == 1),		

		ndis 	= roundoff[ndis, 1000];
		printresdis[ndis, 0]];

printbug["4.1.3"]
		
	];

makedisdiff[resmodel_, scen_, outputind_, nd_] := Block[{},

printbug["4.2"];

	ndis	= If[(rates == 0),

				If[(cumulative == 0),

					Table[Plus@@Flatten[resmodel[[outputind, draw + ndrawinput scen, n, d, g]]] -
							Plus@@Flatten[resmodel[[outputind, draw, n, d, g]]],
						{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}],

					Table[Plus@@Flatten[resmodel[[outputind, draw + ndrawinput scen, Range[n], d, g]]] -
							Plus@@Flatten[resmodel[[outputind, draw, Range[n], d, g]]],
						{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}]],

				Table[Plus@@Flatten[resmodel[[outputind, draw + ndrawinput scen, n, d, g]]] /
						Plus@@Flatten[resmodel[[1, draw + ndrawinput scen, n, g]]] -
						Plus@@Flatten[resmodel[[outputind, draw, n, d, g]]] /
						Plus@@Flatten[resmodel[[1, draw, n, g]]],
					{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}]

			];

printbug["4.2.1"];

	ndis	= Table[(ndis[[draw]] - ndis[[1]]) / (ndis[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;

printbug["4.2.2"];

	resname[outputind, 1];	

	If[(graphicoutput == 1),
	
		addcellnb[plotdisnb[ndis, scennames]]];

	If[(tabeloutput == 1),		

		ndis 	= roundoff[ndis, 1000];
		printresdis[ndis, 1]];

printbug["4.2.3"]
	
	];
(* --------------------------------------------------
	PRINTING ROUTINES FOR EVENT NUMBERS FOR EACH MODEL TYPE FOR BASELINE SCENARIO: MAIN ROUTINE
----------------------------------------------------*)

printnumbers[resmodel_] := Block[{},

	(* TOTAL POPULATION NUMBERS *)

printbug["4.3"];

	If[(outputsel[[1]] == 1),
					
		npop	= If[(cumulative == 0),

				Table[Plus@@Flatten[resmodel[[1, draw, n, g]]],	{draw, ndrawinput}, {g, ng}, {n, nstap}],
				Table[Plus@@Flatten[resmodel[[1, draw, Range[n], g]]],
					{draw, ndrawinput}, {g, ng}, {n, nstap}]];

printbug["4.3.1"];

		npop	= Table[(npop[[draw]] - npop[[1]]) / (npop[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;

printbug["4.3.2"];		

		resname[1, 0];	

		If[(graphicoutput == 1),	

			addcellnb[plotpopnb[npop, scennames]]];

		If[(tabeloutput == 1),		

			npop 	= roundoff[npop, 1000];
			printrespop[npop, 0]];

printbug["4.3.3"]

		];

	(* DISCRETELY DISTRIBUTED RISK FACTOR CLASS PREVALENCE NUMBERS OR RATES *)

	If[(nrd > 0) && (outputsel[[2]] == 1),	

printbug["4.4"];

		nrisk = If[(rates == 0),
				
				Table[Plus@@Flatten[resmodel[[2, draw, n, r, g, ri]]],
					{draw, ndrawinput}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],

				Table[Plus@@Flatten[resmodel[[2, draw, n, r, g, ri]]] /
						Plus@@Flatten[resmodel[[1, draw, n, g]]],
					{draw, ndrawinput}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]
				];

printbug["4.4.1"];

		nrisk	= Table[(nrisk[[draw]] - nrisk[[1]]) / (nrisk[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;

printbug["4.4.2"];		

		resname[2, 0];	

		If[(graphicoutput == 1),	

			addcellnb[plotrisknb[nrisk, scennames]]];

		If[(tabeloutput == 1),		

			nrisk 	= roundoff[nrisk, 1000];
			printresrisk[nrisk, 0]];

printbug["4.4.3"]

		];

	(* DISEASE PREVALENCE NUMBERS OR RATES*)

printbug["4.5"];

	If[(nd > 0) && (outputsel[[4]] == 1), 	makedis[resmodel, 4, nd]];					
		
	(* DISEASE INCIDENCE NUMBERS *)

printbug["4.6"];

	If[(nd > 0) && (outputsel[[5]] == 1), 	makedis[resmodel, 5, nd]];

	(* DISEASE MORTALITY NUMBERS *)

printbug["4.7"];

	If[(outputsel[[6]] == 1), 		makedis[resmodel, 6, nd]];

	(* MEAN AGE AT DISEASE ONSET *)

	If[(nd > 0) && (outputsel[[7]] == 1),

printbug["4.8"];

		onsetage = Table[Plus@@Flatten[resmodel[[7, draw, n, d, g]]] / Plus@@Flatten[resmodel[[4, draw, n, d, g]]],
					{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}];

printbug["4.8.1"];

		onsetage = Table[(onsetage[[draw]] - onsetage[[1]]) / (onsetage[[1]] + eps) , {draw, 2, ndrawinput}] /
				deltasens;

printbug["4.8.2"];

		resname[7, 0];	
		
		If[(graphicoutput == 1),	

			addcellnb[plotdisnb[onsetage, scennames]]];

		If[(tabeloutput == 1),		

			onsetage = roundoff[onsetage, 1000];
			printresdis[onsetage, 0]];

printbug["4.8.3"]

		];

	(* MEAN TIME SINCE SMOKING CESSATION *)

	If[(RRsmokduurind == 1) && (outputsel[[8]] == 1),

printbug["4.9"];

		duurstop = Table[Plus@@Flatten[resmodel[[8, draw, n, g]]] / Plus@@Flatten[resmodel[[2, draw, n, 1, g, 3]]],
				{draw, ndrawinput}, {g, ng}, {n, nstap}];

printbug["4.9.1"];

		duurstop = Table[(duurstop[[draw]] - duurstop[[1]]) / (duurstop[[1]] + eps) , {draw, 2, ndrawinput}] /
				deltasens;

printbug["4.9.2"];

		resname[8, 0];
		
		If[(graphicoutput == 1),	

			addcellnb[plotpopnb[duurstop, scennames]]];

		If[(tabeloutput == 1),		

			duurstop = roundoff[duurstop, 1000];
			printrespop[duurstop, 0]];

printbug["4.9.3"]
		
		];	

]; (* END PRINTNUMBERS *)

(* --------------------------------------------------
	PRINTING ROUTINES FOR EVENT NUMBERS FOR EACH MODEL TYPE COMPARED TO BASELINE SCENARIO: MAIN ROUTINE
----------------------------------------------------*)

printdiffnumbers[resmodel_, scen_] := Block[{},

	(* TOTAL POPULATION NUMBERS *)

	If[(outputsel[[1]] == 1),

printbug["4.10"];

		npop	= If[(cumulative == 0),

				Table[Plus@@Flatten[resmodel[[1, draw + ndrawinput scen, n, g]]] -
						Plus@@Flatten[resmodel[[1, draw, n, g]]],
					{draw, ndrawinput}, {g, ng}, {n, nstap}],

				Table[Plus@@Flatten[resmodel[[1, draw + ndrawinput scen, Range[n], g]]] -
						Plus@@Flatten[resmodel[[1, draw, Range[n], g]]],
					{draw, ndrawinput}, {g, ng}, {n, nstap}]];

printbug["4.10.1"];

		npop	= Table[(npop[[draw]] - npop[[1]]) / (npop[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;


printbug["4.10.2"];

		resname[1, 1];
		
		If[(graphicoutput == 1),

			addcellnb[plotpopnb[npop, scennames]]];

		If[(tabeloutput == 1),		

			npop 	= roundoff[npop, 1000];
			printrespop[npop, 1]];

printbug["4.10.3"]
		
		];

	(* DISCRETELY DISTRIBUTED RISK FACTOR CLASS PREVALENCE NUMBERS AND RATES *)

	If[(nrd > 0) && (outputsel[[2]] == 1),	

printbug["4.11"];
				
		nrisk	= If[(rates == 0),

				Table[Plus@@Flatten[resmodel[[2, draw + ndrawinput scen, n, r, g, ri]]] -
						Plus@@Flatten[resmodel[[2, draw, n, r, g, ri]]],
					{draw, ndrawinput}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}],

				Table[Plus@@Flatten[resmodel[[2, draw + ndrawinput scen, n, r, g, ri]]] /
						Plus@@Flatten[resmodel[[1, draw + ndrawinput scen, n, g]]] -
						Plus@@Flatten[resmodel[[2, draw, n, r, g, ri]]] /
						Plus@@Flatten[resmodel[[1, draw, n, g]]],
					{draw, ndrawinput}, {r, nrd}, {g, ng}, {ri, ncrsel[[r]]}, {n, nstap}]];

printbug["4.11.1"];

		nrisk	= Table[(nrisk[[draw]] - nrisk[[1]]) / (nrisk[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;

printbug["4.11.2"];

		resname[2, 1];	

		If[(graphicoutput == 1),	

			addcellnb[plotrisknb[nrisk, scennames]]];

		If[(tabeloutput == 1),		

			nrisk 	= roundoff[nrisk, 1000];
			printresrisk[nrisk, 1]];

printbug["4.11.3"]

		];

	(* DISEASE PREVALENCE NUMBERS AND RATES *)

printbug["4.12"];

	If[(nd > 0) && (outputsel[[4]] == 1), 	makedisdiff[resmodel, scen, 4, nd]];
				
	(* DISEASE INCIDENCE NUMBERS *)

printbug["4.13"];

	If[(nd > 0) && (outputsel[[5]] == 1), 	makedisdiff[resmodel, scen, 5, nd]];

	(* DISEASE MORTALITY NUMBERS *)

printbug["4.14"];

	If[(outputsel[[6]] == 1), 		makedisdiff[resmodel, scen, 6, nd + 2]];

	(* MEAN AGE AT DISEASE ONSET *)

	If[(nd > 0) && (outputsel[[7]] == 1),

printbug["4.15"];

		onsetage	= Table[Plus@@Flatten[resmodel[[7, draw + ndrawinput scen, n, d, g]]] /
					Plus@@Flatten[resmodel[[4, draw + ndrawinput scen, n, d, g]]] -
					Plus@@Flatten[resmodel[[7, draw, n, d, g]]] /
					Plus@@Flatten[resmodel[[4, draw, n, d, g]]],
					{draw, ndrawinput}, {d, nd}, {g, ng}, {n, nstap}];

printbug["4.15.1"];

		onsetage	= Table[(onsetage[[draw]] - onsetage[[1]]) / (onsetage[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;

printbug["4.15.2"];
		
		resname[7, 1];	

		If[(graphicoutput == 1),	

			addcellnb[plotdisnb[nmort, scennames]]];

		If[(tabeloutput == 1),		

			onsetage = roundoff[onsetage, 1000];
			printresdis[onsetage, 1]];

printbug["4.15.3"]
		
		];

	(* MEAN TIME SINCE SMOKING CESSATION *)

	If[(RRsmokduurind == 1) && (outputsel[[8]] == 1),

printbug["4.16"];

		duurstop	= Table[Plus@@Flatten[resmodel[[8, draw + ndrawinput scen, n, g]]] /
					Plus@@Flatten[resmodel[[2, draw + ndrawinput scen, n, 1, g, 3]]] -
					Plus@@Flatten[resmodel[[8, draw, n, g]]] /
					Plus@@Flatten[resmodel[[2, draw, n, 1, g, 3]]],
				{draw, ndrawinput}, {g, ng}, {n, nstap}];

printbug["4.16.1"];

		duurstop = Table[(duurstop[[draw]] - duurstop[[1]]) / (duurstop[[1]] + eps) , {draw, 2, ndrawinput}] / deltasens;

printbug["4.16.2"];
		
		resname[8, 1];	

		If[(graphicoutput == 1),	

			addcellnb[plotpopnb[duurstop, scennames]]];

		If[(tabeloutput == 1),		

			duurstop = roundoff[duurstop, 1000];
			printrespop[duurstop, 1]];

printbug["4.16.3"]
		
		]

	]; (* END PRINTDIFFNUMBERS *)

(* --------------------------------------------------
	SENSITIVITY OF LIFE EXPECTANCY BASED OUTPUT NUMBERS FOR BASELINE SCENARIO
----------------------------------------------------*)

printbug["5."];

(* INDICATOR FUNCTION *)

EqInd[d_, d1_]	:= 1 + If[(d == d1), deltasens, 0];

(* DISCOUNTING FUTURE NUMBERS *)

makediscount[npop_, disc_, delta_] := Table[npop[[g, n]] / (1 + (1 + delta) disc)^(n - 1), {g, ng}, {n, nstap}];

(* DISCOUNTING FUTURE NUMBERS AND PRESENTATION *)

makepopcosts[npop_, names_, poptype_, cumul_] := Block[{},

printbug["5.1"];

	npop1	= npop;

	If[(cumul == 1), npop1 = Table[Plus@@npop1[[scen, g, Range[n]]], {scen, Length[npop1]}, {g, ng}, {n, nstap}]];

printbug["5.1.1"];

	npop1	= Table[(npop1[[scen]] - npop1[[1]]) / (npop1[[1]] + eps), {scen, 2, Length[npop1]}] / deltasens;

printbug["5.1.2"];
	
	If[(graphicoutput == 1),

		addcellnb[headingprint3nb[poptype]];
		addcellnb[plotpopnb[npop1, names]]];
	
	If[(tabeloutput == 1),

		npop1 	= roundoff[npop1, 1000];
 		printrespop[npop1, 0]];

printbug["5.1.3"]

	]; (* MAKEPOPCOSTS *)
		
printpopcosts[resmodel_] := Block[{},

	(* TOTAL POPULATION NUMBERS & COSTS *)

	If[(outputsel[[1]] == 1) && (outputsel[[9]] == 1),

		(* MEAN AGECLASS DISABILITY WEIGHTS AND COSTS *)

		meanDALYwgt	= Table[meanaggreg[DALYwgtsel[[d, g]]], {d, nd}, {g, ng}];

		meanDALYwgt	= Table[Plus@@(meanDALYwgt[[d, g]] resmodel[[4, 1, n, d, g]]) /	(Plus@@resmodel[[4, 1, n, d, g]] + eps),
					{n, nstap}, {d, nd}, {g, ng}];

		meancostspatient = Table[meanaggreg[costspatientsel[[d, g]]], {d, nd}, {g, ng}];
		
		meancostspatient = Table[Plus@@(meancostspatient[[d, g]] resmodel[[4, 1, n, d, g]]) / (Plus@@resmodel[[4, 1, n, d, g]] + eps),
					{n, nstap}, {d, nd}, {g, ng}];

		meancostspersonoth = Table[meanaggreg[costspersonothsel[[g]]], {g, ng}];
		
		meancostspersonoth = Table[Plus@@(meancostspersonoth[[g]] resmodel[[1, 1, n, g]]) / (Plus@@resmodel[[1, 1, n, g]] + eps),
					{n, nstap}, {g, ng}];

printbug["5.2"];

		resname[1, 0];
		
		(* TOTAL POPULATION NUMBERS *)

printbug["5.2.1"];
		
		npop	= Table[Plus@@resmodel[[1, 1, n, g]], {g, ng}, {n, nstap}];

		npop1	= makediscount[npop, discounte, 0];

		npop2	= makediscount[npop, discounte, deltasens];

printbug["5.2.2"];

		makepopcosts[{npop1, npop2}, {"discounting"}, "total population", cumulative];

		(* DISEASE-FREE POPULATION NUMBERS *)

printbug["5.3"];

		pdis	= Table[Plus@@resmodel[[4, 1, n, d, g]] / (Plus@@Flatten[resmodel[[1, 1, n, g]]] + eps),
					{n, nstap}, {d, nd}, {g, ng}];

		nfree	= Table[npop[[g, n]] Times@@(1 - pdis[[n, Range[nd], g]]), {g, ng}, {n, nstap}];

		nfree1	= makediscount[nfree, discounte, 0];

		nfree2	= makediscount[nfree, discounte, deltasens];

		nfree3	= Table[npop[[g, n]] *
					Times@@Table[1 - EqInd[d, d1] pdis[[n, d1, g]], {d1, nd}] /
					(1 + discounte)^(n - 1),
				{d, nd}, {g, ng}, {n, nstap}];

printbug["5.3.1"];

		makepopcosts[Join[{nfree1, nfree2}, nfree3], Join[{"discounting"}, disnames[[disind]]],
				"disease-free population", cumulative];

		(* DALY-WEIGHTED POPULATION NUMBERS *)

printbug["5.4"];

		nDALY	= Table[npop[[g, n]] Times@@Table[1 - meanDALYwgt[[n, d, g]] pdis[[n, d, g]], {d, nd}],
				{g, ng}, {n, nstap}];

		nDALY1	= makediscount[nDALY, discounte, 0];

		nDALY2	= makediscount[nDALY, discounte, deltasens];

		nDALY3	= Table[npop[[g, n]] *
				Times@@Table[1 - EqInd[d, d1] meanDALYwgt[[n, d1, g]] pdis[[n, d1, g]], {d1, nd}] /
				(1 + discounte)^(n - 1),
				{d, nd}, {g, ng}, {n, nstap}];

printbug["5.4.1"];

		makepopcosts[Join[{nDALY1, nDALY2}, nDALY3], Join[{"discounting"}, disnames[[disind]]],
				"DALY weighted population", cumulative];

		(* COSTS EXCL. OTHER COSTS *)

printbug["5.5"];

		ncosts 	= Table[Plus@@Table[Plus@@(meancostspatient[[n, d, g]] resmodel[[4, 1, n, d, g]]), {d, nd}],
				{g, ng}, {n, nstap}];

		ncosts1	= makediscount[ncosts, discountc, 0];

		ncosts2	= makediscount[ncosts, discountc, deltasens];

		ncosts3	= Table[Plus@@Table[EqInd[d, d1] Plus@@(meancostspatient[[n, d1, g]] resmodel[[4, 1, n, d1, g]]),
						{d1, nd}] /
				(1 + discountc)^(n - 1),
				{d, nd}, {g, ng}, {n, nstap}];	

printbug["5.5.1"];

		makepopcosts[Join[{ncosts1, ncosts2}, ncosts3], Join[{"discounting"}, disnames[[disind]]],
					"total costs excl. other", cumulative];

		(* COSTS INCL. OTHER COSTS *)

printbug["5.5.2"];

		othcosts = Table[Plus@@(meancostspersonoth[[n, g]] resmodel[[1, 1, n, g]]), {g, ng}, {n, nstap}];

		ncosts4	= makediscount[ncosts + othcosts, discountc, 0];

		ncosts5	= makediscount[ncosts + othcosts, discountc, deltasens];

		ncosts6	= ncosts3 + Table[makediscount[othcosts, discountc, 0], {nd}];	

printbug["5.5.3"];

		makepopcosts[Join[{ncosts4, ncosts5}, ncosts6], Join[{"discounting"}, disnames[[disind]]],
					"total costs incl. other", cumulative];

		(* COSTS (EXCL. OTHER) PER DALY *)

printbug["5.6"];

		If[(cumulative == 1),

			costsDALY1 = Table[Plus@@ncosts1[[g, Range[n]]] / (Plus@@nDALY1[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY2 = Table[Plus@@ncosts2[[g, Range[n]]] / (Plus@@nDALY2[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY3 = Table[Plus@@ncosts3[[d, g, Range[n]]] / (Plus@@nDALY3[[d, g, Range[n]]] + eps),
						{d, nd}, {g, ng}, {n, nstap}];

printbug["5.6.1"];

			makepopcosts[Join[{costsDALY1, costsDALY2}, costsDALY3],
				Join[{"discounting"}, disnames[[disind]]], "costs(excl.other)/DALY", 0];

		(* COSTS (INCL. OTHER) PER DALY *)

printbug["5.6.2"];

			costsDALY1 = Table[Plus@@ncosts4[[g, Range[n]]] / (Plus@@nDALY1[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY2 = Table[Plus@@ncosts5[[g, Range[n]]] / (Plus@@nDALY2[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY3 = Table[Plus@@ncosts6[[d, g, Range[n]]] / (Plus@@nDALY3[[d, g, Range[n]]] + eps),
						{d, nd}, {g, ng}, {n, nstap}];

printbug["5.6.3"];

			makepopcosts[Join[{costsDALY1, costsDALY2}, costsDALY3],
				Join[{"discounting"}, disnames[[disind]]], "costs(incl.other)/DALY", 0];


			];
			
		];

]; (* END PRINTPOPCOSTS *)


(* --------------------------------------------------
	SENSITIVITY OF LIFE EXPECTANCY BASED OUTPUT NUMBERS COMPARED TO BASELINE SCENARIO
----------------------------------------------------*)

printbug["6."];
		
printdiffpopcosts[resmodel_, hscen_] := Block[{},

	scenr = 1 + ndrawinput {0, hscen};

	(* TOTAL POPULATION NUMBERS & COSTS *)

	If[(outputsel[[1]] == 1) && (outputsel[[9]] == 1),

		(* MEAN AGECLASS DISABILITY WEIGHTS AND COSTS *)

		meanDALYwgt	= Table[meanaggreg[DALYwgtsel[[d, g]]], {d, nd}, {g, ng}];

		meanDALYwgt	= Table[Plus@@(meanDALYwgt[[d, g]] resmodel[[4, 1, n, d, g]]) /	(Plus@@resmodel[[4, 1, n, d, g]] + eps),
					{n, nstap}, {d, nd}, {g, ng}];

		meancostspatient = Table[meanaggreg[costspatientsel[[d, g]]], {d, nd}, {g, ng}];
		
		meancostspatient = Table[Plus@@(meancostspatient[[d, g]] resmodel[[4, 1, n, d, g]]) / (Plus@@resmodel[[4, 1, n, d, g]] + eps),
					{n, nstap}, {d, nd}, {g, ng}];

		meancostspersonoth = Table[meanaggreg[costspersonothsel[[g]]], {g, ng}];
		
		meancostspersonoth = Table[Plus@@(meancostspersonoth[[g]] resmodel[[1, 1, n, g]]) / (Plus@@resmodel[[1, 1, n, g]] + eps),
					{n, nstap}, {g, ng}];

printbug["6.2"];

		resname[1, 1];
		
		(* TOTAL POPULATION NUMBERS *)

printbug["6.2.1"];

		npop	= Table[Plus@@resmodel[[1, scenr[[scen]], n, g]], {scen, 2}, {g, ng}, {n, nstap}];

		dnpop	= npop[[2]] - npop[[1]];

		npop1	= makediscount[dnpop, discounte, 0];

		npop2	= makediscount[dnpop, discounte, deltasens];

printbug["6.2.2"];

		makepopcosts[{npop1, npop2}, {"discounting"}, "total population", cumulative];

		(* DISEASE-FREE POPULATION NUMBERS *)

printbug["6.3"];

		pdis	= Table[Plus@@resmodel[[4, scenr[[scen]], n, d, g]] /
					(Plus@@Flatten[resmodel[[1, scenr[[scen]], n, g]]] + eps),
				{scen, 2}, {n, nstap}, {d, nd}, {g, ng}];

printbug["6.3.1"];

		nfree	= Table[npop[[scen, g, n]] Times@@(1 - pdis[[scen, n, Range[nd], g]]),
				{scen, 2}, {g, ng}, {n, nstap}];

printbug["6.3.2"];

		nfree	= nfree[[2]] - nfree[[1]];

		nfree1	= makediscount[nfree, discounte, 0];

		nfree2	= makediscount[nfree, discounte, deltasens];

		nfree3	= Table[npop[[scen, g, n]] *
					Times@@Table[1 - EqInd[d, d1] pdis[[scen, n, d1, g]], {d1, nd}] /
					(1 + discounte)^(n - 1),
				{scen, 2}, {d, nd}, {g, ng}, {n, nstap}];

		nfree3	= nfree3[[2]] - nfree3[[1]];

printbug["6.3.3"];

		makepopcosts[Join[{nfree1, nfree2}, nfree3], Join[{"discounting"}, disnames[[disind]]],
					"disease-free population", cumulative];

		(* DALY-WEIGHTED POPULATION NUMBERS *)

printbug["6.4"];

		nDALY	= Table[npop[[scen, g, n]] Times@@Table[1 - meanDALYwgt[[n, d, g]] pdis[[scen, n, d, g]], {d, nd}],
				{scen, 2}, {g, ng}, {n, nstap}];

		nDALY	= nDALY[[2]] - nDALY[[1]];

		nDALY1	= makediscount[nDALY, discounte, 0];

		nDALY2	= makediscount[nDALY, discounte, deltasens];

printbug["6.4.1"];

		nDALY3	= Table[npop[[scen, g, n]] *
				Times@@Table[1 - EqInd[d, d1] meanDALYwgt[[n, d1, g]] pdis[[scen, n, d1, g]], {d1, nd}] /
				(1 + discounte)^(n - 1),
				{scen, 2}, {d, nd}, {g, ng}, {n, nstap}];

		nDALY3	= nDALY3[[2]] - nDALY3[[1]];

printbug["6.4.2"];

		makepopcosts[Join[{nDALY1, nDALY2}, nDALY3], Join[{"discounting"}, disnames[[disind]]],
					"DALY weighted population", cumulative];

		(* COSTS (EXCL. OTHER) *)

printbug["6.5"];

		ncosts 	= Table[Plus@@Table[Plus@@(meancostspatient[[n, d, g]] resmodel[[4, scenr[[scen]], n, d, g]]),
						{d, nd}],
				{scen, 2}, {g, ng}, {n, nstap}];

		dncosts	= ncosts[[2]] - ncosts[[1]];

		ncosts1	= makediscount[dncosts, discountc, 0];
	
		ncosts2	= makediscount[dncosts, discountc, deltasens];
	
printbug["6.5.1"];

		ncosts3	= Table[Plus@@Table[EqInd[d, d1] *
						Plus@@(meancostspatient[[n, d1, g]] resmodel[[4, scenr[[scen]], n, d1, g]]),
						{d1, nd}] /
				(1 + discountc)^(n - 1),
				{scen, 2}, {d, nd}, {g, ng}, {n, nstap}];

		ncosts3	= ncosts3[[2]] - ncosts3[[1]];

printbug["6.5.2"];

		makepopcosts[Join[{ncosts1, ncosts2}, ncosts3], Join[{"discounting"}, disnames[[disind]]],
					"total costs excl. other", cumulative];

		(* COSTS (INCL. OTHER) *)

printbug["6.5.3"];

		othcosts = Table[Plus@@(meancostspersonoth[[n, g]] resmodel[[1, scenr[[scen]], n, g]]),
				{scen, 2}, {g, ng}, {n, nstap}];

		othcosts = othcosts[[2]] - othcosts[[1]];

		ncosts4	= makediscount[dncosts + othcosts, discountc, 0];
	
		ncosts5	= makediscount[dncosts + othcosts, discountc, deltasens];
	
printbug["6.5.4"];

		ncosts6	= ncosts3 + Table[makediscount[othcosts, discountc, 0], {nd}];

printbug["6.5.5"];

		makepopcosts[Join[{ncosts4, ncosts5}, ncosts6], Join[{"discounting"}, disnames[[disind]]],
					"total costs incl. other", cumulative];

		(* COSTS PER DALY *)

printbug["6.6"];

		If[(cumulative == 1),

			costsDALY1 = Table[Plus@@ncosts1[[g, Range[n]]] / (Plus@@nDALY1[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY2 = Table[Plus@@ncosts2[[g, Range[n]]] / (Plus@@nDALY2[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY3 = Table[Plus@@ncosts3[[d, g, Range[n]]] / (Plus@@nDALY3[[d, g, Range[n]]] + eps),
					{d, nd}, {g, ng}, {n, nstap}];

printbug["6.6.1"];

			makepopcosts[Join[{costsDALY1, costsDALY2}, costsDALY3],
					Join[{"discounting"}, disnames[[disind]]], "costs excl. other/DALY", 0];

printbug["6.6.2"];

			costsDALY1 = Table[Plus@@ncosts4[[g, Range[n]]] / (Plus@@nDALY1[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY2 = Table[Plus@@ncosts5[[g, Range[n]]] / (Plus@@nDALY2[[g, Range[n]]] + eps),
						{g, ng}, {n, nstap}];

			costsDALY3 = Table[Plus@@ncosts6[[d, g, Range[n]]] / (Plus@@nDALY3[[d, g, Range[n]]] + eps),
					{d, nd}, {g, ng}, {n, nstap}];

printbug["6.6.3"];

			makepopcosts[Join[{costsDALY1, costsDALY2}, costsDALY3],
					Join[{"discounting"}, disnames[[disind]]], "costs incl. other/DALY", 0]

			];
			
		];

]; (* END PRINTDIFFPOPCOSTS *)


(* --------------------------------------------------
	PRINTING ROUTINE FOR RESULTS FROM ONE CZM MODEL VERSION
----------------------------------------------------*)

printbug["7."];

printresmodel[resmodel_, naam1_] := Block[{},

	(* DIFFERENCES WITH BASELINE INPUT VALUE FOR BASELINE SCENARIO *)

printbug["7.1"];

	str = naam1 <> "differences with baseline input value, baseline scenario";
	
	addcellnb[headingprint1nb[str]];						

	printnumbers[resmodel];

	printpopcosts[resmodel];

	(* DIFFERENCES WITH BASELINE INPUT VALUE FOR DIFFERENCE WITH BASELINE SCENARIO *)

printbug["7.2"];

	Do[	str = naam1 <> "differences with baseline input value, scenario " <> ToString[scen] <>
			" compared to baseline scenario";
	
		addcellnb[headingprint1nb[str]];						

		printdiffnumbers[resmodel, scen - 1];

		printdiffpopcosts[resmodel, scen - 1],

		{scen, 2, nscen0}];
	
	]; (* END PRINTRESMODEL *)


(* --------------------------------------------------
	CONCATENATION OF NOTEBOOK CELLS
----------------------------------------------------*)

addcellnb[cell_] := Block[{}, cellnb = Flatten[{cellnb, cell}]];


(* --------------------------------------------------
	CONCATENATION OF RESULTS OVER CZM MODEL VERSIONS SELECTED
----------------------------------------------------*)

printbug["8."];

If[(analyse == 1),

printbug["8.1"];

	resmodel	= {resmarginalmodeldetermpop, resjointmodeldetermpop, resjointmodeldetermage, resjointmodelstochind,
	 			resjointmodelstochindcourse, resjointmodelstochpop, resjointmodelstochage};

	cellnb		= {headingprintnb["sensitivity analyses results"]};

	(* PRINTING RESULTS FOR EACH CZM MODEL VERSION SELECTED *)

	Do[If[(modelsel[[m]] == 1), printresmodel[resmodel[[m]], modelnames[[m]]]], {m, nmodel}];

	NotebookWrite[nbout, Flatten[cellnb]]

	];


(* --------------------------------------------------
		Write info to Logfile
----------------------------------------------------*)

(* PACKAGE VERSION *)

version = 3.1;

WriteString[logfile, 
		"\t" <> "Package: " <> StringReplace[Evaluate[Context[]], "`Private`"-> ", " ] 
		<> "version " <> ToString[version] <> "\n\n"];

End[]


Protect[Evaluate[Context[] <> "*"]]


EndPackage[]
(* :Title: CZMCompareRuns *)

(* :Context: CZMPostProcessing` *)

(* :Author: Rudolf T. Hoogenveen, Maiwenn Al *)

(* :Summary:
   CZM postprocessing routine compares results from different CZM model runs *)

(* :Copyright: © 2004 by Rudolf Hoogenveen/Roel Breuls *)

(* :Package Version: 3.1 *)

(* :Mathematica Version: 5.1 *)

(* :History: 	1.0 first update new implementation CZM July 2004
		2.0 first release CZM 2005, version March
		3.0 version November 2005 
		3.1 version March 2007 *)

(* :Keywords: postprocessing, model versions *)


BeginPackage["CZMPostProcessing`CZMCompareRuns`",
	{"CZMInitialization`CZMLogFile`",
	"CZMInitialization`CZMConstants`",
	"CZMInitialization`CZMFunctions`",
	"CZMImportData`CZMImportUserSelections`",
	"CZMImportData`CZMImportDemography`",
	"CZMImportData`CZMImportRiskFactors`",
	"CZMImportData`CZMImportRelativeRisks`",
	"CZMImportData`CZMImportDiseaseData`",
	"CZMAdjustData`CZMDataSmoothing`",
	"CZMAdjustData`CZMAdjustBeforeSelection`",
	"CZMAdjustData`CZMMakeSelections`",
	"CZMAdjustData`CZMAdjustAfterSelection`",
	"CZMSimulation`CZMSimulationFunctions`",
	"CZMSimulation`CZMSimulationMarginalModelDetermPop`",
	"CZMSimulation`CZMSimulationJointModelDetermPop`",
	"CZMSimulation`CZMSimulationJointModelDetermAge`",
	"CZMSimulation`CZMSimulationJointModelStochInd`",
	"CZMPostProcessing`CZMExportUserSelections`",
	"CZMPostProcessing`CZMCalcResults`",
	"CZMPostProcessing`CZMPresentResults`",
	"Graphics`Legend`",
	"Graphics`MultipleListPlot`"}]


Begin["`Private`"]


Print["CZMCompareRuns package is evaluated"];
printtijd;

printbug[c_] := If[(bugind == 1), Print[{"CZMCompareRuns", c}]];

himagesize	= 240;
graphind	= 1;
tabind		= 0;
figsize		= 900;


If[(analyse == 3),

(* --------------------------------------------------
	INITIALIZATIONS
----------------------------------------------------*)

printbug["1."];

	(* READS INPUT FILE CONTAINING RESULTS FROM ALL MODEL RUNS *)

	dat 		= Global`outputpath <> "outfileresmodelrun.m";
	hnrun		= (Read[dat])[[1]];
	resmodel 	= Table[Read[dat], {2 hnrun}];
	Close[dat];

printbug["1.1"];

	(* SIMULATION TIME PERIOD, ASSSUMED EQUAL FOR ALL RUNS; #SCENARIOS *)

	hnstap 	= resmodel[[1, 8]];
	hnscen	= resmodel[[1, 9]];

printbug["1.2"];

	(* # DISEASES, # RISK FACTORS AND CLASSES SELECTED IN BASELINE RUN *)

	hnd 	= Length[resmodel[[1, 2]]];
	hnrd	= Length[resmodel[[1, 1]]];
	hncr 	= ncr0[[resmodel[[1, 1]]]];

printbug["1.3"];

	(* FOR EACH RISK FACTOR IN BASELINE RUN POINTER TO RISK FACTOR IN OTHER RUNS *)

	pointerrisk = Table[0, {hnrun - 1}, {hnrd}];

	Do[If[(resmodel[[2 s - 1, 1, r1]] == resmodel[[1, 1, r]]), pointerrisk[[s - 1, r]] = r1],
		{s, 2, hnrun}, {r, hnrd}, {r1, Length[resmodel[[2 s - 1, 1]]]}];

printbug["1.4"];

	(* FOR EACH RISK FACTOR IN BASELINE RUN POINTER TO RISK FACTOR IN OTHER RUNS *)

	pointerdis = Table[0, {hnrun - 1}, {hnd}];

	Do[If[(resmodel[[2 s - 1, 2, d1]] == resmodel[[1, 2, d]]), pointerdis[[s - 1, d]] = d1],
		{s, 2, hnrun}, {d, hnd}, {d1, Length[resmodel[[2 s - 1, 2]]]}];

printbug["1.5"];

	(* MODEL SELECTIONS *)

	hmodelsel = Select[Range[7] resmodel[[1, 7]], Positive];

printbug["1.6"];

	(* MID AGE CLASSES *)

	midage = initageclass[[1, Range[nac[[1]]]]] + .5 lengthageclass[[1, Range[nac[[1]]]]];

printbug["1.7"];

	(* GRAPHICAL CONSTANTS *)

	stdruncolor1	= Table[{RGBColor[1 - s / hnrun, 0, s / hnrun]}, {s, hnrun}];
	stdrunlegend1	= Table["run" <> ToString[s], {s, hnrun}];
	stdruncolor2	= Table[{RGBColor[1 - s / hnrun, 0, s / hnrun]}, {s, 0, hnrun}];
	stdrunlegend2	= Flatten[{"data", Table["run" <> ToString[s], {s, hnrun}]}];

printbug["1.8"];

	plotset1	= {	PlotRange	-> All,
				PlotJoined 	-> True,
				DisplayFunction	-> Identity,
				SymbolShape 	-> None,
				LegendPosition 	-> {.5, .0},
				LegendSize 	-> {.65, .5}};	

printbug["1.9"];

	(* AGE PER YEAR OF COHORT, POPULATION NUMBERS, AND RISK-FACTOR RELATED DISEASES *)

	agen	= Minc[resmodel[[1, 5]] + Range[hnstap] - 1, na1];
	hnpop	= Table[Plus@@resmodel[[2 s, hmodelsel[[m]], 1, scen, n, g]],
			{m, Length[hmodelsel]}, {scen, hnscen}, {s, hnrun}, {g, ng}, {n, hnstap}];

	hdisrisk = Table[0, {hnrd}];

printbug["1.10"];

	Do[If[(riskdispair[[d1, 1]] == resmodel[[1, 1, r]]) && (riskdispair[[d1, 2]] == resmodel[[1, 2, d]]), hdisrisk[[r]] = d],
		{r, hnrd}, {d, Length[resmodel[[1, 2]]]}, {d1, Length[riskdispair]}];
	
	];


(* --------------------------------------------------
	NOTEBOOK OPERATIONS
---------------------------------------------------*)

If[(analyse == 3),

printbug["2."];

	addcellnb[cell_] := Block[{}, cellnb = Flatten[{cellnb, cell}]];

	hnbout 	= NotebookCreate[];

	tekst	= "";

	applnumber = ToExpression[StringDrop[ToString[Global`application], 11]];

	If[(Global`riskfactor > 0), tekst = " for " <> risknames[[Global`riskfactor]]];

	If[(Global`disease > 0), tekst = " for " <> disnames[[Global`disease]]];

	tekst = tekst <> ", test " <> ToString[applnumber];

	cellnb = {headingprintnb["comparison of model runs" <> tekst]}

	];


(* --------------------------------------------------
	COMPARING RESULTS AT BASELINE
----------------------------------------------------*)

printbug["3."];

(* GENERIC PROCEDURES FOR DISEASE OUTPUT VARIABLES *)

printdis1[res_] := Block[{},

printbug["3.1"];

	Do[	Print[{"run", s}];

		Do[	Print[{"disease", disnames[[resmodel[[1, 2, d]]]]}];
			Print[MatrixForm[res[[s, d]]]],

			{d, Length[res[[s]]]}],

		{s, Length[res]}]

	];

printdis1nb[res_] := Block[{},

printbug["3.2"];

	Do[	addcellnb[headingprint2nb["run" <> ToString[s + 1]]];

		Do[	addcellnb[headingprint3nb["disease" <> disnames[[resmodel[[1, 2, d]]]]]];
			addcellnb[Cell[BoxData[ToBoxes[res[[s, d]] // MatrixForm]], "Subsection"]],

			{d, Length[res[[s]]]}],

		{s, Length[res]}]

	];

plotdis1[prev_] := Block[{},

printbug["3.3"];

	plot1 = Table[MultipleListPlot[
				Table[prev[[s, d, g]], {s, Length[prev]}],
				plotset1,
				PlotStyle 	-> stdruncolor1,
				PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
				AxesLabel	-> {"ageclass", ""},
				PlotLegend 	-> stdrunlegend1],
			{g, ng}, {d, hnd}];

	Do[	addcellnb[headingprint3nb[gennames[[g]]]];

		Do[addcellnb[Cell[GraphicsData["PostScript",
			DisplayString[GraphicsArray[Table[Show[plot1[[g, d]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
			"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]]],
			{di, 0, Floor[(hnd - 1) / 4]}],

		{g, ng}]

	];

makeresdis1[o_, scen_] := Block[{},

printbug["3.4"];

	prev = Table[0, {hnrun}, {hnd}, {ng}, {nac[[1]]}];

	Do[prev[[1, d]] = resmodel[[2, hmodelsel[[m]], o, scen, 1, d]], {d, hnd}];

	Do[prev[[s, d]] = If[(pointerdis[[s - 1, d]] > 0),
					resmodel[[2 s, hmodelsel[[m]], o, scen, 1, pointerdis[[s - 1, d]]]],
					prev[[1, d]]],
		{s, 2, hnrun}, {d, hnd}];

	If[(tabind == 1), 	printdis1nb[prev]];
	If[(graphind == 1),	plotdis1[prev]];

	];

If[(hnstap == 1) && (hnrun > 1) && (analyse == 3),

printbug["3.5"];

	Do[	tekst	= "Results at baseline, specified by ageclass, " <> modelnames[[hmodelsel[[m]]]];
		addcellnb[headingprint1nb[tekst]];

		(* TOTAL POPULATION NUMBERS *)
printbug["3.6"];
		pop	= Table[resmodel[[2 s, hmodelsel[[m]], 1, 1, scen]], {s, hnrun}];

		tekst	= "Total population numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];
	
		If[(tabind == 1),

 			Do[	addcellnb[headingprint3nb["run" <> ToString[s]]];
				addcellnb[Cell[BoxData[ToBoxes[pop[[s]] // MatrixForm]], "Subsection"]],

				{s, hnrun}]];

		If[(graphind == 1),	

			plot1 	= Table[MultipleListPlot[
						Table[pop[[s, g]], {s, hnrun}],
						plotset1,
						PlotStyle	-> stdruncolor1,
						PlotLabel	-> gennames[[g]],
						AxesLabel	-> {"ageclass", ""},
						PlotLegend 	-> stdrunlegend1],
					{g, ng}];

			addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
					"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]];
	
		(* RISK FACTOR CLASS PREVALENCE NUMBERS *)
printbug["3.7"];

		risk	= Table[0, {hnrun}, {r, hnrd}, {ng}, {hncr[[r]]}, {nac[[1]]}];	

		Do[risk[[1, r]] = resmodel[[2, hmodelsel[[m]], 2, scen, 1, r]], {r, hnrd}];

		Do[risk[[s, r]] = If[(pointerrisk[[s - 1, r]] > 0),
						resmodel[[2 s, hmodelsel[[m]], 2, scen, 1, pointerrisk[[s - 1, r]]]],
						risk[[1, r]]],
			{s, 2, hnrun}, {r, hnrd}];

		tekst	= "Risk factor class prevalence numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(tabind == 1),

			Do[	addcellnb[headingprint3nb["run" <> ToString[s]]];

				Do[	addcellnb[headingprint3nb["risk factor" <> risknames[[resmodel[[1, 1, r]]]] <> "gender" <>
						gennames[[g]]]];
					addcellnb[Cell[BoxData[ToBoxes[risk[[s, r, g]] // MatrixForm]], "Subsection"]],

					{r, Length[risk[[s]]]}, {g, ng}],

				{s, hnrun}]];

		If[(graphind == 1),	

			plot1 = Table[MultipleListPlot[
						Table[risk[[s, r, g, ri]], {s, hnrun}],
						plotset1,
						PlotStyle 	-> stdruncolor1,
						PlotLabel 	-> gennames[[g]] <> ToString[ri],
						AxesLabel	-> {"ageclass", ""},
						PlotLegend 	-> stdrunlegend1],
					{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

			Do[	addcellnb[headingprint3nb[risknames[[resmodel[[1, 1, r]]]] <> gennames[[g]]]];
			    	addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[
						Table[Show[plot1[[r, g, rj]]], {rj, 4 ri + 1, Min[{4 ri + 4, hncr[[r]]}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 ri + 4, hncr[[r]]}] - 4 ri) himagesize, figsize}]]],
				{r, hnrd}, {g, ng}, {ri, 0, Floor[(hncr[[r]] - 1) / 4]}]];

		(* DISEASE PREVALENCE NUMBERS *)
printbug["3.8"];
		tekst	= "Disease prevalence numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis1[4, scen];

		(* DISEASE INCIDENCE NUMBERS *)
printbug["3.9"];
		tekst	= "Disease incidence numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis1[5, scen];

		(* DISEASE-RELATED MORTALITY NUMBERS *)
printbug["3.10"];
		tekst	= "Mortality numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis1[6, scen];

		(* ALL CAUSE MORTALITY NUMBERS *)
printbug["3.11"];
		prev	= Table[resmodel[[2 s, hmodelsel[[m]], 6, scen, 1, Length[resmodel[[2 s, hmodelsel[[m]], 6, 1, 1]]]]], {s, hnrun}];

		If[(tabind == 1),	

			Do[	addcellnb[headingprint3nb["run" <> ToString[s]]];
				addcellnb[Cell[BoxData[ToBoxes[prev[[s]] // MatrixForm]], "Subsection"]],

				{s, hnrun}]];

		If[(graphind == 1),	

			plot1 	= Table[MultipleListPlot[
						Table[prev[[s, g]], {s, hnrun}],
						plotset1,
						PlotStyle 	-> stdruncolor1,
						PlotLabel 	-> gennames[[g]],
						AxesLabel	-> {"ageclass", ""},
						PlotLegend 	-> stdrunlegend1],
					{g, ng}];

			addcellnb[headingprint3nb["all cause"]];

			addcellnb[Cell[GraphicsData["PostScript",
						DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
						"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]],

		{m, Length[hmodelsel]}, {scen, hnscen}];

	Do[
		(* ADJUSTED DISEASE-RELATED EXCESS MORTALITY RATES *)
printbug["3.12"];
		excessmort = Table[0, {hnrun}, {hnd}, {ng}, {nac[[1]]}];

		Do[excessmort[[1, d, g]] = meanaggreg[resmodel[[2, 8, d, g]]], {d, hnd}, {g, ng}];

		Do[excessmort[[s, d]] = If[(pointerdis[[s - 1, d]] > 0),

							Table[meanaggreg[resmodel[[2 s, 8, pointerdis[[s - 1, d]], g]]], {g, ng}],
							excessmort[[1, d]]],
			{s, 2, hnrun}, {d, hnd}];

		tekst	= "Excess mortality rates";
		addcellnb[headingprint2nb[tekst]];

		If[(tabind == 1),	printdis1nb[excessmort]];
		If[(graphind == 1),	plotdis1[excessmort]],

		{m, Length[hmodelsel]}];

	];(* COMPARING RESULTS AT BASELINE *)


(* --------------------------------------------------
	COMPARING RESULTS OVER SIMULATION TIME, AGGREGATED OVER AGE
----------------------------------------------------*)

printbug["4."];

makeresdis2[o_, scen_] := Block[{},

printbug["4.1"];

	prev 	= Table[0, {hnrun}, {hnd}, {ng}, {hnstap}];

	Do[prev[[1, d, g, n]] = Plus@@resmodel[[2, hmodelsel[[m]], o, scen, n, d, g]], {d, hnd}, {g, ng}, {n, hnstap}];

	Do[prev[[s, d]] = If[(pointerdis[[s - 1, d]] > 0),
						Table[Plus@@resmodel[[2 s, hmodelsel[[m]], o, 1, n, pointerdis[[s - 1, d]], g]],
							{g, ng}, {n, hnstap}],
						prev[[1, d]]],
		{s, 2, hnrun}, {d, hnd}];

	If[(tabind == 1),	

		Do[	addcellnb[headingprint3nb["run" <> ToString[s]]];

			Do[	headingprint3nb["disease" <> disnames[[resmodel[[1, 2, d]]]]];
				addcellnb[Cell[BoxData[ToBoxes[prev[[s, d]] // MatrixForm]], "Subsection"]],

				{d, Length[prev[[s]]]}],

			{s, hnrun}]];

	If[(graphind == 1),	

		plot1 = Table[MultipleListPlot[
					Table[prev[[s, d, g]], {s, hnrun}],
					plotset1,
					PlotStyle 	-> stdruncolor1,
					PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
					AxesLabel	-> {"time", ""},
					PlotLegend 	-> stdrunlegend1],
				{g, ng}, {d, hnd}];

		Do[	addcellnb[headingprint3nb[gennames[[g]]]];

			Do[addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g, d]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]]],
				{di, 0, Floor[(Length[prev[[1]]] - 1) / 4]}],

			{g, ng}]];

	];

If[(hnstap > 1) && (hnrun > 1) && (analyse == 3),

printbug["4.2"];

	Do[	tekst	= "Results over time, aggregated over age, " <> modelnames[[hmodelsel[[m]]]];
		addcellnb[headingprint1nb[tekst]];

		(* TOTAL POPULATION NUMBERS *)
printbug["4.3"];
		pop	= Table[Plus@@resmodel[[2 s, hmodelsel[[m]], 1, scen, n, g]], {s, hnrun}, {g, ng}, {n, hnstap}];

		tekst	= "Total population numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(tabind == 1),	

			Do[	addcellnb[headingprint3nb["run" <> ToString[s]]];
				addcellnb[Cell[BoxData[ToBoxes[pop[[s]] // MatrixForm]], "Subsection"]],

				{s, hnrun}]];

		If[(graphind == 1),	

			plot1 	= Table[MultipleListPlot[
						Table[pop[[s, g]], {s, hnrun}],
						plotset1,
						PlotStyle 	-> stdruncolor1,
						PlotLabel 	-> gennames[[g]],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend1],
					{g, ng}];

			addcellnb[Cell[GraphicsData["PostScript",
						DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
						"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]];

		(* RISK FACTOR CLASS PREVALENCE NUMBERS *)
printbug["4.4"];
		risk	= Table[0, {hnrun}, {r, hnrd}, {ng}, {hncr[[r]]}, {hnstap}];

		Do[risk[[1, r, g, ri, n]] = Plus@@resmodel[[2, hmodelsel[[m]], 2, scen, n, r, g, ri]],
			{r, hnrd}, {g, ng}, {ri, hncr[[r]]}, {n, hnstap}];
	
		Do[risk[[s, r]] = If[(pointerrisk[[s - 1, r]] > 0),
							Table[Plus@@resmodel[[2 s, hmodelsel[[m]], 2, 1, n, pointerrisk[[s - 1, r]], g, ri]],
								{g, ng}, {ri, hncr[[r]]}, {n, hnstap}],
							risk[[1, r]]],
			{s, 2, hnrun}, {r, hnrd}];

		tekst	= "Risk factor class prevalence numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(tabind == 1),	

			Do[	addcellnb[headingprint3nb["run" <> ToString[s]]];
		
				Do[	headingprint3nb["risk factor" <> risknames[[resmodel[[1, 1, r]]]] <> "gender" <> gennames[[g]]];
					addcellnb[Cell[BoxData[ToBoxes[risk[[s, r, g]] // MatrixForm]], "Subsection"]],

					{r, Length[risk[[s]]]}, {g, ng}],

				{s, hnrun}]];

		If[(graphind == 1),	

			plot1 	= Table[MultipleListPlot[
						Table[risk[[s, r, g, ri]], {s, hnrun}],
						plotset1,
						PlotStyle 	-> stdruncolor1,
						PlotLabel 	-> risknames[[resmodel[[1, 1, r]]]] <> ToString[ri],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend1],
					{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

			Do[	addcellnb[headingprint3nb[risknames[[resmodel[[1, 1, r]]]] <> gennames[[g]]]];
			    	addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[
						Table[Show[plot1[[r, g, rj]]], {rj, 4 ri + 1, Min[{4 ri + 4, hncr[[r]]}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 ri + 4, hncr[[r]]}] - 4 ri) himagesize, figsize}]]],
				{r, hnrd}, {g, ng}, {ri, 0, Floor[(hncr[[r]] - 1) / 4]}]];

		(* DISEASE PREVALENCE NUMBERS *)
printbug["4.5"];
		tekst	= "Disease prevalence numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis2[4, scen];

		(* DISEASE INCIDENCE NUMBERS *)
printbug["4.6"];
		tekst	= "Disease incidence numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis2[5, scen];

		(* DISEASE-RELATED MORTALITY NUMBERS *)
printbug["4.7"];
		tekst	= "Mortality numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis2[6, scen];

		(* OTHER CAUSES AND ALL CAUSE MORTALITY NUMBERS *)
printbug["4.8"];
		prev	= Table[Plus@@resmodel[[2 s, hmodelsel[[m]], 6, scen, n, Length[resmodel[[2 s, hmodelsel[[m]], 6, 1, 1]]] - 2 + d, g]],
				{s, hnrun}, {d, 2}, {g, ng}, {n, hnstap}];

		hmortnames = {"other causes", "all cause"};

		If[(tabind == 1),

			Do[	addcellnb[headingprint3nb["run" <> ToString[s] <> hmortnames[[d]]]];
				addcellnb[Cell[BoxData[ToBoxes[prev[[s, d]] // MatrixForm]], "Subsection"]],

				{s, hnrun}, {d, 2}]];

		If[(graphind == 1),

			plot1 = Table[MultipleListPlot[
						Table[prev[[s, d, g]], {s, hnrun}],
						plotset1,
						PlotStyle 	-> stdruncolor1,
						PlotLabel 	-> hmortnames[[d]],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend1],
					{g, ng}, {d, 2}];

			Do[	addcellnb[headingprint3nb[gennames[[g]]]];
	
				addcellnb[Cell[GraphicsData["PostScript",
						DisplayString[GraphicsArray[Table[Show[plot1[[g, d]]], {d, 2}]]]],
						"Subsection", ImageSize -> Min[{2 himagesize, figsize}]]],
			
				{g, ng}]];

	(* LIFE EXPECTANCY NUMBERS *)
printbug["4.9"];
		pop = Table[Plus@@Flatten[resmodel[[2 s, hmodelsel[[m]], 1, scen, Range[hnstap], g]]] /
					(Plus@@resmodel[[2 s, hmodelsel[[m]], 1, scen, 1, g]] + eps),
				{s, hnrun}, {g, ng}];

		addcellnb[headingprint3nb["life expectancy"]];

		addcellnb[Cell[BoxData[ToBoxes[pop // MatrixForm]], "Subsection"]],

		{m, Length[hmodelsel]}, {scen, hnscen}];

	]; (* COMPARING RESULTS OVER SIMULATION TIME, AGGREGATED OVER AGE *)


(* --------------------------------------------------
	COMPARING RESULTS WITH DATA OVER SIMULATION TIME, AGGREGATED OVER AGE
----------------------------------------------------*)

printbug["5."];

makeresdis3[o_, disdat_, scen_] := Block[{},

printbug["5.1"];

	prev	= Table[0, {hnrun + 1}, {hnd}, {ng}, {hnstap}];

	Do[prev[[1, d, g, n]] = disdat[[resmodel[[1, 2, d]], g, Min[{resmodel[[1, 5]] + n - 1, na1}]]],
		{d, hnd}, {g, ng}, {n, hnstap}];

	Do[prev[[2, d, g, n]] = Plus@@resmodel[[2, hmodelsel[[m]], o, scen, n, d, g]] / hnpop[[m, scen, 1, g, n]],
		{d, hnd}, {g, ng}, {n, hnstap}];

	Do[prev[[s + 1, d]] = If[(pointerdis[[s - 1, d]] > 0),

					Table[Plus@@resmodel[[2 s, hmodelsel[[m]], o, scen, n, pointerdis[[s - 1, d]], g]],
						{g, ng}, {n, hnstap}] /
						hnpop[[m, scen, s]],
					prev[[1, d]]],
		{s, 2, hnrun}, {d, hnd}];

	If[(graphind == 1),

		plot1 	= Table[MultipleListPlot[
					Table[prev[[s, d, g]], {s, hnrun + 1}],
					plotset1,
					PlotStyle 	-> stdruncolor2,
					PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
					AxesLabel	-> {"time", ""},
					PlotLegend 	-> stdrunlegend2],
				{g, ng}, {d, hnd}];

		Do[	addcellnb[headingprint3nb[gennames[[g]]]];

			Do[addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g, d]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]]],
				{di, 0, Floor[(hnd - 1) / 4]}],

			{g, ng}]

		];

	]; 

If[(hnstap >= 1) && (hnrun >= 1) && (analyse == 3) && (resmodel[[1, 5]] == resmodel[[1, 6]]),

printbug["5.2"];

	Do[	tekst	= "Comparison with cohort data specified by year, " <> modelnames[[hmodelsel[[m]]]] <> ", age " <>
				ToString[resmodel[[1, 5]] - 1];
		addcellnb[headingprint1nb[tekst]];

		(* RISK FACTOR CLASS PREVALENCE RATES *)
printbug["5.3"];
		risk = Table[0, {hnrun + 1}, {r, hnrd}, {ng}, {hncr[[r]]}, {hnstap}];

printbug["5.3.1"];

		Do[risk[[1, r, g, ri]] = prisk1[[resmodel[[1, 1, r]], g, ri, agen]], {r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

printbug["5.3.2"];

		Do[	If[(hdisrisk[[r]] == 0),		

			Do[risk[[2, r, g, ri, n]] = Plus@@resmodel[[2, hmodelsel[[m]], 2, scen, n, r, g, ri]] / hnpop[[m, scen, 1, g, n]],
				{g, ng}, {ri, hncr[[r]]}, {n, hnstap}];

			Do[If[(pointerrisk[[s - 1, r]] > 0),
				risk[[s + 1, r]] =
					Table[Plus@@resmodel[[2 s, hmodelsel[[m]], 2, scen, n, pointerrisk[[s - 1, r]], g, ri]] /
						hnpop[[m, scen, s, g, n]],
						{g, ng}, {ri, hncr[[r]]}, {n, hnstap}],
					risk[[1, r]]],
				{s, 2, hnrun}],

			Do[risk[[2, r, g, ri, n]] = Plus@@resmodel[[2, hmodelsel[[m]], 2, scen, n, r, g, ri]] /
								Plus@@resmodel[[2, hmodelsel[[m]], 4, scen, n, hdisrisk[[r]], g]],
				{g, ng}, {ri, hncr[[r]]}, {n, hnstap}];

			Do[If[(pointerrisk[[s - 1, r]] > 0),
				risk[[s + 1, r]] =
					Table[Plus@@resmodel[[2 s, hmodelsel[[m]], 2, scen, n, pointerrisk[[s - 1, r]], g, ri]] /
						Plus@@resmodel[[2, hmodelsel[[m]], 4, scen, n, hdisrisk[[pointerrisk[[s - 1, r]]]], g]],
						{g, ng}, {ri, hncr[[r]]}, {n, hnstap}],
					risk[[1, r]]],
				{s, 2, hnrun}]],

			{r, hnrd}];

		tekst	= "Risk factor class prevalence rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(graphind == 1),

			plot1 	= Table[MultipleListPlot[
						Table[risk[[s, r, g, ri]], {s, hnrun + 1}],
						plotset1,
						PlotStyle 	-> stdruncolor2,
						PlotLabel 	-> risknames[[resmodel[[1, 1, r]]]] <> ToString[ri],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend2],
					{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];


			Do[	addcellnb[headingprint3nb[risknames[[resmodel[[1, 1, r]]]] <> gennames[[g]]]];
			    	addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[
						Table[Show[plot1[[r, g, rj]]], {rj, 4 ri + 1, Min[{4 ri + 4, hncr[[r]]}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 ri + 4, hncr[[r]]}] - 4 ri) himagesize, figsize}]]],
				{r, hnrd}, {g, ng}, {ri, 0, Floor[(hncr[[r]] - 1) / 4]}]];

		(* DISEASE PREVALENCE RATES *)
printbug["5.4"];
		tekst	= "Disease prevalence rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis3[4, pdis1, scen];

		(* DISEASE INCIDENCE RATES *)
printbug["5.5"];
		tekst	= "Disease incidence rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis3[5, inc1, scen];

		(* DISEASE-RELATED MORTALITY RATES *)
printbug["5.6"];
		tekst	= "Mortality rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(resmodel[[1, 3]] == 2), mortdat = causemort1];

		If[(resmodel[[1, 3]] == 1),

			hexcessmort = Min1[Max0[Table[Minc[
						excessmort1[[d, g]],
						(causemort1[[d, g]] -
							inc1[[d, g]] casefat1[[casefatind0[[d]], g]]) / (pdis1[[d, g]] + eps)],
						{d, nd0}, {g, ng}]]];

			mortdat = Table[pdis1[[d, g]] hexcessmort[[d, g]] +
					inc1[[d, g]] (casefat1[[casefatind0[[d]], g]] +
					(1 - casefat1[[casefatind0[[d]], g]]) .5 hexcessmort[[d, g]]),
					{d, nd0}, {g, ng}]

			];
 
		makeresdis3[6, mortdat, scen];

		(* ALL CAUSE MORTALITY RATES *)
printbug["5.7"];
		prev = Table[0, {hnrun + 1}, {ng}, {hnstap}];

		Do[prev[[1, g, n]] = morttot1[[g, Min[{resmodel[[1, 5]] + n - 1, na1}]]], {g, ng}, {n, hnstap}];

		Do[prev[[s + 1, g, n]] =
				Plus@@resmodel[[2 s, hmodelsel[[m]], 6, scen, n, Length[resmodel[[2 s, hmodelsel[[m]], 6, scen, 1]]], g]] /
					hnpop[[m, scen, s, g, n]],
				{s, hnrun}, {g, ng}, {n, hnstap}];

		If[(graphind == 1),

			plot1 = Table[MultipleListPlot[
						Table[prev[[s, g]], {s, hnrun + 1}],
						plotset1,
						PlotStyle 	-> stdruncolor2,
						PlotLabel 	-> gennames[[g]],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend2],
					{g, ng}];

			addcellnb[headingprint3nb["all cause"]];

			addcellnb[Cell[GraphicsData["PostScript",
						DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
						"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]],

		{m, Length[hmodelsel]}, {scen, hnscen}];

	]; (* COMPARING RESULTS OVER SIMULATION TIME, AGGREGATED OVER AGE *)


(* --------------------------------------------------
	COMPARING MODEL INPUT AND SUBSEQUENT PARAMETER VALUES
----------------------------------------------------*)

printbug["6."];

If[(hnstap == 1) && (hnrun == 1) && (analyse == 3),

	tekst	= "From input data to model parameter values";
	addcellnb[headingprint1nb[tekst]];

	(* RELATIVE RISKS FOR EACH RISK FACTOR AND DISEASE SELECTED IN BASELINE RUN *)

printbug["6.1"];

	RRA 	= Table[RRrisk0[[resmodel[[1, 1, r]], RRriskind0[[resmodel[[1, 1, r]], resmodel[[1, 2, d]] + 1]]]], {r, hnrd}, {d, hnd}];

printbug["6.1.1"];

	RRB 	= Table[meanaggreg[RRrisk1[[resmodel[[1, 1, r]], RRriskind0[[resmodel[[1, 1, r]], resmodel[[1, 2, d]] + 1]], g, ri]]],
			{r, hnrd}, {d, hnd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.1.2"];

	RRC 	= Table[meanaggreg[resmodel[[2, 10, r, RRriskind0[[resmodel[[1, 1, r]], resmodel[[1, 2, d]] + 1]], g, ri]]],
			{r, hnrd}, {d, hnd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.1.3"];

	RRABC	= Table[{RRA[[r, d, g, ri]], RRB[[r, d, g, ri]], RRC[[r, d, g, ri]]}, {r, hnrd}, {d, hnd}, {g, ng}, {ri, hncr[[r]]}];
				
printbug["6.1.4"];

	plot1 	= Table[MultipleListPlot[RRABC[[r, d, g, ri]],
				plotset1,
				PlotStyle 	-> Table[{RGBColor[s / 2, 0, 1 - s / 2]}, {s, 0, 2}],
				PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
				AxesLabel	-> {"ageclass", ""},
				PlotLegend 	-> {"data", "smooth", "adj"}],
			{r, hnrd}, {g, ng}, {d, hnd}, {ri, hncr[[r]]}];
	
	tekst	= "RR's empirical and adjusted";
	addcellnb[headingprint2nb[tekst]];

printbug["6.1.5"];

	Do[	tekst	= risknames[[resmodel[[1, 1, r]]]] <> " class " <> ToString[ri] <> " " <> gennames[[g]];
		addcellnb[headingprint3nb[tekst]];

printbug["6.1.6"];

		If[(tabind == 1),

			Do[	addcellnb[headingprint3nb[disnames[[resmodel[[1, 2, d]]]]]];
				addcellnb[Cell[BoxData[ToBoxes[roundoff[RRABC[[r, d, g, ri]], 100] // MatrixForm]], "Subsection"]],

				{d, hnd}]];
printbug["6.1.7"];

		If[(graphind == 1),

			addcellnb[Table[Cell[GraphicsData["PostScript", DisplayString[GraphicsArray[
					Table[Show[plot1[[r, g, d, ri]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]],
				{di, 0, Floor[(hnd - 1) / 4]}]]],

		{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

	(* RELATIVE RISKS FOR SMOKING IN CASE OF DURATION-DEPENDENT *)

printbug["6.2"];

	If[(RRsmokduurind == 1),	

		RRC 	= Table[meanaggreg[resmodel[[2, 10, 1, RRriskind0[[resmodel[[1, 1, 1]], resmodel[[1, 2, d]] + 1]], g, 3]]],
				{d, hnd}, {g, ng}];
printbug["6.2.1"];	

		age1	= 5 Range[nac[[1]]] - 2.5;

printbug["6.2.3"];

		duurval	= Range[nstopduur] - .5;

printbug["6.2.4"];

		meanstopduur = Table[meanaggreg[stopduur[[g, ri]]], {g, ng}, {ri, nstopduur}];

printbug["6.2.5"];		

		RRform	= Max1[Table[Plus@@((1 + (RRrisk0[[1, d, g, 2, a]] - 1) Exp[-logRRsmokduur[[d, g, 1]] *
						Exp[-logRRsmokduur[[d, g, 2]] Max0[age1[[a]] - 51]] duurval]) *
						meanstopduur[[g, Range[nstopduur], a]]) /
					(Plus@@meanstopduur[[g, Range[nstopduur], a]] + eps),
				{d, Length[logRRsmokduur]}, {g, ng}, {a, nac[[1]]}]];

printbug["6.2.6"];

		RRD	= Table[RRform[[RRriskind0[[resmodel[[1, 1, 1]], resmodel[[1, 2, d]] + 1]], g]], {d, hnd}, {g, ng}];

printbug["6.2.7"];

		RRCD	= Table[{RRC[[d, g]], RRD[[d, g]]}, {d, hnd}, {g, ng}];		

printbug["6.2.8"];

		plot1 	= Table[MultipleListPlot[
					RRCD[[d, g]],
					plotset1,
					PlotStyle 	-> Table[{RGBColor[s, 0, 1 - s]}, {s, 0, 1}],
					PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
					AxesLabel	-> {"ageclass", ""},
					PlotLegend 	-> {"age", "duration"}],
				{g, ng}, {d, hnd}];

printbug["6.2.9"];		

		tekst	= "smoking RR's empirical and adjusted";
		addcellnb[headingprint2nb[tekst]];
		
		Do[	tekst	= gennames[[g]];

			addcellnb[headingprint3nb[tekst]];

			If[(tabind == 1),

				Do[	addcellnb[headingprint3nb[disnames[[resmodel[[1, 2, d]]]]]];
					addcellnb[Cell[BoxData[ToBoxes[roundoff[RRCD[[d, g]], 100] // MatrixForm]], "Subsection"]],

					{d, hnd}]];

			If[(graphind == 1),

				addcellnb[Table[Cell[GraphicsData["PostScript", DisplayString[GraphicsArray[
						Table[Show[plot1[[g, d]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
						"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]],
					{di, 0, Floor[(hnd - 1) / 4]}]]],

			{g, ng}]

		];

	(* RELATIVE RISKS FOR ALL CAUSE MORTALITY *)

printbug["6.3"];

	tekst	= "all cause mortality RR's empirical and adjusted";
	addcellnb[headingprint2nb[tekst]];

printbug["6.3.1"];

	RRA	= Table[RRrisk0[[resmodel[[1, 1, r]], 2]], {r, hnrd}];

printbug["6.3.2"];

	RRB	= Table[meanaggreg[RRrisk1[[resmodel[[1, 1, r]], 2, g, ri]]], {r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.3.3"];

	RRC	= Table[meanaggreg[RRriskpresel[[resmodel[[1, 1, r]], 2, g, ri]]], {r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.3.4"];

	RRD	= Table[(resmodel[[2, hmodelsel[[m]], 9, 1, 1, r, g, ri]] /
						(resmodel[[2, hmodelsel[[m]], 2, 1, 1, r, g, ri]] + eps)) /
					((resmodel[[2, hmodelsel[[m]], 9, 1, 1, r, g, 1]] + eps) /
						(resmodel[[2, hmodelsel[[m]], 2, 1, 1, r, g, 1]] + eps)),
				{m, Length[hmodelsel]}, {r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.3.5"];

	RRABCD	= Table[Join[	{RRA[[r, g, ri]], RRB[[r, g, ri]], RRC[[r, g, ri]]},
					Table[RRD[[m, r, g, ri]], {m, Length[hmodelsel]}]],
			{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.3.6"];

	hn	= 2 + Length[hmodelsel];

printbug["6.3.7"];

	hname	= Join[	{"data", "smooth", "presel"}, Table["model " <> ToString[m], {m, Length[hmodelsel]}]];

printbug["6.3.8"];

	plot1	= Table[MultipleListPlot[
				RRABCD[[r, g, ri]],
				plotset1,
				PlotStyle 	-> Table[{RGBColor[s / hn, 0, 1 - s / hn]}, {s, 0, hn}],
				PlotLabel 	-> gennames[[g]] <> " class " <> ToString[ri],
				AxesLabel	-> {"ageclass", ""},
				PlotLegend 	-> hname],
			{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

printbug["6.3.9"];

	Do[	tekst	= risknames[[resmodel[[1, 1, r]]]];
		addcellnb[headingprint3nb[tekst]];

printbug["6.3.10"];

		If[(tabind == 1),

			Do[	addcellnb[headingprint3nb[gennames[[g]] <> " class " <> ToString[ri]]];
				addcellnb[Cell[BoxData[ToBoxes[roundoff[RRABCD[[r, g, ri]], 100] // MatrixForm]], "Subsection"]],

				{g, ng}, {ri, hncr[[r]]}]];

printbug["6.3.11"];

		If[(graphind == 1),

			Do[	addcellnb[Cell[GraphicsData["PostScript",
						DisplayString[GraphicsArray[Table[Show[plot1[[r, g, ri]]], {ri, hncr[[r]]}]]]],
						"Subsection", ImageSize -> Min[{hncr[[r]] himagesize, figsize}]]],
				{g, ng}]],

		{r, hnrd}];

	(* DISEASE-RELATED EXCESS MORTALITY RATES IN BASELINE RUN *)

printbug["6.4"];

	emA 	= excessmort0[[resmodel[[1, 2]]]];

	emB 	= Table[meanaggreg[excessmort1[[resmodel[[1, 2, d]], g]]], {d, hnd}, {g, ng}];

	emC 	= Table[meanaggreg[resmodel[[2, 8, d, g]]], {d, hnd}, {g, ng}];

	plot1 	= Table[MultipleListPlot[
				{emA[[d, g]], emB[[d, g]], emC[[d, g]]},
				plotset1,
				PlotStyle 	-> Table[{RGBColor[s / 2, 0, 1 - s / 2]}, {s, 0, 2}],
				PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
				AxesLabel	-> {"ageclass", ""},
				PlotRange 	-> All,
				PlotLegend 	-> {"data", "smoothed", "adjusted"}],
			{g, ng}, {d, hnd}];

	
	tekst	= "excess mortality rates";
	addcellnb[headingprint2nb[tekst]];

	Do[	addcellnb[headingprint3nb[gennames[[g]]]];

		If[(graphind == 1),

			addcellnb[Table[Cell[GraphicsData["PostScript",DisplayString[GraphicsArray[
				Table[Show[plot1[[g, d]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
				"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]],

				{di, 0, Floor[(hnd - 1) / 4]}]]], 

		{g, ng}];

	Do[	tekst	= "for " <> modelnames[[hmodelsel[[m]]]];
		addcellnb[headingprint2nb[tekst]];

		(* ALL CAUSE MORTALITY RATES *)

printbug["6.5"];

		morttotreal = resmodel[[2, hmodelsel[[m]], 6, 1, 1, Length[resmodel[[2, hmodelsel[[m]], 6, 1, 1]]]]] /
				(resmodel[[2, hmodelsel[[m]], 1, 1, 1]] + eps);

		plot1	= Table[MultipleListPlot[
					{morttot0[[g]], meanaggreg[morttot1[[g]]], morttotreal[[g]]},
					plotset1,
					PlotStyle 	-> Table[{RGBColor[s / 2, 0, 1 - s / 2]}, {s, 0, 2}],
					AxesLabel	-> {"ageclass", ""},
					PlotLabel 	-> gennames[[g]],
					PlotLegend 	-> {"data", "smoothed", "realised"}],
				{g, ng}];

		tekst	= "all cause mortality rates";
		addcellnb[headingprint2nb[tekst]];

		If[(graphind == 1),

			addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
					"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]],		

		{m, Length[hmodelsel]}];

	(* RELATIVE RISKS FOR EACH RISK PAIR OF DISEASES SELECTED IN BASELINE RUN *)

printbug["6.6"];

	RRA	= Table[RRdis0[[RRdisind[[disind[[d]], disind[[d1]]]]]], {d, hnd}, {d1, hnd}];

	RRB 	= Table[meanaggreg[RRdispresel[[RRdisind[[ disind[[d]], disind[[d1]]]], g]]], {d, hnd}, {d1, hnd}, {g, ng}];

	RRC 	= Table[meanaggreg[RRdisadj[[RRdisind[[ disind[[d]], disind[[d1]]]], g]]], {d, hnd}, {d1, hnd}, {g, ng}];

	RRD 	= Table[meanaggreg[RRdisprev[[d, d1, g]]], {d, hnd}, {d1, hnd}, {g, ng}];

	plot1	= Table[MultipleListPlot[
				{RRA[[d, d1, g]], RRB[[d, d1, g]], RRC[[d, d1, g]], RRD[[d, d1, g]]},
				plotset1,
				PlotStyle 	-> Table[{RGBColor[s / 3, 0, 1 - s / 3]}, {s, 0, 3}],
				AxesLabel	-> {"ageclass", ""},
				PlotLabel 	-> disnames[[disind[[d1]]]],
				PlotLegend 	-> {"data", "unadjusted", "adjusted", "prevalence"}],
				{g, ng}, {d, hnd}, {d1, hnd}];

	tekst	= "co-morbidity RR's";
	addcellnb[headingprint2nb[tekst]];

	If[(graphind == 1),

		Do[	addcellnb[headingprint3nb[gennames[[g]] <> disnames[[disind[[d]]]] <> " on"]];

			Do[addcellnb[Table[Cell[GraphicsData["PostScript",DisplayString[GraphicsArray[
				Table[Show[plot1[[g, d, d1]]], {d1, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
				"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]],

				{di, 0, Floor[(hnd - 1) / 4]}]]], 

		{g, ng}, {d, hnd}]]

	];


(* --------------------------------------------------
	COMPARING MODEL INPUT AND RESULTS OVER TIME FOR FIXED AGE CLASS
----------------------------------------------------*)

printbug["7."];

makeresdis4[o_, disdat_, scen_] := Block[{},

	prev = Table[0, {hnrun + 1}, {hnd}];

	Do[prev[[1, d]] = Table[(meanaggreg[disdat[[resmodel[[1, 2, d]], g]]])[[ageclssel]], {g, ng}, {hnstap}], {d, hnd}];

printbug["7.1"];

	Do[prev[[2, d]] = Table[resmodel[[2, hmodelsel[[m]], o, scen, Range[hnstap], d, g, ageclssel]] / (hnpop[[1, g]] + eps), {g, ng}],
				{d, hnd}];

printbug["7.2"];

	Do[prev[[s + 1, d]] = If[(pointerdis[[s - 1, d]] > 0),

					Table[resmodel[[2 s, hmodelsel[[m]], o, scen, Range[hnstap], pointerdis[[s - 1, d]], g, ageclssel]] /
						(hnpop[[s, g]] + eps),
						{g, ng}],
					prev[[1, d]]],

				{s, 2, hnrun}, {d, hnd}];

printbug["7.3"];

	If[(graphind == 1),

		plot1 	= Table[MultipleListPlot[
					Table[prev[[s, d, g]], {s, hnrun + 1}],
					plotset1,
					PlotStyle 	-> stdruncolor2,
					PlotLabel 	-> disnames[[resmodel[[1, 2, d]]]],
					AxesLabel	-> {"time", ""},
					PlotLegend 	-> stdrunlegend2],
				{g, ng}, {d, hnd}];

		Do[	addcellnb[headingprint3nb[gennames[[g]]]];

			Do[addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g, d]]], {d, 4 di + 1, Min[{4 di + 4, hnd}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 di + 4, hnd}] - 4 di) himagesize, figsize}]]],
				{di, 0, Floor[(hnd - 1) / 4]}],

			{g, ng}]

		]

	];

If[(hnstap > 1) && (hnrun >= 1) && (analyse == 3) && (resmodel[[1, 5]] == 1) && (resmodel[[1, 6]] == na1),

	Do[	hnpop = Table[resmodel[[2 s, hmodelsel[[m]], 1, scen, n, g, ageclssel]], {s, hnrun}, {g, ng}, {n, hnstap}];

printbug["7.4"];
	
		tekst	= "Comparison with cross-sectional data specified by year, " <> modelnames[[hmodelsel[[m]]]] <> ", ageclass "<>
				ToString[initageclass[[1, ageclssel]]] <> " - " <> ToString[initageclass[[1, ageclssel + 1]] - 1];
		addcellnb[headingprint1nb[tekst]];

		(* POPULATION NUMBERS *)

printbug["7.5"];
		
		pop		= Table[0, {hnrun + 1}];
		pop[[1]] 	= Table[npop1[[g, ageclssel]], {g, ng}, {hnstap}];
		pop[[1 + Range[hnrun]]] = hnpop;

		tekst	= "Population numbers" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(graphind == 1),

			plot1 	= Table[MultipleListPlot[
						Table[pop[[s, g]], {s, hnrun + 1}],
						plotset1,
						PlotStyle 	-> stdruncolor2,
						PlotLabel 	-> gennames[[g]],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend2],
					{g, ng}];

			addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
					"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]

			];

		(* RISK FACTOR CLASS PREVALENCE NUMBERS *)

printbug["7.5"]; 

		risk = Table[0, {hnrun + 1}, {r, hnrd}];

		Do[risk[[1, r]] = Table[(meanaggreg[prisk1[[resmodel[[1, 1, r]], g, ri]]])[[ageclssel]],
						{g, ng}, {ri, hncr[[r]]}, {hnstap}],
					{r, hnrd}];

		Do[	If[(hdisrisk[[r]] == 0),

			(* RISK FACTORS FOR TOTAL POPULATION *)

printbug["7.51"];

			risk[[2, r]] = Table[resmodel[[2, hmodelsel[[m]], 2, scen, n, r, g, ri, ageclssel]] / (hnpop[[1, g, n]] + eps),
						{g, ng}, {ri, hncr[[r]]}, {n, hnstap}];
printbug["7.52"];

			Do[risk[[s + 1, r]] = If[(pointerrisk[[s - 1, r]] > 0),

							Table[resmodel[[2 s, hmodelsel[[m]], 2, scen, n, r, g, ri, ageclssel]] /
								(hnpop[[s, g, n]] + eps),
								{g, ng}, {ri, hncr[[r]]}, {n, hnstap}],
							risk[[1, r]]],

						{s, 2, hnrun}],

			(* DISEASE-RELATED RISK FACTORS *)

printbug["7.53"];

			risk[[2, r]] = Table[resmodel[[2, hmodelsel[[m]], 2, scen, n, r, g, ri, ageclssel]] /
						(resmodel[[2, hmodelsel[[m]], 4, scen, n, hdisrisk[[r]], g, ageclssel]] + eps),
						{g, ng}, {ri, hncr[[r]]}, {n, hnstap}];

			Do[risk[[s + 1, r]] = Table[resmodel[[2, hmodelsel[[m]], 2, scen, n, r, g, ri, ageclssel]] /
							(resmodel[[2, hmodelsel[[m]], 4, scen, n, hdisrisk[[pointerrisk[[s - 1, r]]]], g,
								ageclssel]] + eps),
							{g, ng}, {ri, hncr[[r]]}, {n, hnstap}],
						{s, 2, hnrun}]],

			{r, hnrd}];

printbug["7.54"]; 

		tekst	= "Risk factor class prevalence rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		If[(graphind == 1),

			plot1 	= Table[MultipleListPlot[
						Table[risk[[s, r, g, ri]], {s, hnrun + 1}],
						plotset1,	
						PlotStyle 	-> stdruncolor2,
						PlotLabel 	-> risknames[[resmodel[[1, 1, r]]]] <> ToString[ri],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend2],
					{r, hnrd}, {g, ng}, {ri, hncr[[r]]}];

			Do[	addcellnb[headingprint3nb[risknames[[resmodel[[1, 1, r]]]] <> gennames[[g]]]];
			    	addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[
						Table[Show[plot1[[r, g, rj]]], {rj, 4 ri + 1, Min[{4 ri + 4, hncr[[r]]}]}]]]],
					"Subsection", ImageSize -> Min[{(Min[{4 ri + 4, hncr[[r]]}] - 4 ri) himagesize, figsize}]]],
				{r, hnrd}, {ri, 0, Floor[(hncr[[r]] - 1) / 4]}, {g, ng}]];

		(* DISEASE PREVALENCE NUMBERS *)

printbug["7.6"];

		tekst	= "Disease prevalence rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis4[4, pdis1, scen];

		(* DISEASE INCIDENCE NUMBERS *)

printbug["7.7"];

		tekst	= "Disease incidence rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		makeresdis4[5, inc1, scen];

		(* ALL CAUSE MORTALITY NUMBERS *)

printbug["7.7"];

		tekst	= "All cause mortality rates" <> ", scenario " <> ToString[scen];
		addcellnb[headingprint2nb[tekst]];

		mort		= Table[0, {hnrun + 1}];
		mort[[1]]	= Table[morttot0[[g, ageclssel]], {g, ng}, {hnstap}];
		Do[mort[[s + 1]] = Table[resmodel[[2 s, hmodelsel[[m]], 6, scen, Range[hnstap],
						Length[resmodel[[2 s, hmodelsel[[m]], 6, scen, 1]]], g, ageclssel]] / (hnpop[[s, g]] + eps),
						{g, ng}],
					{s, hnrun}];
		
		If[(graphind == 1),

			plot1 	= Table[MultipleListPlot[
						Table[mort[[s, g]], {s, hnrun + 1}],
						plotset1,
						PlotStyle 	-> stdruncolor2,
						PlotLabel 	-> gennames[[g]],
						AxesLabel	-> {"time", ""},
						PlotLegend 	-> stdrunlegend2],
					{g, ng}];

			addcellnb[Cell[GraphicsData["PostScript",
					DisplayString[GraphicsArray[Table[Show[plot1[[g]]], {g, ng}]]]],
					"Subsection", ImageSize -> Min[{ng himagesize, figsize}]]]

			],

		{m, Length[hmodelsel]}, {scen, hnscen}]

	]; (* END COMPARING MODEL INPUT AND RESULTS OVER TIME FOR FIXED AGE CLASS *)


If[(analyse == 3), NotebookWrite[hnbout, Flatten[cellnb]]];
	

(* --------------------------------------------------
		Write info to Logfile
----------------------------------------------------*)

(* PACKAGE VERSION *)

version = 3.1;

WriteString[logfile, 
		"\t" <> "Package: " <> StringReplace[Evaluate[Context[]], "`Private`"-> ", " ] 
		<> "version " <> ToString[version] <> "\n\n"];

End[]


Protect[Evaluate[Context[] <> "*"]]


EndPackage[]
